{{/* Lightweight, dependency-free carousel (no Flowbite), designed for exact pixel heights and centered overlays.
   Usage example:
   {{< carousel_lite id="foxglove" images="/media/a.jpg,/media/b.jpg" pxheight="520" mobilepxheight="640" mdpxheight="520" radius="lg" duration="500" >}}
*/}}

{{/* Corner radius mapping */}}
{{- $radius := lower (.Get "radius" | default "lg") -}}
{{- $radiusMap := dict
  "none"  "rounded-none"
  "sm"    "rounded-sm"
  "md"    "rounded-md"
  "lg"    "rounded-lg"
  "xl"    "rounded-xl"
  "2xl"   "rounded-2xl"
  "3xl"   "rounded-3xl"
  "full"  "rounded-full"
-}}
{{- $roundedClass := index $radiusMap $radius | default "rounded-lg" -}}

{{- $id        := .Get "id" | default (printf "lc-%s" (substr (md5 .Page.RelPermalink) 0 8)) -}}
{{- $pxheight  := .Get "pxheight" | default "" -}}
{{- $mobilepx  := .Get "mobilepxheight" | default "" -}}
{{- $mdpx      := .Get "mdpxheight"     | default "" -}}
{{- $lgpx      := .Get "lgpxheight"     | default "" -}}
{{- $duration  := .Get "duration" | default "500" -}}
{{- $loading   := lower (.Get "loading" | default "lazy") -}}
{{- $fetchpri  := cond (eq $loading "eager") "high" "low" -}}

{{/* Build list of image URLs */}}
{{- $imgs := slice -}}
{{- with .Get "images" -}}
  {{- range (split . ",") -}}
    {{- $src := trim . " " -}}
    {{- if $src -}}
      {{- $isAbs := or (hasPrefix $src "http://") (hasPrefix $src "https://") (hasPrefix $src "//") (hasPrefix $src "data:") -}}
      {{- $final := cond $isAbs $src ($src | relURL) -}}
      {{- $imgs = $imgs | append (dict "src" $final "alt" "") -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if and (eq (len $imgs) 0) .Page.Resources -}}
  {{- $match := .Get "match" | default "*" -}}
  {{- range .Page.Resources.Match $match -}}
    {{- $imgs = $imgs | append (dict "src" .RelPermalink "alt" .Title) -}}
  {{- end -}}
{{- end -}}

{{- if eq (len $imgs) 0 -}}
  <p class="text-sm text-red-600 dark:text-red-400">carousel_lite: no images found</p>
{{- else -}}
{{- /* Height rules:
      - mobile: mobilepxheight if set, else pxheight
      - md+:    mdpxheight if set, else pxheight (falls back to mobile)
   */ -}}
{{- $mobileOrPx := cond (ne (printf "%v" $mobilepx) "") $mobilepx $pxheight -}}
{{- $mdOrPx := "" -}}
{{- if ne (printf "%v" $mdpx) "" -}}
  {{- $mdOrPx = $mdpx -}}
{{- else if ne (printf "%v" $pxheight) "" -}}
  {{- $mdOrPx = $pxheight -}}
{{- else -}}
  {{- $mdOrPx = $mobileOrPx -}}
{{- end -}}
{{- /* Build a safe style attribute with CSS variables on the ROOT (wrapper) */ -}}
{{- $rootStyle := "" -}}
{{- $rootVars := slice -}}
{{- if ne (printf "%v" $mobileOrPx) "" -}}
  {{- $rootVars = $rootVars | append (printf "--lc-h-mobile:%vpx;" $mobileOrPx) -}}
{{- end -}}
{{- if ne (printf "%v" $mdOrPx) "" -}}
  {{- $rootVars = $rootVars | append (printf "--lc-h-md:%vpx;" $mdOrPx) -}}
{{- end -}}
{{- if gt (len $rootVars) 0 -}}
  {{- $rootStyle = (printf " style=\"%s\"" (delimit $rootVars "")) | safeHTMLAttr -}}
{{- end -}}

<div id="{{ $id }}" class="relative w-full not-prose my-0 [&+p]:mt-3" data-lite-carousel data-carousel-ver="lite-1"{{ $rootStyle }}>
  <div class="relative overflow-hidden {{ $roundedClass }}" data-carousel-viewport>
    {{- range $i, $img := $imgs -}}
      {{- $src := $img.src -}}
      {{- $alt := (cond (ne ($img.alt | default "") "") $img.alt (printf "Slide %d" (add $i 1))) -}}
      <div class="lite-slide" data-index="{{ $i }}" style="position:absolute;inset:0;transition:transform {{ $duration }}ms ease-in-out;will-change:transform;">
        <img src="{{ $src }}" alt="{{ $alt }}"
             loading="{{ $loading }}" decoding="async" fetchpriority="{{ $fetchpri }}"
             class="absolute inset-0 w-full h-full object-cover object-center">
      </div>
    {{- end -}}
    <div class="lite-dots" style="position:absolute;left:50%;transform:translateX(-50%);bottom:1.25rem;z-index:30;display:flex;gap:0.75rem;">
      {{- range $i, $_ := $imgs -}}
        <button type="button" class="lite-dot" aria-label="Slide {{ add $i 1 }}" {{ if eq $i 0 }}aria-current="true"{{ end }} data-go-to="{{ $i }}"></button>
      {{- end -}}
    </div>
  <button type="button" class="lite-prev" aria-label="Previous" style="position:absolute;top:50%;transform:translateY(-50%);left:0;z-index:30;display:flex;align-items:center;justify-content:center;padding:0 0.5rem;cursor:pointer;">
      <span class="inline-flex items-center justify-center w-10 h-10 rounded-full lite-nav-bg">
        <svg class="w-4 h-4 text-white" viewBox="0 0 6 10" fill="none" aria-hidden="true"><path d="M5 1 1 5l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="sr-only">Previous</span>
      </span>
    </button>
  <button type="button" class="lite-next" aria-label="Next" style="position:absolute;top:50%;transform:translateY(-50%);right:0;z-index:30;display:flex;align-items:center;justify-content:center;padding:0 0.5rem;cursor:pointer;">
      <span class="inline-flex items-center justify-center w-10 h-10 rounded-full lite-nav-bg">
        <svg class="w-4 h-4 text-white" viewBox="0 0 6 10" fill="none" aria-hidden="true"><path d="m1 9 4-4-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="sr-only">Next</span>
      </span>
    </button>
  </div>
</div>
{{- end -}}
