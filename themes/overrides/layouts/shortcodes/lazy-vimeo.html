{{/*
Lazy Vimeo embed with thumbnail image and play button.
Usage:
{{< lazy-vimeo id="VIDEO_ID" img="/path/to/thumbnail.jpg" alt="Thumbnail alt text" class="optional-extra-classes" muted="true" >}}
  (optional inner markdown/HTML for overlay content: headings, buttons, etc.)
{{< /lazy-vimeo >}}
*/}}
{{ $page := .Page }}
{{ $id := .Get "id" }}
{{ $img := .Get "img" }}
{{ $alt := .Get "alt" }}
{{ $class := .Get "class" }}
{{ $muted := .Get "muted" | default "true" }}
{{ $controls := .Get "controls" | default "true" }}
{{ $minh := .Get "minh" | default "" }}
{{ $inner := $page.RenderString (dict "markup" "goldmark" "renderShortcodes" true) .Inner }}
{{ $primary := site.Params.primaryColor | default "emerald" }}
{{ $brandHex := site.Params.brandHex }}
{{ $btnColorLight := printf "text-%s-600" $primary }}
{{ $btnColorDark  := printf "dark:text-%s-400" $primary }}
{{ $btnBgLight := printf "bg-%s-600 hover:bg-%s-700 focus:ring-%s-300" $primary $primary $primary }}
{{ $btnBgDark  := printf "dark:bg-%s-500 dark:hover:bg-%s-600" $primary $primary }}
{{/* Video overlay site-wide settings with shortcode overrides */}}
{{ $vo := site.Params.videoOverlay }}
{{ $caption := .Get "caption" }}
{{ if not $caption }}{{ with $vo }}{{ with .caption }}{{ $caption = . }}{{ end }}{{ end }}{{ end }}
{{ $variant := .Get "overlayVariant" }}
{{ if not $variant }}{{ with $vo }}{{ with .variant }}{{ $variant = . }}{{ end }}{{ end }}{{ end }}
{{ if not $variant }}{{ $variant = "ring" }}{{ end }}
{{ $spotlightClass := .Get "spotlightClass" }}
{{ if not $spotlightClass }}{{ with $vo }}{{ with .spotlightClass }}{{ $spotlightClass = . }}{{ end }}{{ end }}{{ end }}
{{ if not $spotlightClass }}{{ $spotlightClass = "ring-2 ring-white/75 shadow-[0_0_20px_rgba(255,255,255,0.35)]" }}{{ end }}
{{ $spotlightSize := .Get "spotlightSize" }}
{{ if not $spotlightSize }}{{ with $vo }}{{ with .spotlightSize }}{{ $spotlightSize = . }}{{ end }}{{ end }}{{ end }}
{{ if not $spotlightSize }}{{ $spotlightSize = "h-20 w-20 md:h-24 md:w-24" }}{{ end }}
{{ if not $id }}{{ errorf "lazy-vimeo shortcode: missing id param" }}{{ end }}
{{ if not $img }}{{ errorf "lazy-vimeo shortcode: missing img param" }}{{ end }}
<div class="section hero bleed">
  <style data-lazy-vimeo-css>
    [data-lazy-vimeo-wrapper]{position:relative;}
    /* Default nav height variable (mobile-first); tweak per theme if needed */
    [data-lazy-vimeo-wrapper]{--nav-h:56px; --nav-h-desktop:64px;}
    @media (min-width:641px){ [data-lazy-vimeo-wrapper]{--nav-h:64px;} }
    /* Force full-viewport width and align left edge to viewport */
    [data-lazy-vimeo-wrapper]{left:calc(50% - 50vw);width:100vw;max-width:100vw;}
    @supports (width: 100svw){
      [data-lazy-vimeo-wrapper]{left:calc(50% - 50svw);width:100svw;max-width:100svw;}
    }
    [data-lazy-vimeo-target]{position:relative!important;}
    [data-lazy-vimeo-target] picture,[data-lazy-vimeo-target] picture img{position:absolute!important;inset:0!important;width:100%!important;height:100%!important;object-fit:cover!important;}
    [data-lazy-vimeo-overlay]{position:absolute!important;inset:0!important;display:flex!important;flex-direction:column;align-items:center;justify-content:center;}
    /* Prevent navbar from overlapping hero text (let video tuck slightly under) */
    @media (max-width:640px){
      [data-lazy-vimeo-overlay]{padding-top:var(--nav-h);} /* keep headings below nav */
    }
    /* Responsive hero heights: use defaults only when no explicit minh provided */
    {{ if not $minh }}
    @media (max-width: 640px){
      [data-lazy-vimeo-target]{min-height:70vh !important;height:70vh !important}
    }
    @media (min-width: 641px) and (max-width: 1024px){
      [data-lazy-vimeo-target]{min-height:85vh !important;height:85vh !important}
    }
    {{ end }}
  </style>
  <div class="relative w-screen isolate group {{$class}}" data-lazy-vimeo-wrapper>
    <div class="relative w-full overflow-hidden" style="{{ if $minh }}min-height:{{$minh}};height:{{$minh}}{{ else }}min-height:100vh;min-height:100svh;height:100vh;height:100svh{{ end }}" data-lazy-vimeo-target>
      <picture>
        <img src="{{$img}}" alt="{{$alt}}" class="h-full w-full object-cover" loading="eager" fetchpriority="high" decoding="async" />
      </picture>
      <div class="absolute inset-0 bg-black/40 transition-opacity group-hover:bg-black/50"></div>
      <div class="absolute inset-0 z-10 flex flex-col items-center justify-center text-center px-4 gap-4" data-lazy-vimeo-overlay>
        <div class="mx-auto max-w-7xl px-8 w-full">
          <div class="prose prose-zinc max-w-none dark:prose-invert">
            {{ $inner }}
          </div>
        </div>
        <div class="mt-6 flex items-center justify-center">
          <div class="relative inline-flex items-center justify-center">
            {{ if ne (lower $variant) "none" }}
            <span aria-hidden="true" class="absolute pointer-events-none z-0 rounded-full {{$spotlightSize}} {{ if eq (lower $variant) "filled" }} bg-white/20 border border-white/50 shadow-[0_0_16px_rgba(255,255,255,0.25)] {{ else }} {{$spotlightClass}} {{ end }}"></span>
            {{ end }}
            {{ if $brandHex }}
            <button type="button" class="relative z-10 inline-flex items-center justify-center transition focus:outline-none focus:ring-4 p-0 bg-transparent" style="color: {{$brandHex}};" data-lazy-vimeo-play aria-label="Play video" title="Play video">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 68 48" class="h-12 w-20 drop-shadow" aria-hidden="true">
                <rect x="1" y="1" width="66" height="46" rx="12" fill="currentColor"/>
                <path d="M45 24 27 14v20l18-10z" fill="#fff"/>
              </svg>
            </button>
            {{ else }}
            <button type="button" class="relative z-10 inline-flex items-center justify-center rounded-full transition h-20 w-20 focus:outline-none focus:ring-4 {{$btnBgLight}} {{$btnBgDark}} {{$btnColorLight}} {{$btnColorDark}}" data-lazy-vimeo-play aria-label="Play video" title="Play video">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 68 48" class="h-12 w-20 drop-shadow" aria-hidden="true">
                <rect x="1" y="1" width="66" height="46" rx="12" fill="currentColor"/>
                <path d="M45 24 27 14v20l18-10z" fill="#fff"/>
              </svg>
            </button>
            {{ end }}
          </div>
        </div>
        {{ with $caption }}
        <div class="mt-2 text-white/95 text-sm md:text-base font-medium">{{ . }}</div>
        {{ end }}
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  var root=document.currentScript.previousElementSibling; // wrapper div
  if(!root) return;
  var btn=root.querySelector('[data-lazy-vimeo-play]');
  var target=root.querySelector('[data-lazy-vimeo-target]');
  if(!btn||!target) return;
  var videoId='{{$id}}';
  var shouldMute={{ if eq (lower $muted) "false" }}false{{ else }}true{{ end }};
  var showControls={{ if eq (lower $controls) "false" }}false{{ else }}true{{ end }};
  var player=null; // Vimeo player instance
  var iframe=null; // iframe element reference
  var control=null; // overlay control for tap-to-toggle
  var picture=null, overlay=null, shade=null; // hero elements
  var videoAR=16/9; // default aspect ratio; updated from Vimeo metadata
  function fitCover(iframe){
    try{
      var cw=target.clientWidth||window.innerWidth;
      var ch=target.clientHeight||window.innerHeight;
      var ar=videoAR>0?videoAR:(16/9);
      var desktop = (window.innerWidth||cw) >= 1024;
      // Compute a slight vertical offset to avoid the sticky navbar
      var navH = 0;
      try{
        var styles = getComputedStyle(root);
        var varVal = styles.getPropertyValue(desktop ? '--nav-h-desktop' : '--nav-h').trim();
        if(varVal){ navH = parseInt(varVal,10) || 0; }
      }catch(e){}
      // Desktop: size to container height to show more of frame; center vertically
      if(desktop){
        // Reserve a little space (~48px) for the control bar inside hero height
        var controlH = 48;
        // Slightly reduce height so the top edge sits below the navbar
        var topClearance = 32; // fine-tune as needed
        var usableH = Math.max(0, ch - controlH - topClearance);
        iframe.style.height = usableH + 'px';
        iframe.style.width  = Math.ceil(usableH * ar) + 'px';
        iframe.style.top = (Math.floor(ch/2) + Math.min(52, navH + 36)) + 'px';
        iframe.style.bottom = 'auto';
        // Center horizontally within hero
        iframe.style.left = '50%';
        iframe.style.right = 'auto';
        iframe.style.transform = 'translate(-50%, -50%)';
      } else {
        // Mobile/tablet: span full width and center
        iframe.style.width=cw+'px';
        iframe.style.height=(cw/ar)+'px';
        iframe.style.top=(Math.floor(ch/2) + Math.min(34, navH + 22)) + 'px';
        iframe.style.bottom='auto';
        iframe.style.left='50%';
        iframe.style.right='auto';
        iframe.style.transform='translate(-50%, -50%)';
      }
      iframe.style.position='absolute';
      iframe.style.maxWidth='none';
      iframe.style.display='block';
    }catch(e){}
  }
  function load(){
    if(target.getAttribute('data-loaded')) return;
    target.setAttribute('data-loaded','true');
    if(!iframe){ iframe=document.createElement('iframe'); }
    iframe.setAttribute('allowfullscreen','');
    iframe.setAttribute('allow','autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media; web-share');
    iframe.referrerPolicy='strict-origin-when-cross-origin';
    // Lazy load is fine because iframe is only created on click
    iframe.setAttribute('loading','lazy');
    iframe.setAttribute('title','Vimeo video player');
    iframe.className='';
    // Player params: inline playback, DNT, hide title/byline/portrait; controls toggle; honor muted preference
    var paramsArr=[
      // Do not rely on autoplay param; start via API after ready
      'autoplay=0',
      'muted='+(shouldMute?1:0),
      'app_id=58479',
      'playsinline=1',
      'dnt=1',
      'title=0','byline=0','portrait=0',
      'controls='+(showControls?1:0)
    ];
    var params=paramsArr.join('&');
    iframe.src='https://player.vimeo.com/video/'+videoId+'?'+params;
    iframe.setAttribute('frameborder','0');
    // Do NOT remove picture or overlay; just hide for replay support
    picture=picture||target.querySelector('picture');
    overlay=overlay||root.querySelector('[data-lazy-vimeo-overlay]');
    shade=shade||null;
    Array.prototype.forEach.call(target.children,function(ch){
      if(!shade && ch.className && ch.className.indexOf('bg-black/40')!==-1) shade=ch;
    });
    if(picture){ picture.style.transition='opacity .4s ease'; picture.style.opacity='0'; picture.style.pointerEvents='none'; picture.style.visibility='hidden'; }
    target.insertBefore(iframe, target.firstChild);
    if(overlay){
      overlay.style.transition='opacity .4s ease';
      overlay.style.opacity='0';
      setTimeout(function(){ overlay.style.pointerEvents='none'; overlay.style.visibility='hidden'; },450);
    }
    if(shade){
      shade.style.transition='opacity .4s ease';
      shade.style.opacity='0';
      setTimeout(function(){ shade.style.pointerEvents='none'; shade.style.visibility='hidden'; },450);
    }
    fitCover(iframe);
    window.addEventListener('resize', function(){ fitCover(iframe); });
    // Load Vimeo Player API if needed
    function ensureVimeoPlayerScript(cb){
      if(window.Vimeo && window.Vimeo.Player){ cb(); return; }
      var existing=document.querySelector('script[data-vimeo-player]');
      if(existing){ existing.addEventListener('load', function(){ cb(); }); return; }
      var s=document.createElement('script');
      s.src='https://player.vimeo.com/api/player.js';
      s.setAttribute('data-vimeo-player','true');
      s.async=true;
      s.onload=function(){ cb(); };
      document.head.appendChild(s);
    }
    // Create a transparent control layer only if native controls are hidden
    if(!showControls){
      if(!control){
        control=document.createElement('div');
        control.setAttribute('data-lazy-vimeo-control','');
        control.style.position='absolute';
        control.style.inset='0';
        control.style.zIndex='5';
        control.style.background='transparent';
        control.style.cursor='pointer';
        target.appendChild(control);
      } else {
        control.style.visibility='visible';
        control.style.pointerEvents='auto';
      }
    } else {
      if(control){ control.style.pointerEvents='none'; control.style.visibility='hidden'; }
    }
    ensureVimeoPlayerScript(function(){
      try{
        if(!player){ player=new window.Vimeo.Player(iframe); }
        // On initial load after user click: unmute if requested and play
        // Try immediate play on click to preserve gesture on iOS
        (function immediateStart(){
          var wantSound = !shouldMute;
          if(wantSound){
            player.setMuted(false).catch(function(){});
            player.setVolume(1).catch(function(){});
          } else {
            player.setMuted(true).catch(function(){});
            player.setVolume(0).catch(function(){});
          }
          var p = player.play();
          if(p && p.catch){
            p.catch(function(){
              // Fallback: load then play; if still blocked, start muted then unmute
              player.loadVideo(videoId).then(function(){ return player.play(); }).catch(function(){
                player.setMuted(true).catch(function(){});
                player.setVolume(0).catch(function(){});
                player.loadVideo(videoId).then(function(){ return player.play(); }).then(function(){
                  if(!shouldMute){ setTimeout(function(){ player.setMuted(false).catch(function(){}); player.setVolume(1).catch(function(){}); }, 400); }
                }).catch(function(){});
              });
            });
          }
        })();
        // Fetch aspect ratio soon after to refine sizing
        player.ready().then(function(){
          try{
            Promise.all([player.getVideoWidth(), player.getVideoHeight()]).then(function(vals){
              var w=vals && vals[0]||0; var h=vals && vals[1]||0;
              if(w>0 && h>0){ videoAR=w/h; fitCover(iframe); }
            }).catch(function(){});
          }catch(e){}
        }).catch(function(){});
        // Listen for error events that indicate blocked autoplay; retry muted
        try{
          player.on('error', function(){
            player.setMuted(true).catch(function(){});
            player.setVolume(0).catch(function(){});
            player.play().catch(function(){});
          });
        }catch(e){}
        // If controls are hidden, enable tap-to-toggle; otherwise don't block native UI
        if(!showControls){
          var toggling=false;
          function togglePlayback(){
            if(toggling) return; toggling=true;
            player.getPaused().then(function(paused){
              if(paused){ player.play(); } else { player.pause(); }
            }).catch(function(){ /* noop */ }).finally(function(){ toggling=false; });
          }
          control.addEventListener('click', function(e){ e.preventDefault(); togglePlayback(); });
          control.addEventListener('touchend', function(e){ e.preventDefault(); togglePlayback(); }, { passive:false });
        }
        // On ended: restore hero poster + overlay and show play button again
        player.on('ended', function(){
          try{
            // Pause and hide iframe
            player.pause().catch(function(){});
            iframe.style.transition='opacity .4s ease';
            iframe.style.opacity='0';
            setTimeout(function(){ iframe.style.pointerEvents='none'; iframe.style.visibility='hidden'; },450);
            // Show poster and overlay again
            if(picture){ picture.style.visibility='visible'; picture.style.pointerEvents='auto'; picture.style.opacity='1'; }
            if(shade){ shade.style.visibility='visible'; shade.style.pointerEvents='auto'; shade.style.opacity='1'; }
            if(overlay){ overlay.style.visibility='visible'; overlay.style.pointerEvents='auto'; overlay.style.opacity='1'; }
          }catch(e){}
        });
      }catch(e){}
    });
    // Optionally ping analytics
    if(window.gtag){
      try{ window.gtag('event','video_play',{event_category:'engagement',event_label:videoId,transport_type:'beacon'}); }catch(e){}
    }
  }
  function replayOrLoad(){
    // If we already have an iframe/player and it's hidden, show and play again
    if(iframe && iframe.style && (iframe.style.visibility==='hidden' || iframe.style.opacity==='0')){
      iframe.style.visibility='visible';
      iframe.style.pointerEvents='auto';
      iframe.style.opacity='1';
      if(player){ player.play().catch(function(){}); }
      if(picture){ picture.style.opacity='0'; picture.style.pointerEvents='none'; picture.style.visibility='hidden'; }
      if(overlay){ overlay.style.opacity='0'; overlay.style.pointerEvents='none'; overlay.style.visibility='hidden'; }
      if(shade){ shade.style.opacity='0'; shade.style.pointerEvents='none'; shade.style.visibility='hidden'; }
      return;
    }
    load();
  }
  btn.addEventListener('click', replayOrLoad);
  btn.addEventListener('keydown', function(e){
    if(e.key==='Enter' || e.key===' '){ e.preventDefault(); replayOrLoad(); }
  });
})();
</script>
