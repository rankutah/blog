{{- /* Section with optional hero & overlay + site defaults + spacer control.

  Site defaults (config.toml):
  [params.section.defaults]
    max   = "xl"     # sm|md|lg|xl|2xl|full
    pad   = "lg"     # none|sm|md|lg
    y     = "md"     # none|sm|md|lg|xl
    align = "start"  # start|center
    # alignY = "start|center|end|between"
    # minh   = "screen|full"

  Per-section:
    max, pad, y, yBottom, align, alignY, minh, classes
    img, alt, bleed, imgClasses, imgStyle, overlay, overlayShade, overlayClasses
    spacer="true|false"   ‚Üê controls post-hero spacer for bleed+overlay

*/ -}}

{{- $page   := .Page -}}
{{- $Inner  := .Inner -}}

{{/* ---------- Read site defaults ---------- */}}
{{- $defs := $page.Site.Params.section.defaults | default (dict) -}}
{{- $defMax   := (index $defs "max")   | default "xl" -}}
{{- $defPad   := (index $defs "pad")   | default "lg" -}}
{{- $defY     := (index $defs "y")     | default "md" -}}
{{- $defAlign := (index $defs "align") | default "start" -}}
{{- $defAlignY:= (index $defs "alignY")| default "" -}}
{{- $defMinh  := (index $defs "minh")  | default "" -}}

{{/* ---------- Shortcode params ---------- */}}
{{- $pageOverride := .Get "classes" | default "" -}}
{{- $siteOverride := $page.Site.Params.section.classes | default "" -}}

{{- $max     := .Get "max"     | default $defMax -}}
{{- $pad     := .Get "pad"     | default $defPad -}}
{{- $y       := .Get "y"       | default $defY -}}
{{- $yBottom := .Get "yBottom" | default "" -}}
{{- $align   := .Get "align"   | default $defAlign -}}

{{- $alignY  := .Get "alignY"  | default $defAlignY -}}
{{- $minh    := .Get "minh"    | default $defMinh -}}

{{/* ---------- Maps ---------- */}}
{{- $maxMap := dict "sm" "max-w-screen-sm" "md" "max-w-3xl" "lg" "max-w-5xl" "xl" "max-w-7xl" "2xl" "max-w-screen-2xl" "full" "max-w-none" -}}
{{- $padMap := dict "none" "px-0" "sm" "px-4" "md" "px-6" "lg" "px-8" -}}
{{- $alMap  := dict "start" "text-left" "center" "text-center" -}}

{{- $ptMap := dict "none" "pt-0" "sm" "pt-6" "md" "pt-12" "lg" "pt-16" "xl" "pt-24" -}}
{{- $pbMap := dict "none" "pb-0" "sm" "pb-6" "md" "pb-12" "lg" "pb-16" "xl" "pb-24" -}}

{{- $minhMap := dict "" "" "screen" "min-h-screen" "full" "min-h-full" -}}
{{- $alignYMap := dict "" "" "start" "justify-start" "center" "justify-center" "end" "justify-end" "between" "justify-between" -}}

{{/* ---------- Hero controls ---------- */}}
{{- $img        := .Get "img" | default "" -}}
{{- $alt        := .Get "alt" | default "" -}}
{{- $bleedStr   := .Get "bleed" | default "" -}}
{{- $bleed      := cond (ne $img "") (ne (lower $bleedStr) "false") false -}}
{{- $imgClasses := .Get "imgClasses" | default "block w-full h-64 md:h-80 lg:h-96 object-cover" -}}
{{- $imgStyle   := .Get "imgStyle"   | default "" -}}

{{- $overlay      := eq (lower (.Get "overlay" | default "false")) "true" -}}
{{- $overlayShade := .Get "overlayShade" | default "" -}}
{{- $overlayWrap  := .Get "overlayClasses" | default "absolute inset-0 flex items-center" -}}
{{- $overlayProse := "prose prose-zinc max-w-none dark:prose-invert" -}}
{{- $overlayAlign := (index $alMap $align | default "text-left") -}}

{{/* Spacer control (only relevant for bleed+overlay) */}}
{{- $spacerParam := lower (.Get "spacer" | default "true") -}}

{{/* ---------- Compute paddings ---------- */}}
{{- $pt := cond $bleed "pt-0" (index $ptMap $y | default "pt-12") -}}
{{- $pb := index $pbMap $y | default "pb-12" -}}
{{- if $yBottom }}{{- $pb = index $pbMap $yBottom | default $pb -}}{{- end -}}

{{/* ---------- Container class ---------- */}}
{{- $container := printf "%s mx-auto %s %s %s"
    (index $maxMap $max   | default "max-w-7xl")
    (index $padMap $pad   | default "px-8")
    $pt
    (index $alMap  $align | default "text-left")
-}}

{{/* Optional vertical centering wrapper */}}
{{- $vWrap := "" -}}
{{- if or (ne $alignY "") (ne $minh "") -}}
  {{- $vWrap = printf "flex flex-col w-full %s %s"
        (index $minhMap $minh | default "")
        (index $alignYMap $alignY | default "")
  -}}
{{- end -}}

{{- $base := printf "%s %s" $container $pb -}}
{{- $classes := cond (ne $pageOverride "") $pageOverride (cond (ne $siteOverride "") $siteOverride $base) -}}

<section>
  {{- if and $img $bleed -}}
    <!-- Full-bleed hero -->
    <div class="relative left-1/2 right-1/2 ml-[-50vw] mr-[-50vw] w-screen">
      <img src="{{ $img | safeURL }}" alt="{{ $alt }}" class="not-prose {{ $imgClasses }}"{{ if $imgStyle }} style="{{ $imgStyle }}"{{ end }}>
      {{- if $overlay -}}
        <div class="{{ $overlayWrap }}">
          {{- if $overlayShade }}<div class="absolute inset-0 {{ $overlayShade }}"></div>{{- end }}
          <div class="relative z-10 w-full {{ $container }}">
            <div class="{{ $vWrap }}">
              <div class="{{ $overlayProse }} {{ $overlayAlign }}">
                {{- $page.RenderString $Inner -}}
              </div>
            </div>
          </div>
        </div>
      {{- end }}
    </div>

    {{- /* Spacer only if bottom padding is non-zero AND not explicitly disabled */ -}}
    {{- $addSpacer := and (ne $pb "pb-0") (ne $spacerParam "false") -}}
    {{- if $addSpacer -}}
      <div class="{{ (printf "%s mx-auto %s" (index $maxMap $max | default "max-w-7xl") (index $padMap $pad | default "px-8")) }} {{ $pb }}"></div>
    {{- end }}

  {{- else if $img -}}
    <!-- In-container hero -->
    <div class="{{ $classes }}">
      <div class="relative">
        <img src="{{ $img | safeURL }}" alt="{{ $alt }}" class="not-prose block w-full {{ $imgClasses }}"{{ if $imgStyle }} style="{{ $imgStyle }}"{{ end }}>
        {{- if $overlay -}}
          <div class="{{ $overlayWrap }}">
            {{- if $overlayShade }}<div class="absolute inset-0 {{ $overlayShade }}"></div>{{- end }}
            <div class="relative z-10 w-full">
              <div class="{{ $vWrap }}">
                <div class="{{ $overlayProse }} {{ $overlayAlign }}">
                  {{ $page.RenderString $Inner }}
                </div>
              </div>
            </div>
          </div>
        {{- else -}}
          <div class="{{ $overlayProse }} {{ $overlayAlign }} mt-6">
            {{ $page.RenderString $Inner }}
          </div>
        {{- end }}
      </div>
    </div>

  {{- else -}}
    <!-- Regular section -->
    <div class="{{ $classes }}">
      {{- if $vWrap }}<div class="{{ $vWrap }}">{{ end -}}
        {{ $page.RenderString $Inner }}
      {{- if $vWrap }}</div>{{ end -}}
    </div>
  {{- end }}
</section>

{{- if hugo.IsServer -}}
<!-- debug: y={{$y}} yBottom={{$yBottom}} pb={{$pb}} spacer={{$spacerParam}} -->
{{- end -}}
