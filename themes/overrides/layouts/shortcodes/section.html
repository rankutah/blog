{{- /* Section with optional hero & overlay + site defaults + spacer control.
     Adds render mode:
       render="md|raw|auto" (default "md")
       - md   → render Markdown via Page.RenderString
       - raw  → output inner as-is (safeHTML), for nested shortcodes/components
       - auto → detect {{< or {{% → raw, else md
*/ -}}

{{- $page   := .Page -}}
{{- $Inner  := .Inner -}}

{{/* ---------- Read site defaults ---------- */}}
{{- $defs := $page.Site.Params.section.defaults | default (dict) -}}
{{- $defMax   := (index $defs "max")   | default "xl" -}}
{{- $defPad   := (index $defs "pad")   | default "lg" -}}
{{- $defY     := (index $defs "y")     | default "md" -}}
{{- $defAlign := (index $defs "align") | default "start" -}}
{{- $defAlignY:= (index $defs "alignY")| default "" -}}
{{- $defMinh  := (index $defs "minh")  | default "" -}}

{{/* ---------- Shortcode params ---------- */}}
{{- $pageOverride := .Get "classes" | default "" -}}
{{- $siteOverride := $page.Site.Params.section.classes | default "" -}}

{{- $max     := .Get "max"     | default $defMax -}}
{{- $pad     := .Get "pad"     | default $defPad -}}
{{- $y       := .Get "y"       | default $defY -}}
{{- $yBottom := .Get "yBottom" | default "" -}}
{{- $align   := .Get "align"   | default $defAlign -}}
{{- $alignY  := .Get "alignY"  | default $defAlignY -}}
{{- $minh    := .Get "minh"    | default $defMinh -}}

{{- $render  := lower (.Get "render" | default "md") -}} {{/* md | raw | auto */}}

{{/* ---------- Maps ---------- */}}
{{- $maxMap := dict "sm" "max-w-screen-sm" "md" "max-w-3xl" "lg" "max-w-5xl" "xl" "max-w-7xl" "2xl" "max-w-screen-2xl" "full" "max-w-none" -}}
{{- $padMap := dict "none" "px-0" "sm" "px-4" "md" "px-6" "lg" "px-8" -}}
{{- $alMap  := dict "start" "text-left" "center" "text-center" -}}

{{- $ptMap := dict "none" "pt-0" "sm" "pt-6" "md" "pt-12" "lg" "pt-16" "xl" "pt-24" -}}
{{- $pbMap := dict "none" "pb-0" "sm" "pb-6" "md" "pb-12" "lg" "pb-16" "xl" "pb-24" -}}

{{- $minhMap   := dict "" "" "screen" "min-h-screen" "full" "min-h-full" -}}
{{- $alignYMap := dict "" "" "start" "justify-start" "center" "justify-center" "end" "justify-end" "between" "justify-between" -}}

{{/* ---------- Hero controls ---------- */}}
{{- $img        := .Get "img" | default "" -}}
{{- $alt        := .Get "alt" | default "" -}}
{{- $bleedStr   := .Get "bleed" | default "" -}}
{{- $bleed      := cond (ne $img "") (ne (lower $bleedStr) "false") false -}}
{{- $imgClasses := .Get "imgClasses" | default "block w-full h-64 md:h-80 lg:h-96 object-cover" -}}
{{- $imgStyle   := .Get "imgStyle"   | default "" -}}

{{- $overlay      := eq (lower (.Get "overlay" | default "false")) "true" -}}
{{- $overlayShade := .Get "overlayShade" | default "" -}}
{{- $overlayWrap  := .Get "overlayClasses" | default "absolute inset-0 flex items-center" -}}
{{- $overlayProse := "prose prose-zinc max-w-none dark:prose-invert" -}}
{{- $overlayAlign := (index $alMap $align | default "text-left") -}}

{{/* Convenience: brighten flag -> apply a subtle white overlay unless overlayShade explicitly provided.
    Usage: brighten="sm|md|lg|true" → sm=10%, md=20% (default), lg=30% */}}
{{- $brightenParam := lower (.Get "brighten" | default "") -}}
{{- if and (ne $brightenParam "") (eq $overlayShade "") -}}
  {{- $overlay = true -}}
  {{- $level := cond (or (eq $brightenParam "true") (eq $brightenParam "md")) "20" (cond (eq $brightenParam "sm") "10" (cond (eq $brightenParam "lg") "30" "")) -}}
  {{- if ne $level "" -}}
    {{- $overlayShade = printf "bg-white/%s" $level -}}
  {{- else -}}
    {{- $overlayShade = "bg-white/20" -}}
  {{- end -}}
{{- end -}}

{{/* Spacer control (only relevant for bleed+overlay) */}}
{{- $spacerParam := lower (.Get "spacer" | default "true") -}}

{{/* ---------- Compute paddings ---------- */}}
{{- $pt := cond $bleed "pt-0" (index $ptMap $y | default "pt-12") -}}
{{- $pb := index $pbMap $y | default "pb-12" -}}
{{- if $yBottom }}{{- $pb = index $pbMap $yBottom | default $pb -}}{{- end -}}

{{/* ---------- Container class ---------- */}}
{{- $container := printf "%s mx-auto %s %s %s"
    (index $maxMap $max   | default "max-w-7xl")
    (index $padMap $pad   | default "px-8")
    $pt
    (index $alMap  $align | default "text-left")
-}}

{{/* Optional vertical centering wrapper */}}
{{- $vWrap := "" -}}
{{- if or (ne $alignY "") (ne $minh "") -}}
  {{- $vWrap = printf "flex flex-col w-full %s %s"
        (index $minhMap $minh | default "")
        (index $alignYMap $alignY | default "")
  -}}
{{- end -}}

{{- $base := printf "%s %s" $container $pb -}}
{{- $classes := cond (ne $pageOverride "") $pageOverride (cond (ne $siteOverride "") $siteOverride $base) -}}

{{/* ---------- Smart renderer ---------- */}}
{{- $innerRaw := $Inner -}}
{{- $hasShortcode := gt (len (findRE `{{[%<]` $innerRaw)) 0 -}}
{{- if eq $render "auto" -}}
  {{- $render = cond $hasShortcode "raw" "md" -}}
{{- end -}}
{{- $innerOut := "" -}}
{{- if eq $render "raw" -}}
  {{- $innerOut = $innerRaw | safeHTML -}}
{{- else -}}
  {{- $innerOut = $page.RenderString $innerRaw -}}
{{- end -}}

{{- $isHero := and (ne $img "") $bleed -}}
{{- $secClass := slice -}}
{{- $secClass = $secClass | append "section" -}}
{{- if $isHero }}{{ $secClass = $secClass | append "hero" }}{{ end -}}
{{- if $bleed }}{{ $secClass = $secClass | append "bleed" }}{{ end -}}
<section class="{{ delimit $secClass " " }}">
  {{- if and $img $bleed -}}
    <!-- Full-bleed hero -->
    <div class="relative left-1/2 right-1/2 ml-[-50vw] mr-[-50vw] w-screen">
      <img src="{{ $img | safeURL }}" alt="{{ $alt }}" class="not-prose {{ $imgClasses }}"{{ if $imgStyle }} style="{{ $imgStyle }}"{{ end }}>
      {{- if $overlay -}}
        <div class="{{ $overlayWrap }}">
          {{- if $overlayShade }}<div class="absolute inset-0 {{ $overlayShade }}"></div>{{- end }}
          <div class="relative z-10 w-full {{ $container }}">
            <div class="{{ $vWrap }}">
              <div class="{{ $overlayProse }} {{ $overlayAlign }}">
                {{- $innerOut -}}
              </div>
            </div>
          </div>
        </div>
      {{- end }}
    </div>

    {{- /* Spacer only if bottom padding is non-zero AND not explicitly disabled */ -}}
    {{- $addSpacer := and (ne $pb "pb-0") (ne $spacerParam "false") -}}
    {{- if $addSpacer -}}
      <div class="{{ (printf "%s mx-auto %s" (index $maxMap $max | default "max-w-7xl") (index $padMap $pad | default "px-8")) }} {{ $pb }}"></div>
    {{- end }}

  {{- else if $img -}}
    <!-- In-container hero -->
    <div class="{{ $classes }}">
      <div class="relative">
        <img src="{{ $img | safeURL }}" alt="{{ $alt }}" class="not-prose block w-full {{ $imgClasses }}"{{ if $imgStyle }} style="{{ $imgStyle }}"{{ end }}>
        {{- if $overlay -}}
          <div class="{{ $overlayWrap }}">
            {{- if $overlayShade }}<div class="absolute inset-0 {{ $overlayShade }}"></div>{{- end }}
            <div class="relative z-10 w-full">
              <div class="{{ $vWrap }}">
                <div class="{{ $overlayProse }} {{ $overlayAlign }}">
                  {{ $innerOut }}
                </div>
              </div>
            </div>
          </div>
        {{- else -}}
          <div class="{{ $overlayProse }} {{ $overlayAlign }} mt-6">
            {{ $innerOut }}
          </div>
        {{- end }}
      </div>
    </div>

  {{- else -}}
    <!-- Regular section -->
    <div class="{{ $classes }}">
      {{- if $vWrap }}<div class="{{ $vWrap }}">{{ end -}}
        {{ $innerOut }}
      {{- if $vWrap }}</div>{{ end -}}
    </div>
  {{- end }}
</section>

{{- if hugo.IsServer -}}
<!-- debug: render={{$render}} hasShortcode={{$hasShortcode}} -->
{{- end -}}
