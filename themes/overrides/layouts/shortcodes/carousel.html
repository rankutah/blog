{{/* Usage:
  {{< carousel id="hero" images="/img/1.jpg,/img/2.jpg,/img/3.jpg" height="h-64 md:h-[28rem]" interval="4000" >}}
  Or use page resources instead of images:
  {{< carousel id="hero" match="carousel/*" >}}
*/}}

{{/* Corner radius: none|sm|md|lg|xl|2xl|3xl|full (default lg) */}}
{{- $radius := lower (.Get "radius" | default "lg") -}}
{{- $radiusMap := dict
  "none"  "rounded-none"
  "sm"    "rounded-sm"
  "md"    "rounded-md"
  "lg"    "rounded-lg"
  "xl"    "rounded-xl"
  "2xl"   "rounded-2xl"
  "3xl"   "rounded-3xl"
  "full"  "rounded-full"
-}}
{{- $roundedClass := index $radiusMap $radius | default "rounded-lg" -}}


{{ $id       := .Get "id" | default (printf "carousel-%s" (substr (md5 .Page.RelPermalink) 0 8)) }}
{{ $height   := .Get "height"   | default "h-56 md:h-96" }}
{{ $interval := .Get "interval" | default "5000" }}
{{ $duration := .Get "duration" | default "500" }}

{{/* Build list of image URLs */}}
{{ $imgs := slice }}
{{ with .Get "images" }}
  {{ range (split . ",") }}
    {{ $src := trim . " " }}
    {{ if $src }}
      {{- $isAbs := or (hasPrefix $src "http://") (hasPrefix $src "https://") (hasPrefix $src "//") (hasPrefix $src "data:") -}}
      {{- $final := cond $isAbs $src ($src | relURL) -}}
      {{ $imgs = $imgs | append (dict "src" $final "alt" "") }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if and (eq (len $imgs) 0) .Page.Resources }}
  {{ $match := .Get "match" | default "*" }}
  {{ range .Page.Resources.Match $match }}
    {{ $imgs = $imgs | append (dict "src" .RelPermalink "alt" .Title) }}
  {{ end }}
{{ end }}

{{ if eq (len $imgs) 0 }}
  <p class="text-sm text-red-600 dark:text-red-400">carousel: no images found</p>
{{ else }}
<div id="{{ $id }}" class="relative w-full" data-carousel="slide" data-carousel-interval="{{ $interval }}">
<div class="relative {{ $height }} overflow-hidden {{ $roundedClass }}">
{{- range $i, $img := $imgs }}
  {{- $srcStr := $img.src -}}
  {{- $altTxt := (cond (ne ($img.alt | default "") "") $img.alt (printf "Slide %d" (add $i 1))) -}}
  {{- /* Build responsive picture only for local media or page resources; external URLs stay plain <img>. */ -}}
  {{- $isLocal := or (hasPrefix $srcStr "/media/") (hasPrefix $srcStr "media/") -}}
  {{- $srcset := slice -}}
  {{- $srcsetAvif := slice -}}
  {{- $avifStatic := "" -}}
  {{- $fallback := $srcStr -}}
  {{- if $isLocal -}}
    {{- $clean := replaceRE "^/" "" $srcStr -}}
    {{- $asset := resources.Get $clean -}}
    {{- if not $asset -}}
      {{- /* Try page resources (e.g., bundles) */ -}}
      {{- with $.Page.Resources.GetMatch (printf "**%s" (path.Base $clean)) -}}
        {{- $asset = . -}}
      {{- end -}}
    {{- end -}}
    {{- if and $asset (eq ($asset.MediaType.MainType | default "") "image") -}}
      {{- $sub := lower ($asset.MediaType.SubType | default "") -}}
      {{- $processable := in (slice "jpeg" "jpg" "png") $sub -}}
      {{- if $processable -}}
        {{- $widths := slice 720 1080 1440 1920 -}}
        {{- $last := "" -}}
        {{- range $w := $widths -}}
          {{- $r := $asset.Resize (printf "%dx" $w) -}}
          {{- $srcset = $srcset | append (printf "%s %dw" $r.RelPermalink $w) -}}
          {{- $last = $r.RelPermalink -}}
          {{- $ravif := $asset.Resize (printf "%dx avif" $w) -}}
          {{- if eq (lower ($ravif.MediaType.SubType | default "")) "avif" -}}
            {{- $srcsetAvif = $srcsetAvif | append (printf "%s %dw" $ravif.RelPermalink $w) -}}
          {{- end -}}
        {{- end -}}
        {{- if ne $last "" }}{{- $fallback = $last -}}{{- end -}}
      {{- else if eq $sub "avif" -}}
        {{- /* Source is already AVIF; provide AVIF source and keep AVIF as fallback */ -}}
        {{- $srcsetAvif = (slice (printf "%s 1920w" $asset.RelPermalink)) -}}
        {{- $fallback = $asset.RelPermalink -}}
      {{- end -}}

      {{- /* If we didn't manage to build an AVIF srcset (encoder unavailable, etc.), try a static AVIF sibling */ -}}
      {{- if eq (len $srcsetAvif) 0 -}}
        {{- /* Build candidate path for a sibling .avif under assets/media */ -}}
        {{- $base := replaceRE `\.(jpg|jpeg|png|webp)$` "" $clean -}}
        {{- with resources.Get (printf "%s.avif" $base) -}}
          {{- $avifStatic = .RelPermalink -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  <div class='absolute inset-0 transition-opacity duration-500 ease-in-out {{ if eq $i 0 }}opacity-100 pointer-events-auto{{ else }}opacity-0 pointer-events-none{{ end }}' style="transition-duration: {{ $duration }}ms" data-carousel-item{{ if eq $i 0 }}="active"{{ end }}>
    {{- if gt (len $srcsetAvif) 0 -}}
      <picture>
        <source type="image/avif" srcset="{{ delimit $srcsetAvif ", " }}" sizes="100vw">
        <img src='{{ $fallback }}'{{ if gt (len $srcset) 0 }} srcset='{{ delimit $srcset ", " }}' sizes='100vw'{{ end }} alt='{{ $altTxt }}' class="absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
      </picture>
    {{- else if ne $avifStatic "" -}}
      <picture>
        <source type="image/avif" srcset="{{ $avifStatic }}" sizes="100vw">
        <img src='{{ $fallback }}'{{ if gt (len $srcset) 0 }} srcset='{{ delimit $srcset ", " }}' sizes='100vw'{{ end }} alt='{{ $altTxt }}' class="absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
      </picture>
    {{- else -}}
      <img src='{{ $fallback }}' alt='{{ $altTxt }}' class="absolute block w-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2">
    {{- end -}}
  </div>
{{- end }}
</div>
<div class="absolute z-30 flex -translate-x-1/2 bottom-5 left-1/2 space-x-3 rtl:space-x-reverse">
{{- range $i, $_ := $imgs }}
<button type="button" class="w-3 h-3 rounded-full" aria-label="Slide {{ add $i 1 }}" {{ if eq $i 0 }}aria-current="true"{{ end }} data-carousel-slide-to="{{ $i }}"></button>
{{- end }}
</div>
<button type="button" class="absolute top-0 start-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none" data-carousel-prev>
<span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/30  group-hover:bg-white/50"><svg class="w-4 h-4 text-white dark:text-white rtl:rotate-180" viewBox="0 0 6 10" fill="none" aria-hidden="true"><path d="M5 1 1 5l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
<span class="sr-only">Previous</span>
</span>
</button>
<button type="button" class="absolute top-0 end-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none" data-carousel-next>
<span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/30  group-hover:bg-white/50"><svg class="w-4 h-4 text-white dark:text-white rtl:rotate-180" viewBox="0 0 6 10" fill="none" aria-hidden="true"><path d="m1 9 4-4-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
<span class="sr-only">Next</span></span>
</button>
</div>
{{ end }}
