{{/* Lightweight, dependency-free carousel (renamed from carousel_lite). */}}

{{/* Corner radius mapping */}}
{{- $radius := lower (.Get "radius" | default "lg") -}}
{{- $radiusMap := dict
  "none"  "rounded-none"
  "sm"    "rounded-sm"
  "md"    "rounded-md"
  "lg"    "rounded-lg"
  "xl"    "rounded-xl"
  "2xl"   "rounded-2xl"
  "3xl"   "rounded-3xl"
  "full"  "rounded-full"
-}}
{{- $roundedClass := index $radiusMap $radius | default "rounded-lg" -}}

{{- $id        := .Get "id" | default (printf "lc-%s" (substr (md5 .Page.RelPermalink) 0 8)) -}}
{{- $pxheight  := .Get "pxheight" | default "" -}}
{{- $mobilepx  := .Get "mobilepxheight" | default "" -}}
{{- $mdpx      := .Get "mdpxheight"     | default "" -}}
{{- $lgpx      := .Get "lgpxheight"     | default "" -}}
{{- $duration  := .Get "duration" | default "500" -}}
{{- $interval  := .Get "interval" | default "" -}}
{{- $loading   := lower (.Get "loading" | default "lazy") -}}
{{- $autostart := lower (.Get "autostart" | default "") -}} {{/* "load" | "interact" | "visible" (empty=theme default) */}}
{{- /* Allow overriding object-position for cropping focal point (e.g., "center", "top", "bottom", or "50% 40%") */ -}}
{{- $pos       := .Get "pos" | default (.Get "focus" | default "center") -}}
{{- /* If the carousel is above the fold, allow opting-in to eager LCP for the first slide */ -}}
{{- $priority  := .Get "priority" | default "" -}}
{{- $fetchpri  := cond (eq $loading "eager") "high" "low" -}}
{{- /* Responsive sizes hint: allow override; default assumes 2-col on md+, single-col on mobile */ -}}
{{- $sizes     := .Get "sizes" | default "(min-width:1280px) 40vw, (min-width:1024px) 45vw, (min-width:768px) 50vw, 100vw" -}}

{{/* Build list of image URLs */}}
{{- $imgs := slice -}}
{{- with .Get "images" -}}
  {{- range (split . ",") -}}
    {{- $src := trim . " " -}}
    {{- if $src -}}
      {{- $isAbs := or (hasPrefix $src "http://") (hasPrefix $src "https://") (hasPrefix $src "//") (hasPrefix $src "data:") -}}
      {{- $final := cond $isAbs $src ($src | relURL) -}}
      {{- $imgs = $imgs | append (dict "src" $final "alt" "") -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if and (eq (len $imgs) 0) .Page.Resources -}}
  {{- $match := .Get "match" | default "*" -}}
  {{- range .Page.Resources.Match $match -}}
    {{- $imgs = $imgs | append (dict "src" .RelPermalink "alt" .Title) -}}
  {{- end -}}
{{- end -}}

{{- if eq (len $imgs) 0 -}}
  <p class="text-sm text-red-600 dark:text-red-400">carousel: no images found</p>
{{- else -}}
{{- $hasResp := or (ne (printf "%v" $mobilepx) "") (or (ne (printf "%v" $mdpx) "") (ne (printf "%v" $lgpx) "")) -}}
{{- $mobileOrPx := cond (ne (printf "%v" $mobilepx) "") $mobilepx $pxheight -}}
{{- $mdOrPx := cond (ne (printf "%v" $mdpx) "") $mdpx $mobileOrPx -}}
{{- /* Build a safe style attribute with CSS variables on the ROOT (wrapper) */ -}}
{{- $rootStyle := "" -}}
{{- if or (ne (printf "%v" $mobileOrPx) "") (ne (printf "%v" $mdOrPx) "") -}}
  {{- $mob := cond (ne (printf "%v" $mobileOrPx) "") $mobileOrPx 640 -}}
  {{- $md  := cond (ne (printf "%v" $mdOrPx) "") $mdOrPx 520 -}}
  {{- $rootStyle = (printf " style=\"--lc-h-mobile:%vpx;--lc-h-md:%vpx;\"" $mob $md) | safeHTMLAttr -}}
{{- end -}}

<div id="{{ $id }}" class="relative w-full not-prose my-0 [&+p]:mt-3" data-lite-carousel data-carousel-ver="lite-1"{{ if ne (printf "%v" $interval) "" }} data-auto-interval="{{ $interval }}"{{ end }}{{ if ne (printf "%v" $autostart) "" }} data-auto-start="{{ $autostart }}"{{ end }}{{ if ne (printf "%v" $priority) "" }} data-priority="1"{{ end }}{{ $rootStyle }}>
  <div class="relative overflow-hidden {{ $roundedClass }}" data-carousel-viewport>
    {{- range $i, $img := $imgs -}}
      {{- $src := $img.src -}}
      {{- $alt := (cond (ne ($img.alt | default "") "") $img.alt (printf "Slide %d" (add $i 1))) -}}
      {{- $isFirst := eq $i 0 -}}
      {{- $slideLoading := cond (and $isFirst (ne (printf "%v" $priority) "")) "eager" $loading -}}
      <div class="lite-slide" data-index="{{ $i }}" {{ if not $isFirst }}hidden aria-hidden="true"{{ else }}aria-hidden="false"{{ end }} style="position:absolute;inset:0;transition:transform {{ $duration }}ms ease-in-out;will-change:transform;">
        {{- /* Always try manifest-based responsive rendering; partial will fallback to plain <img> when manifest key is missing */ -}}
        {{- partial "img.manifest" (dict
            "src" $src
            "alt" $alt
            "class" "absolute inset-0 w-full h-full"
            "object" "cover"
            "objectPosition" $pos
            "loading" $slideLoading
            "decoding" "async"
            "sizes" $sizes
          ) -}}
      </div>
    {{- end -}}
    <div class="lite-controls" style="position:absolute;inset:0;z-index:30;pointer-events:none;">
  <div class="lite-dots" style="position:absolute;left:0;right:0;display:flex;gap:0.75rem;justify-content:center;align-items:center;bottom:clamp(0.5rem,2.5vh,1.25rem);pointer-events:auto;">
        {{- range $i, $_ := $imgs -}}
          <button type="button" class="lite-dot" aria-label="Slide {{ add $i 1 }}" {{ if eq $i 0 }}aria-current="true"{{ end }} data-go-to="{{ $i }}"></button>
        {{- end -}}
      </div>
      <button type="button" class="lite-prev" aria-label="Previous" style="position:absolute;top:50%;transform:translateY(-50%);left:0;display:flex;align-items:center;justify-content:center;padding:0 0.5rem;cursor:pointer;pointer-events:auto;">
        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full lite-nav-bg">
          <svg class="w-4 h-4 text-white" viewBox="0 0 6 10" fill="none" aria-hidden="true"><path d="M5 1 1 5l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="sr-only">Previous</span>
        </span>
      </button>
      <button type="button" class="lite-next" aria-label="Next" style="position:absolute;top:50%;transform:translateY(-50%);right:0;display:flex;align-items:center;justify-content:center;padding:0 0.5rem;cursor:pointer;pointer-events:auto;">
        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full lite-nav-bg">
          <svg class="w-4 h-4 text-white" viewBox="0 0 6 10" fill="none" aria-hidden="true"><path d="m1 9 4-4-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="sr-only">Next</span>
        </span>
      </button>
    </div>
  </div>
</div>
{{- end -}}
