{{- /* layouts/shortcodes/color-picker.html */ -}}

{{/* Allowed palettes (no slate/zinc/stone) */}}
{{- $neutrals := slice "gray" "neutral" -}}
{{- $chromas  := slice "red" "orange" "amber" "yellow" "lime" "green" "emerald" "teal" "cyan" "sky" "blue" "indigo" "violet" "purple" "fuchsia" "pink" "rose" -}}
{{- $colors := $neutrals -}}
{{- range $chromas }}{{- $colors = $colors | append . }}{{- end -}}

{{/* Defaults from params with fallbacks */}}
{{- $brandDefault := lower (or .Page.Site.Params.primaryColor .Page.Site.Params.brandColor "blue") -}}
{{- $lightDefault := lower (or .Page.Site.Params.lightBackground "gray-50") -}}
{{- $darkDefault  := lower (or .Page.Site.Params.darkBackground  "neutral-900") -}}

<div class="not-prose p-3 rounded-lg border border-gray-200 dark:border-gray-700">
  <div class="grid gap-2 md:grid-cols-3 items-end">
    <!-- Primary brand -->
    <div>
      <label for="cp-primary" class="block mb-1 text-xs font-medium text-gray-900 dark:text-gray-100">Primary color</label>
      <select id="cp-primary" class="min-w-0 w-full text-xs h-9 rounded-md px-2 appearance-none
                                     bg-gray-50 text-gray-900 border border-gray-300
                                     dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600
                                     focus:outline-none focus:ring-1 focus:ring-gray-300 focus:border-gray-400
                                     dark:focus:ring-gray-700 dark:focus:border-gray-500">
        {{- range $neutrals }}
          <option value="{{ . }}" {{ if eq . $brandDefault }}selected{{ end }}>{{ . }}</option>
        {{- end }}
        <optgroup label="— Colors —"></optgroup>
        {{- range $chromas }}
          <option value="{{ . }}" {{ if eq . $brandDefault }}selected{{ end }}>{{ . }}</option>
        {{- end }}
      </select>
    </div>

    <!-- Light background -->
    <div>
      <label for="cp-light" class="block mb-1 text-xs font-medium text-gray-900 dark:text-gray-100">Background</label>
      <select id="cp-light" class="min-w-0 w-full text-xs h-9 rounded-md px-2 appearance-none
                                   bg-gray-50 text-gray-900 border border-gray-300
                                   dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600
                                   focus:outline-none focus:ring-1 focus:ring-gray-300 focus:border-gray-400
                                   dark:focus:ring-gray-700 dark:focus:border-gray-500">
        {{- range $colors }}
          {{- $c := . -}}
          {{- range (slice "50" "100" "200") }}
            {{- $val := printf "%s-%s" $c . -}}
            <option value="{{ $val }}" {{ if eq $val $lightDefault }}selected{{ end }}>{{ $val }}</option>
          {{- end }}
        {{- end }}
        <option value="white" {{ if eq "white" $lightDefault }}selected{{ end }}>white</option>
      </select>
    </div>

    <!-- Dark background -->
    <div>
      <label for="cp-dark" class="block mb-1 text-xs font-medium text-gray-900 dark:text-gray-100">Background</label>
      <select id="cp-dark" class="min-w-0 w-full text-xs h-9 rounded-md px-2 appearance-none
                                  bg-gray-50 text-gray-900 border border-gray-300
                                  dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600
                                  focus:outline-none focus:ring-1 focus:ring-gray-300 focus:border-gray-400
                                  dark:focus:ring-gray-700 dark:focus:border-gray-500">
        {{- /* Neutrals: 800/900/950 */ -}}
        {{- range $neutrals }}
          {{- $c := . -}}
          {{- range (slice "800" "900" "950") }}
            {{- $val := printf "%s-%s" $c . -}}
            <option value="{{ $val }}" {{ if eq $val $darkDefault }}selected{{ end }}>{{ $val }}</option>
          {{- end }}
        {{- end }}
        {{- /* Chromas: 950 only */ -}}
        {{- range $chromas }}
          {{- $val := printf "%s-950" . -}}
          <option value="{{ $val }}" {{ if eq $val $darkDefault }}selected{{ end }}>{{ $val }}</option>
        {{- end }}
      </select>
    </div>
  </div>
</div>

<!-- Manifest: keep every class we swap in the compiled CSS -->
<div aria-hidden="true" class="sr-only hidden
  bg-gray-50 bg-gray-100 bg-gray-200
  bg-neutral-50 bg-neutral-100 bg-neutral-200
  bg-red-50 bg-red-100 bg-red-200
  bg-orange-50 bg-orange-100 bg-orange-200
  bg-amber-50 bg-amber-100 bg-amber-200
  bg-yellow-50 bg-yellow-100 bg-yellow-200
  bg-lime-50 bg-lime-100 bg-lime-200
  bg-green-50 bg-green-100 bg-green-200
  bg-emerald-50 bg-emerald-100 bg-emerald-200
  bg-teal-50 bg-teal-100 bg-teal-200
  bg-cyan-50 bg-cyan-100 bg-cyan-200
  bg-sky-50 bg-sky-100 bg-sky-200
  bg-blue-50 bg-blue-100 bg-blue-200
  bg-indigo-50 bg-indigo-100 bg-indigo-200
  bg-violet-50 bg-violet-100 bg-violet-200
  bg-purple-50 bg-purple-100 bg-purple-200
  bg-fuchsia-50 bg-fuchsia-100 bg-fuchsia-200
  bg-pink-50 bg-pink-100 bg-pink-200
  bg-rose-50 bg-rose-100 bg-rose-200
  bg-white

  dark:bg-gray-800 dark:bg-gray-900 dark:bg-gray-950
  dark:bg-neutral-800 dark:bg-neutral-900 dark:bg-neutral-950
  dark:bg-red-950 dark:bg-orange-950 dark:bg-amber-950 dark:bg-yellow-950 dark:bg-lime-950
  dark:bg-green-950 dark:bg-emerald-950 dark:bg-teal-950 dark:bg-cyan-950 dark:bg-sky-950
  dark:bg-blue-950 dark:bg-indigo-950 dark:bg-violet-950 dark:bg-purple-950
  dark:bg-fuchsia-950 dark:bg-pink-950 dark:bg-rose-950

  bg-gray-700 hover:bg-gray-800 focus:ring-gray-300 dark:bg-gray-600 dark:hover:bg-gray-700 dark:focus:ring-gray-800
  bg-neutral-700 hover:bg-neutral-800 focus:ring-neutral-300 dark:bg-neutral-600 dark:hover:bg-neutral-700 dark:focus:ring-neutral-800
  bg-red-700 hover:bg-red-800 focus:ring-red-300 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800
  bg-orange-700 hover:bg-orange-800 focus:ring-orange-300 dark:bg-orange-600 dark:hover:bg-orange-700 dark:focus:ring-orange-800
  bg-amber-700 hover:bg-amber-800 focus:ring-amber-300 dark:bg-amber-600 dark:hover:bg-amber-700 dark:focus:ring-amber-800
  bg-yellow-700 hover:bg-yellow-800 focus:ring-yellow-300 dark:bg-yellow-600 dark:hover:bg-yellow-700 dark:focus:ring-yellow-800
  bg-lime-700 hover:bg-lime-800 focus:ring-lime-300 dark:bg-lime-600 dark:hover:bg-lime-700 dark:focus:ring-lime-800
  bg-green-700 hover:bg-green-800 focus:ring-green-300 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800
  bg-emerald-700 hover:bg-emerald-800 focus:ring-emerald-300 dark:bg-emerald-600 dark:hover:bg-emerald-700 dark:focus:ring-emerald-800
  bg-teal-700 hover:bg-teal-800 focus:ring-teal-300 dark:bg-teal-600 dark:hover:bg-teal-700 dark:focus:ring-teal-800
  bg-cyan-700 hover:bg-cyan-800 focus:ring-cyan-300 dark:bg-cyan-600 dark:hover:bg-cyan-700 dark:focus:ring-cyan-800
  bg-sky-700 hover:bg-sky-800 focus:ring-sky-300 dark:bg-sky-600 dark:hover:bg-sky-700 dark:focus:ring-sky-800
  bg-blue-700 hover:bg-blue-800 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800
  bg-indigo-700 hover:bg-indigo-800 focus:ring-indigo-300 dark:bg-indigo-600 dark:hover:bg-indigo-700 dark:focus:ring-indigo-800
  bg-violet-700 hover:bg-violet-800 focus:ring-violet-300 dark:bg-violet-600 dark:hover:bg-violet-700 dark:focus:ring-violet-800
  bg-purple-700 hover:bg-purple-800 focus:ring-purple-300 dark:bg-purple-600 dark:hover:bg-purple-700 dark:focus:ring-purple-800
  bg-fuchsia-700 hover:bg-fuchsia-800 focus:ring-fuchsia-300 dark:bg-fuchsia-600 dark:hover:bg-fuchsia-700 dark:focus:ring-fuchsia-800
  bg-pink-700 hover:bg-pink-800 focus:ring-pink-300 dark:bg-pink-600 dark:hover:bg-pink-700 dark:focus:ring-pink-800
  bg-rose-700 hover:bg-rose-800 focus:ring-rose-300 dark:bg-rose-600 dark:hover:bg-rose-700 dark:focus:ring-rose-800
"></div>

<script>
(() => {
  const html = document.documentElement;
  const nav  = document.querySelector('nav');

  // selects
  const brandSel = document.getElementById('cp-primary');
  const lightSel = document.getElementById('cp-light');
  const darkSel  = document.getElementById('cp-dark');

  // find label+select wrappers
  function findGroup(selectId) {
    const sel = document.getElementById(selectId);
    const lab = document.querySelector(`label[for="${selectId}"]`);
    if (!sel) return null;
    let n = sel;
    for (let i = 0; i < 4 && n; i++, n = n.parentElement) {
      if (n.querySelector && lab && n.contains(sel) && n.contains(lab)) return n;
    }
    return (lab && lab.parentElement) || sel.parentElement || null;
  }
  const lightGroup = findGroup('cp-light');
  const darkGroup  = findGroup('cp-dark');

  // background targets: body, nav, main, and any element with data-bg-sync
  const getBgEls = () => [document.body, nav, document.querySelector('main'), ...document.querySelectorAll('[data-bg-sync]')].filter(Boolean);

  // palettes
  const NEUTRALS = ["gray","neutral"];
  const CHROMAS  = ["red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose"];
  const COLORS   = [...NEUTRALS, ...CHROMAS];

  const uniq   = a => Array.from(new Set(a.filter(Boolean)));
  const remove = (el, list) => el && list.forEach(c => el.classList.remove(c));
  const add    = (el, list) => el && list.forEach(c => el.classList.add(c));

  // ----- Brand link coloring (inline style; no Tailwind vars/classes) -----
  const BRAND_HEX = {
    gray:    { light:"#4b5563", dark:"#6b7280" },
    neutral: { light:"#525252", dark:"#737373" },
    red:     { light:"#dc2626", dark:"#ef4444" },
    orange:  { light:"#ea580c", dark:"#f97316" },
    amber:   { light:"#d97706", dark:"#f59e0b" },
    yellow:  { light:"#ca8a04", dark:"#eab308" },
    lime:    { light:"#65a30d", dark:"#84cc16" },
    green:   { light:"#16a34a", dark:"#22c55e" },
    emerald: { light:"#059669", dark:"#10b981" },
    teal:    { light:"#0d9488", dark:"#14b8a6" },
    cyan:    { light:"#0891b2", dark:"#06b6d4" },
    sky:     { light:"#0284c7", dark:"#0ea5e9" },
    blue:    { light:"#2563eb", dark:"#3b82f6" },
    indigo:  { light:"#4f46e5", dark:"#6366f1" },
    violet:  { light:"#7c3aed", dark:"#8b5cf6" },
    purple:  { light:"#9333ea", dark:"#a855f7" },
    fuchsia: { light:"#c026d3", dark:"#d946ef" },
    pink:    { light:"#db2777", dark:"#ec4899" },
    rose:    { light:"#e11d48", dark:"#f43f5e" },
  };
  function recolorLinks() {
    const isDark = html.classList.contains('dark');
    const brand  = (brandSel && COLORS.includes(brandSel.value)) ? brandSel.value : "blue";
    const hex    = (BRAND_HEX[brand] || BRAND_HEX.blue)[isDark ? "dark" : "light"];
    document.querySelectorAll('a.link-brand').forEach(a => { a.style.color = hex; });
  }

  // brand tint (buttons)
  const BRAND_SELECTOR = window.CP_BRAND_SELECTOR || '.ui-btn, .btn, .btn-primary, [data-ui-btn], [data-brand="primary"]';
  const BTN = sel => [
    `bg-${sel}-700`,`hover:bg-${sel}-800`,`focus:ring-${sel}-300`,
    `dark:bg-${sel}-600`,`dark:hover:bg-${sel}-700`,`dark:focus:ring-${sel}-800`,
  ];
  const ALL_BTN = uniq([].concat(...COLORS.map(BTN)));
  function applyBrand(color){
    const addList = BTN(color) || [];
    document.querySelectorAll(BRAND_SELECTOR).forEach(el => { remove(el, ALL_BTN); add(el, addList); });
    recolorLinks(); // update link colors too
  }

  // bg class sets (for body/nav/main/opt-in elements)
  const LIGHT_BG_ALL = uniq([
    ...COLORS.flatMap(c => [`bg-${c}-50`,`bg-${c}-100`,`bg-${c}-200`]),
    'bg-white'
  ]);
  const DARK_BG_ALL = uniq([
    ...NEUTRALS.flatMap(c => [`dark:bg-${c}-800`,`dark:bg-${c}-900`,`dark:bg-${c}-950`]),
    ...CHROMAS.map(c => `dark:bg-${c}-950`),
  ]);

  // PLAIN dark tokens used ONLY on <html> (since .dark is on <html> itself)
  const HTML_DARK_BG_ALL = uniq([
    ...NEUTRALS.flatMap(c => [`bg-${c}-800`,`bg-${c}-900`,`bg-${c}-950`]),
    ...CHROMAS.map(c => `bg-${c}-950`)
  ]);

  function repaint() {
    const isDark = html.classList.contains('dark');
    const targets = getBgEls();
    const root = document.documentElement;

    // clear old on normal targets
    targets.forEach(el => { remove(el, LIGHT_BG_ALL); remove(el, DARK_BG_ALL); });

    // clear old on <html>: light tokens + any plain dark tokens
    remove(root, LIGHT_BG_ALL);
    remove(root, HTML_DARK_BG_ALL);

    // LIGHT mode: apply chosen light token everywhere (including <html>)
    if (!isDark && lightSel?.value) {
      const L = [`bg-${lightSel.value}`];
      targets.forEach(el => add(el, L));
      add(root, L);
    }

    // DARK mode:
    // - add 'dark:bg-*' to normal targets (as before)
    // - add a plain 'bg-*' to <html> so page edges/overscroll match
    if (darkSel?.value) {
      const d = darkSel.value; // e.g., "neutral-900" or "rose-950"
      targets.forEach(el => add(el, [`dark:bg-${d}`]));
      if (isDark) add(root, [`bg-${d}`]);
    }
  }

  function syncPickerVisibility() {
    const isDark = html.classList.contains('dark');
    const lg = lightGroup, dg = darkGroup;
    if (lg) { lg.classList.toggle('hidden', isDark); lightSel?.toggleAttribute('disabled', isDark); }
    if (dg) { dg.classList.toggle('hidden', !isDark); darkSel?.toggleAttribute('disabled', !isDark); }
  }

  // react ONLY when the dark-mode flag changes on <html>
  let lastDark = html.classList.contains('dark');
  new MutationObserver(muts => {
    for (const m of muts) {
      if (m.attributeName === 'class' && m.target === html) {
        const nowDark = html.classList.contains('dark');
        if (nowDark !== lastDark) {
          lastDark = nowDark;
          syncPickerVisibility();
          repaint();
          recolorLinks();
        }
      }
    }
  }).observe(html, { attributes: true });

  // events
  brandSel ?.addEventListener('change', () => applyBrand(brandSel.value));
  lightSel ?.addEventListener('change', () => { if (!html.classList.contains('dark')) repaint(); });
  darkSel  ?.addEventListener('change', () => { if ( html.classList.contains('dark')) repaint(); });

  // init
  syncPickerVisibility();
  if (brandSel) applyBrand(brandSel.value);
  repaint();
  recolorLinks();
})();
</script>

