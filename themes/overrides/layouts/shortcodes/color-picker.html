{{- /* layouts/shortcodes/color-picker.html

Usage:
  {{< color-picker >}}

What it does:
  - Lets you pick Primary, Light background, Dark background.
  - Retints ONLY elements with the .ui-btn class (opt-in).
  - Swaps <body> bg classes for light/dark backgrounds.
  - Keeps <nav> in sync so sticky bg follows on scroll.
  - In dark mode, light-bg choices do nothing.

*/ -}}

{{/* Allowed palettes
   - Neutrals: ONLY gray, neutral (no slate/zinc/stone)
   - Chromas: full set
*/}}
{{- $neutrals := slice "gray" "neutral" -}}
{{- $chromas  := slice "red" "orange" "amber" "yellow" "lime" "green" "emerald" "teal" "cyan" "sky" "blue" "indigo" "violet" "purple" "fuchsia" "pink" "rose" -}}
{{- $colors := $neutrals -}}
{{- range $chromas }}{{- $colors = $colors | append . }}{{- end -}}

{{- $brandDefault := lower (or .Page.Site.Params.primaryColor .Page.Site.Params.brandColor "blue") -}}
{{- $lightDefault := lower (or .Page.Site.Params.lightBackground "gray-50") -}}
{{- $darkDefault  := lower (or .Page.Site.Params.darkBackground  "neutral-900") -}}

<div class="not-prose p-4 rounded-lg border border-gray-200 dark:border-gray-700">
  <div class="grid gap-4 md:grid-cols-3">
    <!-- Primary brand -->
    <div>
      <label for="cp-primary" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-100">Primary color</label>
      <select id="cp-primary" class="w-full text-sm rounded-lg p-2.5 bg-gray-50 border border-gray-300 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100">
        {{- range $neutrals }}
          <option value="{{ . }}" {{ if eq . $brandDefault }}selected{{ end }}>{{ . }}</option>
        {{- end }}
        <optgroup label="— Colors —"></optgroup>
        {{- range $chromas }}
          <option value="{{ . }}" {{ if eq . $brandDefault }}selected{{ end }}>{{ . }}</option>
        {{- end }}
      </select>
    </div>

    <!-- Light background -->
    <div>
      <label for="cp-light" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-100">Light background</label>
      <select id="cp-light" class="w-full text-sm rounded-lg p-2.5 bg-gray-50 border border-gray-300 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100">
        {{- range $colors }}
          {{- $c := . -}}
          {{- range (slice "50" "100" "200") }}
            {{- $val := printf "%s-%s" $c . -}}
            <option value="{{ $val }}" {{ if eq $val $lightDefault }}selected{{ end }}>{{ $val }}</option>
          {{- end }}
        {{- end }}
      </select>
    </div>

    <!-- Dark background -->
    <div>
      <label for="cp-dark" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-100">Dark background</label>
      <select id="cp-dark" class="w-full text-sm rounded-lg p-2.5 bg-gray-50 border border-gray-300 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100">
        {{- /* Neutrals keep 800/900/950 */ -}}
        {{- range $neutrals }}
          {{- $c := . -}}
          {{- range (slice "800" "900" "950") }}
            {{- $val := printf "%s-%s" $c . -}}
            <option value="{{ $val }}" {{ if eq $val $darkDefault }}selected{{ end }}>{{ $val }}</option>
          {{- end }}
        {{- end }}
        <optgroup label="— Colors (950 only) —"></optgroup>
        {{- /* Chromas: 950 only (no 900) */ -}}
        {{- range $chromas }}
          {{- $val := printf "%s-950" . -}}
          <option value="{{ $val }}" {{ if eq $val $darkDefault }}selected{{ end }}>{{ $val }}</option>
        {{- end }}
      </select>
    </div>
  </div>
</div>

<!-- Tailwind safelist (keep any class we may toggle at runtime) -->
<div aria-hidden="true" class="sr-only hidden
{{- /* Button color sets */ -}}
{{- range $colors -}}{{- $c := . -}}
 bg-{{$c}}-700 hover:bg-{{$c}}-800 focus:ring-{{$c}}-300
 dark:bg-{{$c}}-600 dark:hover:bg-{{$c}}-700 dark:focus:ring-{{$c}}-800
{{- end -}}

{{- /* Light background palette */ -}}
{{- range $colors -}}{{- $c := . -}}
 bg-{{$c}}-50 bg-{{$c}}-100 bg-{{$c}}-200
{{- end -}}

{{- /* Dark background palette
      - neutrals: 800/900/950
      - chromas: 950 only
*/ -}}
{{- range $neutrals -}}{{- $c := . -}}
 dark:bg-{{$c}}-800 dark:bg-{{$c}}-900 dark:bg-{{$c}}-950
{{- end -}}
{{- range $chromas -}}{{- $c := . -}}
 dark:bg-{{$c}}-950
{{- end -}}
"></div>

<script>
(() => {
  // Only gray + neutral as neutrals
  const NEUTRALS = ["gray","neutral"];
  const CHROMAS  = ["red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose"];
  const COLORS   = [...NEUTRALS, ...CHROMAS];

  const brandSel = document.getElementById('cp-primary');
  const lightSel = document.getElementById('cp-light');
  const darkSel  = document.getElementById('cp-dark');

  const uniq = arr => Array.from(new Set(arr.filter(Boolean)));
  const remove = (el, list) => list.forEach(c => el.classList.remove(c));
  const add    = (el, list) => list.forEach(c => el.classList.add(c));
  const swap   = (el, rem, add_) => { remove(el, rem); add(el, add_); };

  // Grab the real navbar so its background travels with sticky positioning
  const NAV = document.querySelector('nav');

  // Button color maps per color
  function btnSet(c){
    return [
      `bg-${c}-700`,`hover:bg-${c}-800`,`focus:ring-${c}-300`,
      `dark:bg-${c}-600`,`dark:hover:bg-${c}-700`,`dark:focus:ring-${c}-800`,
    ];
  }
  const BTN_BY_COLOR = Object.fromEntries(COLORS.map(c => [c, btnSet(c)]));
  const ALL_BTN_CLASSES = uniq([].concat(...Object.values(BTN_BY_COLOR)));

  // Background palettes on <body> (and synced onto <nav>)
  const LIGHT_BG_ALL = uniq([].concat(...COLORS.map(c => [`bg-${c}-50`,`bg-${c}-100`,`bg-${c}-200`])));
  // Dark: neutrals 800/900/950; chromas 950 only
  const DARK_BG_NEUTRALS = uniq([].concat(...NEUTRALS.map(c => [`dark:bg-${c}-800`,`dark:bg-${c}-900`,`dark:bg-${c}-950`])));
  const DARK_BG_CHROMAS  = uniq(CHROMAS.map(c => `dark:bg-${c}-950`));
  const DARK_BG_ALL = uniq([...DARK_BG_NEUTRALS, ...DARK_BG_CHROMAS]);

  function applyBrand(color){
    const addList = BTN_BY_COLOR[color] || [];
    document.querySelectorAll('.ui-btn').forEach(el => swap(el, ALL_BTN_CLASSES, addList));
  }

  // Light background: no effect in dark mode; also keep NAV in sync so sticky bg doesn't get "left behind"
  function applyLightBg(token){
    const isDark = document.documentElement.classList.contains('dark');
    // Always remove any lingering light classes
    remove(document.body, LIGHT_BG_ALL);
    if (NAV) remove(NAV, LIGHT_BG_ALL);

    if (isDark) {
      // In dark mode, ignore light bg choices entirely
      return;
    }
    const addList = token ? [`bg-${token}`] : [];
    add(document.body, addList);
    if (NAV) add(NAV, addList);
  }

  // Dark background: neutrals (800/900/950), chromas (950 only)
  function applyDarkBg(token){
    const addList = token ? [`dark:bg-${token}`] : [];
    swap(document.body, DARK_BG_ALL, addList);
    if (NAV) swap(NAV, DARK_BG_ALL, addList);
  }

  // Initial paint
  if (brandSel) applyBrand(brandSel.value);
  if (lightSel) applyLightBg(lightSel.value);
  if (darkSel)  applyDarkBg(darkSel.value);

  // Events
  brandSel?.addEventListener('change', e => applyBrand(e.target.value));
  lightSel?.addEventListener('change', e => applyLightBg(e.target.value));
  darkSel?.addEventListener('change',  e => applyDarkBg(e.target.value));
})();
</script>
