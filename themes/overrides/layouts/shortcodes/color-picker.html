{{- /* layouts/shortcodes/color-picker.html */ -}}

{{/* Allowed palettes (no slate/zinc/stone) */}}
{{- $neutrals := slice "gray" "neutral" -}}
{{- $chromas  := slice "red" "orange" "amber" "yellow" "lime" "green" "emerald" "teal" "cyan" "sky" "blue" "indigo" "violet" "purple" "fuchsia" "pink" "rose" -}}
{{- $colors := $neutrals -}}
{{- range $chromas }}{{- $colors = $colors | append . }}{{- end -}}

{{/* Defaults from params with fallbacks */}}
{{- $brandDefault := lower (or .Page.Site.Params.primaryColor "blue") -}}
{{- $lightDefault := lower (or .Page.Site.Params.lightBackground "gray-50") -}}
{{- $darkDefault  := lower (or .Page.Site.Params.darkBackground  "neutral-900") -}}

<div class="not-prose p-3 rounded-lg border border-gray-200 dark:border-gray-700">
  <div class="grid gap-2 md:grid-cols-3 items-end">
    <!-- Light background -->
    <div>
      <label for="cp-light" class="block mb-1 text-xs font-medium text-gray-900 dark:text-gray-100">Background color</label>
      <select id="cp-light" class="min-w-0 w-full text-xs h-9 rounded-md px-2 appearance-none
                                   bg-gray-50 text-gray-900 border border-gray-300
                                   dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600
                                   focus:outline-none focus:ring-1 focus:ring-gray-300 focus:border-gray-400
                                   dark:focus:ring-gray-700 dark:focus:border-gray-500">
        {{- range $colors }}
          {{- $c := . -}}
          {{- range (slice "50" "100" "200") }}
            {{- $val := printf "%s-%s" $c . -}}
            <option value="{{ $val }}" {{ if eq $val $lightDefault }}selected{{ end }}>{{ $val }}</option>
          {{- end }}
        {{- end }}
        <option value="white" {{ if eq "white" $lightDefault }}selected{{ end }}>white</option>
      </select>
    </div>

    <!-- Dark background -->
    <div>
      <label for="cp-dark" class="block mb-1 text-xs font-medium text-gray-900 dark:text-gray-100">Background color</label>
      <select id="cp-dark" class="min-w-0 w-full text-xs h-9 rounded-md px-2 appearance-none
                                  bg-gray-50 text-gray-900 border border-gray-300
                                  dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600
                                  focus:outline-none focus:ring-1 focus:ring-gray-300 focus:border-gray-400
                                  dark:focus:ring-gray-700 dark:focus:border-gray-500">
        {{- /* Neutrals: 800/900/950 */ -}}
        {{- range $neutrals }}
          {{- $c := . -}}
          {{- range (slice "800" "900" "950") }}
            {{- $val := printf "%s-%s" $c . -}}
            <option value="{{ $val }}" {{ if eq $val $darkDefault }}selected{{ end }}>{{ $val }}</option>
          {{- end }}
        {{- end }}
        {{- /* Chromas: 950 only */ -}}
        {{- range $chromas }}
          {{- $val := printf "%s-950" . -}}
          <option value="{{ $val }}" {{ if eq $val $darkDefault }}selected{{ end }}>{{ $val }}</option>
        {{- end }}
      </select>
    </div>

    <!-- Buttons and Links brand -->
    <div>
      <label for="cp-primary" class="block mb-1 text-xs font-medium text-gray-900 dark:text-gray-100">Buttons and Links</label>
      <select id="cp-primary" class="min-w-0 w-full text-xs h-9 rounded-md px-2 appearance-none
                                     bg-gray-50 text-gray-900 border border-gray-300
                                     dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600
                                     focus:outline-none focus:ring-1 focus:ring-gray-300 focus:border-gray-400
                                     dark:focus:ring-gray-700 dark:focus:border-gray-500">
        {{- range $neutrals }}
          <option value="{{ . }}" {{ if eq . $brandDefault }}selected{{ end }}>{{ . }}</option>
        {{- end }}
        <optgroup label="— Colors —"></optgroup>
        {{- range $chromas }}
          <option value="{{ . }}" {{ if eq . $brandDefault }}selected{{ end }}>{{ . }}</option>
        {{- end }}
      </select>
    </div>
  </div>

  <!-- Examples (use the same brand/link selectors the picker updates) -->
  <div class="mt-2 flex flex-wrap items-center gap-4">
    <button type="button" class="ui-btn text-white font-medium rounded-lg text-sm px-4 py-2 focus:ring-4 focus:outline-none transition-colors">
      Example Button
    </button>
    <a href="#" class="link-brand font-medium underline-offset-2 hover:underline">Example Link</a>
  </div>
</div>

<!-- Manifest: keep every class we swap in the compiled CSS -->
<div aria-hidden="true" class="sr-only hidden
  bg-gray-50 bg-gray-100 bg-gray-200
  bg-neutral-50 bg-neutral-100 bg-neutral-200
  bg-red-50 bg-red-100 bg-red-200
  bg-orange-50 bg-orange-100 bg-orange-200
  bg-amber-50 bg-amber-100 bg-amber-200
  bg-yellow-50 bg-yellow-100 bg-yellow-200
  bg-lime-50 bg-lime-100 bg-lime-200
  bg-green-50 bg-green-100 bg-green-200
  bg-emerald-50 bg-emerald-100 bg-emerald-200
  bg-teal-50 bg-teal-100 bg-teal-200
  bg-cyan-50 bg-cyan-100 bg-cyan-200
  bg-sky-50 bg-sky-100 bg-sky-200
  bg-blue-50 bg-blue-100 bg-blue-200
  bg-indigo-50 bg-indigo-100 bg-indigo-200
  bg-violet-50 bg-violet-100 bg-violet-200
  bg-purple-50 bg-purple-100 bg-purple-200
  bg-fuchsia-50 bg-fuchsia-100 bg-fuchsia-200
  bg-pink-50 bg-pink-100 bg-pink-200
  bg-rose-50 bg-rose-100 bg-rose-200
  bg-white

  dark:bg-gray-800 dark:bg-gray-900 dark:bg-gray-950
  dark:bg-neutral-800 dark:bg-neutral-900 dark:bg-neutral-950
  dark:bg-red-950 dark:bg-orange-950 dark:bg-amber-950 dark:bg-yellow-950 dark:bg-lime-950
  dark:bg-green-950 dark:bg-emerald-950 dark:bg-teal-950 dark:bg-cyan-950 dark:bg-sky-950
  dark:bg-blue-950 dark:bg-indigo-950 dark:bg-violet-950 dark:bg-purple-950
  dark:bg-fuchsia-950 dark:bg-pink-950 dark:bg-rose-950

  bg-gray-700 hover:bg-gray-800 focus:ring-gray-300 dark:bg-gray-600 dark:hover:bg-gray-700 dark:focus:ring-gray-800
  bg-neutral-700 hover:bg-neutral-800 focus:ring-neutral-300 dark:bg-neutral-600 dark:hover:bg-neutral-700 dark:focus:ring-neutral-800
  bg-red-700 hover:bg-red-800 focus:ring-red-300 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800
  bg-orange-700 hover:bg-orange-800 focus:ring-orange-300 dark:bg-orange-600 dark:hover:bg-orange-700 dark:focus:ring-orange-800
  bg-amber-700 hover:bg-amber-800 focus:ring-amber-300 dark:bg-amber-600 dark:hover:bg-amber-700 dark:focus:ring-amber-800
  bg-yellow-700 hover:bg-yellow-800 focus:ring-yellow-300 dark:bg-yellow-600 dark:hover:bg-yellow-700 dark:focus:ring-yellow-800
  bg-lime-700 hover:bg-lime-800 focus:ring-lime-300 dark:bg-lime-600 dark:hover:bg-lime-700 dark:focus:ring-lime-800
  bg-green-700 hover:bg-green-800 focus:ring-green-300 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800
  bg-emerald-700 hover:bg-emerald-800 focus:ring-emerald-300 dark:bg-emerald-600 dark:hover:bg-emerald-700 dark:focus:ring-emerald-800
  bg-teal-700 hover:bg-teal-800 focus:ring-teal-300 dark:bg-teal-600 dark:hover:bg-teal-700 dark:focus:ring-teal-800
  bg-cyan-700 hover:bg-cyan-800 focus:ring-cyan-300 dark:bg-cyan-600 dark:hover:bg-cyan-700 dark:focus:ring-cyan-800
  bg-sky-700 hover:bg-sky-800 focus:ring-sky-300 dark:bg-sky-600 dark:hover:bg-sky-700 dark:focus:ring-sky-800
  bg-blue-700 hover:bg-blue-800 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800
  bg-indigo-700 hover:bg-indigo-800 focus:ring-indigo-300 dark:bg-indigo-600 dark:hover:bg-indigo-700 dark:focus:ring-indigo-800
  bg-violet-700 hover:bg-violet-800 focus:ring-violet-300 dark:bg-violet-600 dark:hover:bg-violet-700 dark:focus:ring-violet-800
  bg-purple-700 hover:bg-purple-800 focus:ring-purple-300 dark:bg-purple-600 dark:hover:bg-purple-700 dark:focus:ring-purple-800
  bg-fuchsia-700 hover:bg-fuchsia-800 focus:ring-fuchsia-300 dark:bg-fuchsia-600 dark:hover:bg-fuchsia-700 dark:focus:ring-fuchsia-800
  bg-pink-700 hover:bg-pink-800 focus:ring-pink-300 dark:bg-pink-600 dark:hover:bg-pink-700 dark:focus:ring-pink-800
  bg-rose-700 hover:bg-rose-800 focus:ring-rose-300 dark:bg-rose-600 dark:hover:bg-rose-700 dark:focus:ring-rose-800
"></div>

<script>
(() => {
  const html = document.documentElement;
  const nav  = document.querySelector('nav');
  const body = document.body;

  // Effective dark-mode detector: honor either html.dark or body.dark, or OS dark
  const isDarkMode = () => (
    html.classList.contains('dark') ||
    (body && body.classList.contains('dark')) ||
    (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
  );

  // selects
  const brandSel = document.getElementById('cp-primary');
  const lightSel = document.getElementById('cp-light');
  const darkSel  = document.getElementById('cp-dark');

  // find label+select wrappers
  function findGroup(selectId) {
    const sel = document.getElementById(selectId);
    const lab = document.querySelector(`label[for="${selectId}"]`);
    if (!sel) return null;
    let n = sel;
    for (let i = 0; i < 4 && n; i++, n = n.parentElement) {
      if (n.querySelector && lab && n.contains(sel) && n.contains(lab)) return n;
    }
    return (lab && lab.parentElement) || sel.parentElement || null;
  }
  const lightGroup = findGroup('cp-light');
  const darkGroup  = findGroup('cp-dark');

  // background targets: body, nav, main, navbar panel, and any [data-bg-sync]
  const getBgEls = () => [
    document.body,
    nav,
    document.querySelector('main'),
    document.getElementById('navbar-sticky'),          // <— NEW
    ...document.querySelectorAll('[data-bg-sync]')
  ].filter(Boolean);

  // ---------- Fixed color maps (no dynamic class strings) ----------
  // neutrals allowed
  const NEU = ['gray','neutral'];
  const CHR = ['red','orange','amber','yellow','lime','green','emerald','teal','cyan','sky','blue','indigo','violet','purple','fuchsia','pink','rose'];

  // LIGHT backgrounds (50/100/200 + white)
  const LIGHT_BG_MAP = {
    'white': ['bg-white'],

    'gray-50':['bg-gray-50'],'gray-100':['bg-gray-100'],'gray-200':['bg-gray-200'],
    'neutral-50':['bg-neutral-50'],'neutral-100':['bg-neutral-100'],'neutral-200':['bg-neutral-200'],

    'red-50':['bg-red-50'],'red-100':['bg-red-100'],'red-200':['bg-red-200'],
    'orange-50':['bg-orange-50'],'orange-100':['bg-orange-100'],'orange-200':['bg-orange-200'],
    'amber-50':['bg-amber-50'],'amber-100':['bg-amber-100'],'amber-200':['bg-amber-200'],
    'yellow-50':['bg-yellow-50'],'yellow-100':['bg-yellow-100'],'yellow-200':['bg-yellow-200'],
    'lime-50':['bg-lime-50'],'lime-100':['bg-lime-100'],'lime-200':['bg-lime-200'],
    'green-50':['bg-green-50'],'green-100':['bg-green-100'],'green-200':['bg-green-200'],
    'emerald-50':['bg-emerald-50'],'emerald-100':['bg-emerald-100'],'emerald-200':['bg-emerald-200'],
    'teal-50':['bg-teal-50'],'teal-100':['bg-teal-100'],'teal-200':['bg-teal-200'],
    'cyan-50':['bg-cyan-50'],'cyan-100':['bg-cyan-100'],'cyan-200':['bg-cyan-200'],
    'sky-50':['bg-sky-50'],'sky-100':['bg-sky-100'],'sky-200':['bg-sky-200'],
    'blue-50':['bg-blue-50'],'blue-100':['bg-blue-100'],'blue-200':['bg-blue-200'],
    'indigo-50':['bg-indigo-50'],'indigo-100':['bg-indigo-100'],'indigo-200':['bg-indigo-200'],
    'violet-50':['bg-violet-50'],'violet-100':['bg-violet-100'],'violet-200':['bg-violet-200'],
    'purple-50':['bg-purple-50'],'purple-100':['bg-purple-100'],'purple-200':['bg-purple-200'],
    'fuchsia-50':['bg-fuchsia-50'],'fuchsia-100':['bg-fuchsia-100'],'fuchsia-200':['bg-fuchsia-200'],
    'pink-50':['bg-pink-50'],'pink-100':['bg-pink-100'],'pink-200':['bg-pink-200'],
    'rose-50':['bg-rose-50'],'rose-100':['bg-rose-100'],'rose-200':['bg-rose-200'],
  };

  // DARK backgrounds on "other" elements (use dark: variant)
  const DARK_BG_MAP_OTHERS = {
    'gray-800':['dark:bg-gray-800'],'gray-900':['dark:bg-gray-900'],'gray-950':['dark:bg-gray-950'],
    'neutral-800':['dark:bg-neutral-800'],'neutral-900':['dark:bg-neutral-900'],'neutral-950':['dark:bg-neutral-950'],

    'red-950':['dark:bg-red-950'],'orange-950':['dark:bg-orange-950'],'amber-950':['dark:bg-amber-950'],
    'yellow-950':['dark:bg-yellow-950'],'lime-950':['dark:bg-lime-950'],'green-950':['dark:bg-green-950'],
    'emerald-950':['dark:bg-emerald-950'],'teal-950':['dark:bg-teal-950'],'cyan-950':['dark:bg-cyan-950'],
    'sky-950':['dark:bg-sky-950'],'blue-950':['dark:bg-blue-950'],'indigo-950':['dark:bg-indigo-950'],
    'violet-950':['dark:bg-violet-950'],'purple-950':['dark:bg-purple-950'],
    'fuchsia-950':['dark:bg-fuchsia-950'],'pink-950':['dark:bg-pink-950'],'rose-950':['dark:bg-rose-950'],
  };

  // DARK backgrounds on <html> (plain bg-* because .dark is on <html>)
  const DARK_BG_MAP_HTML = {
    'gray-800':['bg-gray-800'],'gray-900':['bg-gray-900'],'gray-950':['bg-gray-950'],
    'neutral-800':['bg-neutral-800'],'neutral-900':['bg-neutral-900'],'neutral-950':['bg-neutral-950'],

    'red-950':['bg-red-950'],'orange-950':['bg-orange-950'],'amber-950':['bg-amber-950'],
    'yellow-950':['bg-yellow-950'],'lime-950':['bg-lime-950'],'green-950':['bg-green-950'],
    'emerald-950':['bg-emerald-950'],'teal-950':['bg-teal-950'],'cyan-950':['bg-cyan-950'],
    'sky-950':['bg-sky-950'],'blue-950':['bg-blue-950'],'indigo-950':['bg-indigo-950'],
    'violet-950':['bg-violet-950'],'purple-950':['bg-purple-950'],
    'fuchsia-950':['bg-fuchsia-950'],'pink-950':['bg-pink-950'],'rose-950':['bg-rose-950'],
  };

  // Button brand map (solid style), matching your CTA palette
  const BTN_MAP = {
    red: ["bg-red-700","hover:bg-red-800","focus:ring-red-300","dark:bg-red-600","dark:hover:bg-red-700","dark:focus:ring-red-800"],
    orange: ["bg-orange-700","hover:bg-orange-800","focus:ring-orange-300","dark:bg-orange-600","dark:hover:bg-orange-700","dark:focus:ring-orange-800"],
    amber: ["bg-amber-700","hover:bg-amber-800","focus:ring-amber-300","dark:bg-amber-600","dark:hover:bg-amber-700","dark:focus:ring-amber-800"],
    yellow: ["bg-yellow-700","hover:bg-yellow-800","focus:ring-yellow-300","dark:bg-yellow-600","dark:hover:bg-yellow-700","dark:focus:ring-yellow-800"],
    lime: ["bg-lime-700","hover:bg-lime-800","focus:ring-lime-300","dark:bg-lime-600","dark:hover:bg-lime-700","dark:focus:ring-lime-800"],
    green: ["bg-green-700","hover:bg-green-800","focus:ring-green-300","dark:bg-green-600","dark:hover:bg-green-700","dark:focus:ring-green-800"],
    emerald: ["bg-emerald-700","hover:bg-emerald-800","focus:ring-emerald-300","dark:bg-emerald-600","dark:hover:bg-emerald-700","dark:focus:ring-emerald-800"],
    teal: ["bg-teal-700","hover:bg-teal-800","focus:ring-teal-300","dark:bg-teal-600","dark:hover:bg-teal-700","dark:focus:ring-teal-800"],
    cyan: ["bg-cyan-700","hover:bg-cyan-800","focus:ring-cyan-300","dark:bg-cyan-600","dark:hover:bg-cyan-700","dark:focus:ring-cyan-800"],
    sky: ["bg-sky-700","hover:bg-sky-800","focus:ring-sky-300","dark:bg-sky-600","dark:hover:bg-sky-700","dark:focus:ring-sky-800"],
    blue: ["bg-blue-700","hover:bg-blue-800","focus:ring-blue-300","dark:bg-blue-600","dark:hover:bg-blue-700","dark:focus:ring-blue-800"],
    indigo: ["bg-indigo-700","hover:bg-indigo-800","focus:ring-indigo-300","dark:bg-indigo-600","dark:hover:bg-indigo-700","dark:focus:ring-indigo-800"],
    violet: ["bg-violet-700","hover:bg-violet-800","focus:ring-violet-300","dark:bg-violet-600","dark:hover:bg-violet-700","dark:focus:ring-violet-800"],
    purple: ["bg-purple-700","hover:bg-purple-800","focus:ring-purple-300","dark:bg-purple-600","dark:hover:bg-purple-700","dark:focus:ring-purple-800"],
    fuchsia: ["bg-fuchsia-700","hover:bg-fuchsia-800","focus:ring-fuchsia-300","dark:bg-fuchsia-600","dark:hover:bg-fuchsia-700","dark:focus:ring-fuchsia-800"],
    pink: ["bg-pink-700","hover:bg-pink-800","focus:ring-pink-300","dark:bg-pink-600","dark:hover:bg-pink-700","dark:focus:ring-pink-800"],
    rose: ["bg-rose-700","hover:bg-rose-800","focus:ring-rose-300","dark:bg-rose-600","dark:hover:bg-rose-700","dark:focus:ring-rose-800"],
    gray: ["bg-gray-700","hover:bg-gray-800","focus:ring-gray-300","dark:bg-gray-600","dark:hover:bg-gray-700","dark:focus:ring-gray-800"],
    neutral: ["bg-neutral-700","hover:bg-neutral-800","focus:ring-neutral-300","dark:bg-neutral-600","dark:hover:bg-neutral-700","dark:focus:ring-neutral-800"],
  };

  // helpers
  const uniq = a => Array.from(new Set(a));
  const flatten = arrs => arrs.reduce((acc, a) => (a && acc.push(...a), acc), []);

  // build removal sets from maps
  const ALL_LIGHT = uniq(flatten(Object.values(LIGHT_BG_MAP)));
  const ALL_DARK_OTHERS = uniq(flatten(Object.values(DARK_BG_MAP_OTHERS)));
  const ALL_DARK_HTML = uniq(flatten(Object.values(DARK_BG_MAP_HTML)));
  const ALL_BTN = uniq(flatten(Object.values(BTN_MAP)));

  // Link brand map (text color classes), mirroring server-side mapping
  const LINK_MAP = {
    red:     ["text-red-600","hover:text-red-700","dark:hover:text-red-500"],
    orange:  ["text-orange-600","hover:text-orange-700","dark:hover:text-orange-500"],
    amber:   ["text-amber-600","hover:text-amber-700","dark:hover:text-amber-500"],
    yellow:  ["text-yellow-600","hover:text-yellow-700","dark:hover:text-yellow-500"],
    lime:    ["text-lime-600","hover:text-lime-700","dark:hover:text-lime-500"],
    green:   ["text-green-600","hover:text-green-700","dark:hover:text-green-500"],
    emerald: ["text-emerald-600","hover:text-emerald-700","dark:hover:text-emerald-500"],
    teal:    ["text-teal-600","hover:text-teal-700","dark:hover:text-teal-500"],
    cyan:    ["text-cyan-600","hover:text-cyan-700","dark:hover:text-cyan-500"],
    sky:     ["text-sky-600","hover:text-sky-700","dark:hover:text-sky-500"],
    blue:    ["text-blue-600","hover:text-blue-700","dark:hover:text-blue-500"],
    indigo:  ["text-indigo-600","hover:text-indigo-700","dark:hover:text-indigo-500"],
    violet:  ["text-violet-600","hover:text-violet-700","dark:hover:text-violet-500"],
    purple:  ["text-purple-600","hover:text-purple-700","dark:hover:text-purple-500"],
    fuchsia: ["text-fuchsia-600","hover:text-fuchsia-700","dark:hover:text-fuchsia-500"],
    pink:    ["text-pink-600","hover:text-pink-700","dark:hover:text-pink-500"],
    rose:    ["text-rose-600","hover:text-rose-700","dark:hover:text-rose-500"],
    gray:    ["text-gray-600","hover:text-gray-700","dark:hover:text-gray-500"],
    neutral: ["text-neutral-600","hover:text-neutral-700","dark:hover:text-neutral-500"],
  };
  const ALL_LINK = uniq(flatten(Object.values(LINK_MAP)));

  const remove = (el, list) => el && list.forEach(c => el.classList.remove(c));
  const add    = (el, list) => el && list.forEach(c => el.classList.add(c));


// Navbar hover-only map (keep text white by default; color only on hover)
const NAV_MAP = {
  red:     ["hover:text-red-700","md:hover:text-red-700","dark:hover:text-red-500","md:dark:hover:text-red-500"],
  orange:  ["hover:text-orange-700","md:hover:text-orange-700","dark:hover:text-orange-500","md:dark:hover:text-orange-500"],
  amber:   ["hover:text-amber-700","md:hover:text-amber-700","dark:hover:text-amber-500","md:dark:hover:text-amber-500"],
  yellow:  ["hover:text-yellow-700","md:hover:text-yellow-700","dark:hover:text-yellow-500","md:dark:hover:text-yellow-500"],
  lime:    ["hover:text-lime-700","md:hover:text-lime-700","dark:hover:text-lime-500","md:dark:hover:text-lime-500"],
  green:   ["hover:text-green-700","md:hover:text-green-700","dark:hover:text-green-500","md:dark:hover:text-green-500"],
  emerald: ["hover:text-emerald-700","md:hover:text-emerald-700","dark:hover:text-emerald-500","md:dark:hover:text-emerald-500"],
  teal:    ["hover:text-teal-700","md:hover:text-teal-700","dark:hover:text-teal-500","md:dark:hover:text-teal-500"],
  cyan:    ["hover:text-cyan-700","md:hover:text-cyan-700","dark:hover:text-cyan-500","md:dark:hover:text-cyan-500"],
  sky:     ["hover:text-sky-700","md:hover:text-sky-700","dark:hover:text-sky-500","md:dark:hover:text-sky-500"],
  blue:    ["hover:text-blue-700","md:hover:text-blue-700","dark:hover:text-blue-500","md:dark:hover:text-blue-500"],
  indigo:  ["hover:text-indigo-700","md:hover:text-indigo-700","dark:hover:text-indigo-500","md:dark:hover:text-indigo-500"],
  violet:  ["hover:text-violet-700","md:hover:text-violet-700","dark:hover:text-violet-500","md:dark:hover:text-violet-500"],
  purple:  ["hover:text-purple-700","md:hover:text-purple-700","dark:hover:text-purple-500","md:dark:hover:text-purple-500"],
  fuchsia: ["hover:text-fuchsia-700","md:hover:text-fuchsia-700","dark:hover:text-fuchsia-500","md:dark:hover:text-fuchsia-500"],
  pink:    ["hover:text-pink-700","md:hover:text-pink-700","dark:hover:text-pink-500","md:dark:hover:text-pink-500"],
  rose:    ["hover:text-rose-700","md:hover:text-rose-700","dark:hover:text-rose-500","md:dark:hover:text-rose-500"],
  gray:    ["hover:text-gray-700","md:hover:text-gray-700","dark:hover:text-gray-500","md:dark:hover:text-gray-500"],
  neutral: ["hover:text-neutral-700","md:hover:text-neutral-700","dark:hover:text-neutral-500","md:dark:hover:text-neutral-500"],
};
const ALL_NAV = Array.from(new Set(Object.values(NAV_MAP).flat()));

// Strip these template backgrounds from <nav> so picker colors can win
const STATIC_NAV_BGS = [
  'bg-white/95','bg-white/60',
  'supports-[backdrop-filter]:bg-white/40',
  'dark:bg-gray-900/90','dark:bg-gray-900/40',
  'supports-[backdrop-filter]:dark:bg-gray-900/30'
];


  // ----- Brand link coloring (inline style) -----
  const BRAND_HEX = {
    gray:    { light:"#4b5563", dark:"#6b7280" },
    neutral: { light:"#525252", dark:"#737373" },
    red:     { light:"#dc2626", dark:"#ef4444" },
    orange:  { light:"#ea580c", dark:"#f97316" },
    amber:   { light:"#d97706", dark:"#f59e0b" },
    yellow:  { light:"#ca8a04", dark:"#eab308" },
    lime:    { light:"#65a30d", dark:"#84cc16" },
    green:   { light:"#16a34a", dark:"#22c55e" },
    emerald: { light:"#059669", dark:"#10b981" },
    teal:    { light:"#0d9488", dark:"#14b8a6" },
    cyan:    { light:"#0891b2", dark:"#06b6d4" },
    sky:     { light:"#0284c7", dark:"#0ea5e9" },
    blue:    { light:"#2563eb", dark:"#3b82f6" },
    indigo:  { light:"#4f46e5", dark:"#6366f1" },
    violet:  { light:"#7c3aed", dark:"#8b5cf6" },
    purple:  { light:"#9333ea", dark:"#a855f7" },
    fuchsia: { light:"#c026d3", dark:"#d946ef" },
    pink:    { light:"#db2777", dark:"#ec4899" },
    rose:    { light:"#e11d48", dark:"#f43f5e" },
  };
  // Server-side link colors: no inline coloring here; just notify listeners
  function recolorLinks() {
    const brand  = (brandSel && BTN_MAP[brandSel.value]) ? brandSel.value : "blue";
    try { window.dispatchEvent(new CustomEvent('cp:brandchange', { detail: brand })); } catch (e) {}
  }

  // brand tint (buttons + links) via maps
  const BRAND_SELECTOR = window.CP_BRAND_SELECTOR || '.ui-btn, .btn, .btn-primary, [data-ui-btn], [data-brand="primary"]';
  function applyBrand(color){
    const btnAdd = BTN_MAP[color] || BTN_MAP.blue;
    document.querySelectorAll(BRAND_SELECTOR).forEach(el => { remove(el, ALL_BTN); add(el, btnAdd); });
    // Update link-brand anchors to the selected color
    const linkAdd = LINK_MAP[color] || LINK_MAP.blue;
    document.querySelectorAll('a.link-brand').forEach(el => { remove(el, ALL_LINK); add(el, linkAdd); });
    recolorLinks();
  }

  function stripStaticNavBg(el) {
    if (!el) return;
    const keepBP = /^(sm:|md:|lg:|xl:|2xl:)/; // keep breakpoint-specific rules
    const isBg   = /^(?:supports-\[backdrop-filter]:)?(?:dark:)?bg-/; // bg-*, dark:bg-*, supports:[…]:bg-*
    for (const cls of Array.from(el.classList)) {
      if (!keepBP.test(cls) && isBg.test(cls)) el.classList.remove(cls);
    }
  }


  function repaint() {
    const isDark = isDarkMode();
    const targets = getBgEls();
    const root = document.documentElement;

    // NEW: remove template bg classes that override picker in dark mode
    stripStaticNavBg(nav);
    stripStaticNavBg(document.getElementById('navbar-sticky'));

    // clear normal targets
    targets.forEach(el => { remove(el, ALL_LIGHT); remove(el, ALL_DARK_OTHERS); });
    // clear <html>
    remove(root, ALL_LIGHT);
    remove(root, ALL_DARK_HTML);

    // LIGHT
    if (!isDark && lightSel?.value) {
      const L = LIGHT_BG_MAP[lightSel.value] || [];
      targets.forEach(el => add(el, L));
      add(root, L);
    }

    // DARK
    if (darkSel?.value) {
      const dOthers = DARK_BG_MAP_OTHERS[darkSel.value] || [];
      targets.forEach(el => add(el, dOthers));
      if (isDark) {
        const dRoot = DARK_BG_MAP_HTML[darkSel.value] || [];
        add(root, dRoot);
      }
    }
  }

  function syncPickerVisibility() {
    const isDark = isDarkMode();
    const lg = lightGroup, dg = darkGroup;
    if (lg) { lg.classList.toggle('hidden', isDark); lightSel?.toggleAttribute('disabled', isDark); }
    if (dg) { dg.classList.toggle('hidden', !isDark); darkSel?.toggleAttribute('disabled', !isDark); }
  }

  // react ONLY when the dark-mode flag changes on <html>
  let lastDark = isDarkMode();
  const onMut = (muts) => {
    for (const m of muts) {
      if (m.attributeName === 'class' && (m.target === html || m.target === body)) {
        const nowDark = isDarkMode();
        if (nowDark !== lastDark) {
          lastDark = nowDark;
          syncPickerVisibility();
          repaint();
          recolorLinks();
        }
      }
    }
  };
  new MutationObserver(onMut).observe(html, { attributes: true });
  if (body) new MutationObserver(onMut).observe(body, { attributes: true });
  // Also react to OS appearance changes
  try {
    const mql = window.matchMedia('(prefers-color-scheme: dark)');
    const onMql = () => {
      const nowDark = isDarkMode();
      if (nowDark !== lastDark) {
        lastDark = nowDark;
        syncPickerVisibility();
        repaint();
        recolorLinks();
      }
    };
    if (mql && mql.addEventListener) mql.addEventListener('change', onMql);
    else if (mql && mql.addListener) mql.addListener(onMql);
  } catch(e){}

  // events
  brandSel ?.addEventListener('change', () => { applyBrand(brandSel.value); try { window.dispatchEvent(new CustomEvent('cp:brandchange', { detail: brandSel.value })); } catch (e) {} });
  lightSel ?.addEventListener('change', () => { if (!isDarkMode()) repaint(); });
  darkSel  ?.addEventListener('change', () => { if ( isDarkMode()) repaint(); });

  // init
  syncPickerVisibility();
  if (brandSel) {
    applyBrand(brandSel.value);
    // notify global handlers so they can apply higher-priority styles (e.g., !important)
    try { window.dispatchEvent(new CustomEvent('cp:brandchange', { detail: brandSel.value })); } catch (e) {}
  }
  repaint();
  recolorLinks();

  // Schedule post-paint syncs in case upstream scripts toggle classes after our first run
  try { requestAnimationFrame(() => { syncPickerVisibility(); repaint(); recolorLinks(); }); } catch(e){}
  setTimeout(() => { syncPickerVisibility(); repaint(); recolorLinks(); }, 0);
})();
</script>


