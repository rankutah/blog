{{/*
  FAQs Accordion Shortcode â€” robust, Hugo-friendly implementation

  Usage (in your Markdown):
  {{< faqs >}}
  ### Question 1
  Answer text or markdown

  ### Question 2
  Another answer
  {{< /faqs >}}

  Notes:
  - This splits on "\n### " (safe) and supports Markdown in answers.
  - All items are collapsed by default; pass openFirst="true" to open the first one.
    Example:
      {{< faqs openFirst="true" >}}
  - Alignment: headings inherit text alignment; to avoid unintended centering, this shortcode
    now defaults to text-left. You can override with align="center".
*/}}

{{- $page := .Page -}}
{{- $raw := .Inner | default "" -}}
{{- /* Normalize and mark headings (## to ######) so we can split reliably while preserving levels */ -}}
{{- $raw2 := printf "\n%s\n" $raw -}}
{{- $marked := replaceRE "\n(#{2,6})\\s+" "\n<<<FAQ>>>$1 " $raw2 -}}
{{- $parts := split $marked "\n<<<FAQ>>>" -}}
{{- $faqBlocks := slice -}}
{{- /* Optional: open the first item by default via openFirst="true|yes|1" */ -}}
{{- $openFirstParam := lower (.Get "openFirst" | default (.Get "firstOpen")) -}}
{{- $openFirst := or (eq $openFirstParam "true") (eq $openFirstParam "yes") (eq $openFirstParam "1") -}}

{{- /* Optional: emit FAQPage JSON-LD using the same source content (single source of truth)
      Enable with: {{< faqs schema="true" >}}
      Defaults to false to avoid unintentional SEO changes sitewide.
      If front matter already defines .Params.schema.faq, we skip emitting here to avoid duplicates.
*/ -}}
{{- $schemaParam := lower (.Get "schema" | default (.Get "jsonld" | default (.Get "ldjson"))) -}}
{{- $emitSchema := or (eq $schemaParam "true") (eq $schemaParam "yes") (eq $schemaParam "1") -}}
{{- if $page.Params.schema.faq -}}
  {{- $emitSchema = false -}}
{{- end -}}

{{- /* Alignment control (start|center). Default to start to prevent inherited centering */ -}}
{{- $alignParam := lower (.Get "align" | default "start") -}}
{{- $alMap := dict "start" "text-left" "center" "text-center" -}}
{{- $alClass := (index $alMap $alignParam) | default "text-left" -}}

{{- /* Optional site-level styling overrides
      [params.faqs]
        borderClasses = "border border-black/10 dark:border-white/10"
*/ -}}
{{- $faqParams := $page.Site.Params.faqs | default (dict) -}}
{{- $borderClasses := (index $faqParams "borderClasses") | default "border border-black/10 dark:border-white/10" -}}

{{- /* Match expanded/highlighted item background to card surface */ -}}
{{- $pal := partial "theme/palette.html" $page -}}
{{- $cardBg := (index $pal "cardBg") | default "bg-gray-100 dark:bg-gray-800" -}}
{{- range $i, $p := $parts }}
  {{- $trim := trim $p " \n" -}}
  {{- if ne $trim "" -}}
    {{- $faqBlocks = $faqBlocks | append $trim -}}
  {{- end -}}
{{- end -}}

<div id="accordion-collapse" data-accordion="collapse" class="{{ $alClass }}">
  {{- $count := len $faqBlocks -}}
  {{- $schemaItems := slice -}}
  {{- range $i, $blk := $faqBlocks }}
    {{- $qid := printf "accordion-collapse-heading-%d" (add $i 1) -}}
    {{- $bid := printf "accordion-collapse-body-%d" (add $i 1) -}}
    {{- $lines := split $blk "\n" -}}
    {{- $first := trim (index $lines 0) " \n" -}}
    {{- $m := findRE "^#{2,6}" $first -}}
    {{- $level := 3 -}}
    {{- if gt (len $m) 0 -}}
      {{- $hashes := index $m 0 -}}
      {{- $level = len $hashes -}}
    {{- end -}}
    {{- $title := trim (replaceRE "^#{2,6}\\s*" "" $first) " \n" -}}
    {{- $body := "" -}}
    {{- $bodyRaw := "" -}}
    {{- if gt (len $lines) 1 -}}
      {{- /* Remove the first line (the title) and its following newline from the block, then markdownify the remainder. */ -}}
  {{- $bodyRaw = trim (replaceRE "^[^\n]+\n?" "" $blk) " \n" -}}
      {{- $body = ( $bodyRaw | markdownify ) -}}
    {{- end -}}

    {{- if $emitSchema -}}
      {{- $answerText := "" -}}
      {{- if ne $bodyRaw "" -}}
        {{- $opts := dict "markup" "goldmark" "renderShortcodes" true -}}
        {{- $answerText = trim (($page.RenderString $opts $bodyRaw) | plainify) " \n\t" -}}
      {{- end -}}
      {{- if and (ne $title "") (ne $answerText "") -}}
        {{- $schemaItems = $schemaItems | append (dict "@type" "Question" "name" $title "acceptedAnswer" (dict "@type" "Answer" "text" $answerText)) -}}
      {{- end -}}
    {{- end -}}
    {{- $isFirst := eq $i 0 -}}
    {{- $expanded := and $isFirst $openFirst -}}
    {{- $isLast := eq $i (sub $count 1) -}}
  {{- /* Use text-left (not text-inherit) to defeat parent centering on mobile */ -}}
  {{- $btnBase := printf "flex items-center justify-between w-full p-5 rtl:text-right text-left %s focus:outline-none focus:ring-0 gap-3 mb-0 transition-colors duration-150 hover:bg-black/5 dark:hover:bg-white/10" $borderClasses -}}
    {{- $btnClasses := slice $btnBase -}}
    {{- if $expanded }}{{ $btnClasses = $btnClasses | append $cardBg }}{{ end -}}
    {{- if $isFirst }}{{ $btnClasses = $btnClasses | append "rounded-t-xl" }}{{ end -}}
    {{- if not $isLast }}{{ $btnClasses = $btnClasses | append "border-b-0" }}{{ end -}}

  {{- /* Choose heading tag based on the level parsed (default h3). Clamp between 2 and 6. */ -}}
  {{- $h := cond (lt $level 2) 3 (cond (gt $level 6) 3 $level) -}}
  {{- /* not-prose prevents Typography plugin heading rules (like center) from applying; add text-left explicitly */ -}}
  {{- printf "<h%d id=\"%s\" class=\"mt-0 mb-0 not-prose text-left\">" $h $qid | safeHTML -}}
      <button type="button"
        class="{{ delimit $btnClasses " " }}"
        data-accordion-target="#{{ $bid }}"
        aria-expanded="{{ if $expanded }}true{{ else }}false{{ end }}"
        aria-controls="{{ $bid }}">
        <span>{{ $title }}</span>
        <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0 text-black dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/>
        </svg>
      </button>
  {{- printf "</h%d>" $h | safeHTML -}}

    <div id="{{ $bid }}" class="{{ if not $expanded }}hidden{{ end }}" aria-labelledby="{{ $qid }}">
  {{- /* Ensure panel content is left-aligned even if surrounding section is centered */ -}}
  {{- $panelBase := printf "p-5 text-left %s %s" $borderClasses $cardBg -}}
      {{- $panelClasses := slice $panelBase -}}
      {{- if not $isLast }}
        {{- $panelClasses = $panelClasses | append "border-b-0" -}}
      {{- else -}}
        {{- /* For the last panel add a rounded bottom; keep top border so it touches header */ -}}
        {{- $panelClasses = $panelClasses | append "rounded-b-xl" -}}
      {{- end -}}
      <div class="{{ delimit $panelClasses " " }}">
        {{- $opts := dict "markup" "goldmark" "renderShortcodes" true -}}
        {{- $page.RenderString $opts $bodyRaw -}}
      </div>
    </div>
  {{- end }}
</div>

{{- if and $emitSchema (gt (len $schemaItems) 0) -}}
<script type="application/ld+json">
{{- dict "@context" "https://schema.org" "@type" "FAQPage" "mainEntity" $schemaItems | jsonify | safeJS -}}
</script>
{{- end -}}
