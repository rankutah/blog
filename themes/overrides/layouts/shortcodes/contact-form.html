{{/* layouts/shortcodes/contact_form.html

Contact form â†’ posts to Worker via JS.
Reads endpoint/success/error from site params.
Defensively strips accidental wrapping quotes from endpoint.
*/}}

{{- $raw := or site.Params.form.endpoint "https://form-sender.benjamin-0e3.workers.dev/submit" -}}
{{- $raw = trim $raw " " -}}
{{- if strings.HasPrefix $raw "\"" }}{{ $raw = substr $raw 1 }}{{ end -}}
{{- if strings.HasSuffix $raw "\"" }}{{ $raw = substr $raw 0 (sub (len $raw) 1) }}{{ end -}}
{{- if strings.HasPrefix $raw "'"  }}{{ $raw = substr $raw 1 }}{{ end -}}
{{- if strings.HasSuffix $raw "'"  }}{{ $raw = substr $raw 0 (sub (len $raw) 1) }}{{ end -}}
{{- $endpoint := $raw -}}

{{- $success  := or site.Params.form.successMessage "Thanks! We received your message." -}}
{{- $error    := or site.Params.form.errorMessage   "Something went wrong. Please try again." -}}

<div class="not-prose">
  <form id="contact-form" class="space-y-6" novalidate>
    <div>
      <label for="cf-email" class="block mb-2 text-sm font-medium">Your email</label>
      <input type="email" id="cf-email" name="email" required
             class="block w-full rounded-lg border p-2.5 text-sm" placeholder="you@example.com">
    </div>
    <div>
      <label for="cf-subject" class="block mb-2 text-sm font-medium">Subject</label>
      <input type="text" id="cf-subject" name="subject"
             class="block w-full rounded-lg border p-3 text-sm" placeholder="How can we help?">
    </div>
    <div>
      <label for="cf-name" class="block mb-2 text-sm font-medium">Your name (optional)</label>
      <input type="text" id="cf-name" name="name"
             class="block w-full rounded-lg border p-3 text-sm" placeholder="Jane Doe">
    </div>
    <div>
      <label for="cf-message" class="block mb-2 text-sm font-medium">Your message</label>
      <textarea id="cf-message" name="message" rows="6" required
                class="block w-full rounded-lg border p-2.5 text-sm" placeholder="Leave a comment..."></textarea>
    </div>

    <button type="submit" class="py-3 px-5 text-sm font-medium text-white rounded-lg bg-blue-700 hover:bg-blue-800">
      Send message
    </button>

    <p id="contact-msg" class="mt-3 text-sm"></p>
  </form>
</div>

<script>
(function(){
  const ENDPOINT = {{ $endpoint | jsonify }};
  const SUCCESS  = {{ $success  | jsonify }};
  const ERRORMSG = {{ $error    | jsonify }};

  // Extra defense: strip any wrapping quotes that may have sneaked in.
  function normalizeEndpoint(s){
    try{
      let t = (s||"").trim();
      if ((t.startsWith('"') && t.endsWith('"')) || (t.startsWith("'") && t.endsWith("'"))) {
        t = t.slice(1, -1);
      }
      // Some builds accidentally encode quotes: %22https...%22
      t = t.replace(/^%22/, "").replace(/%22$/, "");
      return t;
    }catch{ return s; }
  }

  const ep = normalizeEndpoint(ENDPOINT);
  // Debug line: check what the browser sees. Remove later if you want.
  console.log("Contact form endpoint =", ep);

  const form = document.getElementById('contact-form');
  const msg  = document.getElementById('contact-msg');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = "";
    const data = Object.fromEntries(new FormData(form).entries());

    try {
      const res  = await fetch(ep, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        mode: 'cors',
        credentials: 'omit',
        body: JSON.stringify(data)
      });
      const json = await res.json().catch(() => ({}));
      if (res.ok && json.ok) {
        msg.textContent = SUCCESS;
        form.reset();
      } else {
        msg.textContent = json.error || ERRORMSG;
      }
    } catch (err) {
      msg.textContent = ERRORMSG;
    }
  });
})();
</script>
