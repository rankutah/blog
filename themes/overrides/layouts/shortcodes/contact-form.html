{{- /* Contact form (Flowbite) â€” centralized, no external JS file.
     Reads site params:
       [params.forms]
         worker         = "https://<your-worker>.workers.dev"
         domain         = "blog.rankutah.com"
         successMessage = "Thanks! Your message was sent."
         errorMessage   = "Network error. Please try again."
   */ -}}

{{- $cfg     := .Page.Site.Params.forms | default (dict) -}}
{{- $worker  := or (index $cfg "worker") "" -}}
{{- $domain  := or (index $cfg "domain") "" -}}
{{- $okMsg   := or (index $cfg "successMessage") "Thanks! Your message was sent." -}}
{{- $errMsg  := or (index $cfg "errorMessage") "Something went wrong. Please try again." -}}

{{- /* Guard rails */ -}}
{{- if not $worker -}}
  <div class="text-red-600">Missing <code>params.forms.worker</code> in site config.</div>
  {{- /* Stop early to avoid broken JS */ -}}
  {{- return -}}
{{- end -}}
{{- if not $domain -}}
  <div class="text-red-600">Missing <code>params.forms.domain</code> in site config.</div>
  {{- return -}}
{{- end -}}

{{- /* Optional unique id if multiple forms on a page */ -}}
{{- $id := .Get "id" | default "contact-form" -}}

<section class="not-prose">
  <div class="py-8 lg:py-16 px-4 mx-auto max-w-screen-md">
    <h2 class="mb-4 text-4xl tracking-tight font-extrabold text-center text-gray-900 dark:text-white">Contact Us</h2>
    <p class="mb-8 lg:mb-16 font-light text-center text-gray-500 dark:text-gray-400 sm:text-xl">
      Got a technical issue? Want to send feedback? Need details about a plan? Let us know.
    </p>

    <!-- No action attribute (prevent default via JS), method present for semantics -->
    <form id="{{ $id }}" method="post" class="space-y-8" novalidate>
      <div>
        <label for="{{ $id }}-email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-300">Your email</label>
        <input type="email" id="{{ $id }}-email" name="email" required
               class="shadow-sm bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg
                      focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5
                      dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white
                      dark:focus:ring-blue-500 dark:focus:border-blue-500 dark:shadow-sm-light"
               placeholder="you@example.com">
      </div>

      <div>
        <label for="{{ $id }}-subject" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-300">Subject</label>
        <input type="text" id="{{ $id }}-subject" name="subject" required
               class="block p-3 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 shadow-sm
                      focus:ring-blue-500 focus:border-blue-500
                      dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white
                      dark:focus:ring-blue-500 dark:focus:border-blue-500 dark:shadow-sm-light"
               placeholder="Let us know how we can help you">
      </div>

      <div>
        <label for="{{ $id }}-message" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400">Your message</label>
        <textarea id="{{ $id }}-message" name="message" rows="6" required
                  class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg shadow-sm border border-gray-300
                         focus:ring-blue-500 focus:border-blue-500
                         dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white
                         dark:focus:ring-blue-500 dark:focus:border-blue-500"
                  placeholder="Leave a comment..."></textarea>
      </div>

      <!-- Optional extra fields -->
      <input type="hidden" name="name"    value="">
      <input type="hidden" name="company" value="">

      <button type="submit"
              class="py-3 px-5 text-sm font-medium text-center text-white rounded-lg bg-blue-700 hover:bg-blue-800
                     focus:ring-4 focus:outline-none focus:ring-blue-300
                     dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
        Send message
      </button>

      <p data-status class="text-sm mt-3"></p>
    </form>
  </div>
</section>

<script>
(function() {
  const form = document.getElementById({{ printf "%q" $id }});
  if (!form) return;

  // Build absolute endpoint safely: NO extra quotes in the URL.
  const ENDPOINT = {{ printf "%q" (printf "%s/submit?domain=%s" $worker $domain) }};

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const btn = form.querySelector('[type="submit"]');
    const out = form.querySelector('[data-status]');
    out.textContent = '';
    out.className = 'text-sm mt-3';
    btn.disabled = true;

    try {
      const payload = {
        email:   form.email?.value?.trim()   || '',
        subject: form.subject?.value?.trim() || '',
        message: form.message?.value?.trim() || '',
        name:    form.name?.value?.trim()    || '',
        company: form.company?.value?.trim() || ''
      };

      // Basic client-side check
      if (!payload.email || !payload.subject || !payload.message) {
        out.textContent = 'Please fill in all required fields.';
        out.classList.add('text-red-700');
        btn.disabled = false;
        return;
      }

      const res  = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        mode: 'cors',
        credentials: 'omit',
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => ({}));

      if (res.ok && data && data.ok) {
        out.textContent = {{ printf "%q" $okMsg }};
        out.classList.add('text-green-700');
        form.reset();
      } else {
        out.textContent = (data && data.error) ? data.error : {{ printf "%q" $errMsg }};
        out.classList.add('text-red-700');
      }
    } catch (err) {
      out.textContent = {{ printf "%q" $errMsg }};
      out.classList.add('text-red-700');
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>
