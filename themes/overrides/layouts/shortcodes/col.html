{{- /* layouts/shortcodes/col.html
     Single column (renders Markdown once)

     Props:
       card="true|false"             → apply card visuals on a wrapper div
       classes="…"                   → extra utility classes
       bg="rose-50|white|…"         → OPTIONAL per-card light bg (maps to bg-*)
       darkbg="rose-900|black|…"    → OPTIONAL per-card dark bg (maps to dark:bg-*)
       render="md|raw|auto"         → content rendering (default md)
       y="start|center|end|between" → vertical align (default center)
  order="N|first|last|none"    → MOBILE-ONLY visual order. Applies base order and resets to DOM order on md+.
*/ -}}

{{- $page   := .Page -}}
{{- $inner  := .InnerDeindent | strings.TrimSpace -}}
{{- $isCard := eq (lower (.Get "card" | default "false")) "true" -}}
{{- $extra  := .Get "classes" | default "" -}}
{{- $render := lower (.Get "render" | default "md") -}}

{{- /* Mobile-only order: apply `order-*` at base and reset to DOM order on md+ with `md:order-none` */ -}}
{{- $orderRaw := lower (.Get "order" | default "") -}}
{{- $orderCls := "" -}}
{{- if ne $orderRaw "" -}}
  {{- if or (eq $orderRaw "none") (eq $orderRaw "0") -}}
    {{- $orderCls = "order-none md:order-none" -}}
  {{- else if or (eq $orderRaw "first") (eq $orderRaw "-1") -}}
    {{- $orderCls = "order-first md:order-none" -}}
  {{- else if eq $orderRaw "last" -}}
    {{- $orderCls = "order-last md:order-none" -}}
  {{- else -}}
    {{- /* numeric 1..12 (fallback to 1 if unparsable) */ -}}
    {{- $num := replaceRE `[^0-9]` "" $orderRaw -}}
    {{- if eq $num "" -}}{{ $num = "1" }}{{ end -}}
    {{- $orderCls = printf "order-%s md:order-none" $num -}}
  {{- end -}}
{{- end -}}

{{- /* Vertical align wrapper (applied around the inner content) */ -}}
{{- $y := lower (.Get "y" | default "start") -}}
{{- $yMap := dict
  "start"   "justify-start"
  "center"  "justify-center"
  "end"     "justify-end"
  "between" "justify-between"
-}}
{{- $vWrap := "" -}}
{{- with (index $yMap $y) -}}
  {{- $vWrap = printf "flex flex-col h-full %s" . -}}
{{- end -}}

{{- /* Palette (has cardBg + cardBorder) */ -}}
{{- $pal := partial "theme/palette.html" $page -}}
{{- $cardBg := or $pal.cardBg "bg-gray-100 dark:bg-gray-800" -}}
{{- $cardBorder := or $pal.cardBorder "border border-gray-200 dark:border-gray-700" -}}

{{- /* Site-level full override (optional) */ -}}
{{- $siteCard := $page.Site.Params.col.cardClasses | default "" -}}

{{- /* Detect if user/site already set bg/border in classes so defaults don't collide */ -}}
{{- $hasBgClasses     := or (strings.Contains $extra " bg-") (strings.HasPrefix $extra "bg-") (strings.Contains $extra " dark:bg-") -}}
{{- $hasBorderClasses := or (strings.Contains $extra " border-") (strings.HasPrefix $extra "border-") (strings.Contains $extra " dark:border-") -}}
{{- $siteHasBg        := or (strings.Contains $siteCard " bg-") (strings.HasPrefix $siteCard "bg-") (strings.Contains $siteCard " dark:bg-") -}}
{{- $siteHasBorder    := or (strings.Contains $siteCard " border-") (strings.HasPrefix $siteCard "border-") (strings.Contains $siteCard " dark:border-") -}}

{{- /* ---------- Per-card BG PROPS (bg, darkbg) ---------- */ -}}
{{- $bgRaw     := lower (.Get "bg" | default "") -}}
{{- $darkBgRaw := lower (.Get "darkbg" | default "") -}}

{{- /* Static map for supported card backgrounds (light mode) */ -}}
{{- /* Support color names and color-shade for bg */ -}}
{{- $bgClass := "" -}}
{{- if ne $bgRaw "" -}}
  {{- if or (strings.Contains $bgRaw "-") (strings.HasPrefix $bgRaw "bg-") -}}
    {{- $bgClass = cond (strings.HasPrefix $bgRaw "bg-") $bgRaw (printf "bg-%s" $bgRaw) -}}
  {{- else -}}
    {{- $bgClass = printf "bg-%s-100" $bgRaw -}}
  {{- end -}}
{{- end -}}

{{- /* Static map for supported card backgrounds (dark mode) */ -}}
{{- /* Support color names and color-shade for darkbg */ -}}
{{- $darkBgClass := "" -}}
{{- if ne $darkBgRaw "" -}}
  {{- if or (strings.Contains $darkBgRaw "-") (strings.HasPrefix $darkBgRaw "dark:bg-") -}}
    {{- $darkBgClass = cond (strings.HasPrefix $darkBgRaw "dark:bg-") $darkBgRaw (printf "dark:bg-%s" $darkBgRaw) -}}
  {{- else -}}
    {{- $darkBgClass = printf "dark:bg-%s-950" $darkBgRaw -}}
  {{- end -}}
{{- end -}}

{{- $bgOverride := "" -}}
{{- if or (ne $bgClass "") (ne $darkBgClass "") -}}
  {{- $bgOverride = strings.TrimSpace (printf "%s %s" $bgClass $darkBgClass) -}}
{{- end -}}
{{- /* Support both color names and full Tailwind shade classes for bg and darkbg */ -}}
{{- /* normalize light bg prop */ -}}
{{- $bgClass := "" -}}
{{- if ne $bgRaw "" -}}
  {{- $tmp := $bgRaw -}}
  {{- if strings.HasPrefix $tmp "dark:bg-" -}}{{ $tmp = replace $tmp "dark:bg-" "" -}}{{ end -}}
  {{- if strings.HasPrefix $tmp "bg-" -}}{{ $tmp = replace $tmp "bg-" "" -}}{{ end -}}
  {{- if or (eq $tmp "white") (eq $tmp "bg-white") -}}
    {{- $bgClass = "bg-white" -}}
  {{- else -}}
    {{- $lp := split $tmp "-" -}}
    {{- $lc := index $lp 0 -}}
    {{- $ls := cond (ge (len $lp) 2) (index $lp 1) "100" -}}
    {{- $colors := slice "red" "orange" "amber" "yellow" "lime" "green" "emerald" "teal" "cyan" "sky" "blue" "indigo" "violet" "purple" "fuchsia" "pink" "rose" "slate" "gray" "zinc" "neutral" "stone" -}}
    {{- $valid := false -}}{{- range $colors }}{{ if eq . $lc }}{{ $valid = true }}{{ end }}{{ end -}}
    {{- if not $valid }}{{ $lc = "slate" }}{{ end -}}
    {{- if not (or (eq $ls "50") (eq $ls "100") (eq $ls "200")) }}{{ $ls = "100" }}{{ end -}}
    {{- $bgClass = printf "bg-%s-%s" $lc $ls -}}
  {{- end -}}
{{- end -}}

{{- /* normalize dark bg prop */ -}}
{{- $darkBgClass := "" -}}
{{- if ne $darkBgRaw "" -}}
  {{- $tmp := $darkBgRaw -}}
  {{- if strings.HasPrefix $tmp "dark:bg-" -}}{{ $tmp = replace $tmp "dark:bg-" "" -}}{{ end -}}
  {{- if strings.HasPrefix $tmp "bg-" -}}{{ $tmp = replace $tmp "bg-" "" -}}{{ end -}}
  {{- if or (eq $tmp "black") (eq $tmp "bg-black") -}}
    {{- $darkBgClass = "dark:bg-black" -}}
  {{- else -}}
    {{- $dp := split $tmp "-" -}}
    {{- $dc := index $dp 0 -}}
    {{- $ds := cond (ge (len $dp) 2) (index $dp 1) "900" -}}
    {{- $colors := slice "red" "orange" "amber" "yellow" "lime" "green" "emerald" "teal" "cyan" "sky" "blue" "indigo" "violet" "purple" "fuchsia" "pink" "rose" "slate" "gray" "zinc" "neutral" "stone" -}}
    {{- $valid := false -}}{{- range $colors }}{{ if eq . $dc }}{{ $valid = true }}{{ end }}{{ end -}}
    {{- if not $valid }}{{ $dc = "zinc" }}{{ end -}}
    {{- if not (or (eq $ds "800") (eq $ds "900") (eq $ds "950")) }}{{ $ds = "900" }}{{ end -}}
    {{- $darkBgClass = printf "dark:bg-%s-%s" $dc $ds -}}
  {{- end -}}
{{- end -}}

{{- $bgOverride := "" -}}
{{- if or (ne $bgClass "") (ne $darkBgClass "") -}}
  {{- $bgOverride = strings.TrimSpace (printf "%s %s" $bgClass $darkBgClass) -}}
{{- end -}}

{{- /* Base card classes (ensure the column BOX fills row height) */ -}}
{{- $parts := slice "w-full" "h-full" "rounded-lg" "shadow-sm" "p-6" "text-left" "flex" "flex-col" -}}

{{- if or $hasBgClasses $siteHasBg -}}
{{- else if ne $bgOverride "" -}}
  {{- $parts = $parts | append $bgOverride -}}
{{- else -}}
  {{- $parts = $parts | append $cardBg -}}
{{- end -}}

{{- if or $hasBorderClasses $siteHasBorder -}}
{{- else -}}
  {{- $parts = $parts | append $cardBorder -}}
{{- end -}}

{{- $cardBase := delimit $parts " " -}}
{{- $card := cond (ne $siteCard "") $siteCard $cardBase -}}
{{- if ne $orderCls "" }}{{ $card = printf "%s %s" $card $orderCls }}{{ end -}}
{{- if ne $extra "" }}{{ $card = printf "%s %s" $card $extra }}{{ end -}}

{{- /* Render strategy: md (default), raw, auto) with shortcode support */ -}}
{{- $html := "" -}}
{{- $opts := dict "markup" "goldmark" "renderShortcodes" true -}}
{{- if eq $render "raw" -}}
  {{- $html = $inner | safeHTML -}}
{{- else if eq $render "auto" -}}
  {{- /* If the inner contains shortcode tokens, render them; otherwise render as Markdown */ -}}
  {{- if (findRE `\{\{[<%]` $inner) -}}
    {{- $html = $page.RenderString $opts $inner -}}
  {{- else -}}
    {{- $html = $page.RenderString $opts $inner -}}
  {{- end -}}
{{- else -}}
  {{- $html = $page.RenderString $opts $inner -}}
{{- end -}}

{{- if $isCard -}}
  <div class="{{ $card }}">
    {{- if $vWrap }}<div class="{{ $vWrap }}">{{ end }}
      {{- $html -}}
    {{- if $vWrap }}</div>{{ end }}
  </div>
{{- else -}}
  <div class="h-full{{ if ne $orderCls "" }} {{ $orderCls }}{{ end }}{{ with $extra }} {{ . }}{{ end }}">
    {{- if $vWrap }}<div class="{{ $vWrap }}">{{ end }}
      {{- $html -}}
    {{- if $vWrap }}</div>{{ end }}
  </div>
{{- end -}}
