{{/* themes/overrides/layouts/_default/flowbite.html */}}
<!DOCTYPE html>
<html class="{{ .Site.Params.brandColor | default "rose" }}" lang="{{ .Site.Language.Lang }}" dir="{{ .Site.Language.LanguageDirection | default "auto" }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ .Title }} | {{ .Site.Title }}</title>

  <!-- Meta description (page -> site -> summary/content fallback) -->
  <meta name="description" content='{{- with .Params.description -}}
    {{ . | plainify | htmlEscape }}
  {{- else -}}
    {{- with site.Params.description -}}
      {{ . | plainify | htmlEscape }}
    {{- else -}}
      {{- $auto := cond (gt (len .Summary) 0) (.Summary | plainify) (.Content | plainify) -}}
      {{- $clean := replace $auto "\n" " " | replace "\r" " " | truncate 160 -}}
      {{- $clean | htmlEscape -}}
    {{- end -}}
  {{- end -}}'>

  <!-- Dark-mode bootstrap:
       - If <html data-force-theme="dark|light"> is present, use that.
       - Otherwise follow the OS preference.
       - Reacts live to changes of data-force-theme AND (optionally) OS changes when not forced. -->
  <script>
(function(){
  const html = document.documentElement;

  // Static HEX map (light/dark) â€” no Tailwind involvement
  const BRAND_HEX = {
    gray:{light:"#4b5563",dark:"#6b7280"}, neutral:{light:"#525252",dark:"#737373"},
    red:{light:"#dc2626",dark:"#ef4444"}, orange:{light:"#ea580c",dark:"#f97316"},
    amber:{light:"#d97706",dark:"#f59e0b"}, yellow:{light:"#ca8a04",dark:"#eab308"},
    lime:{light:"#65a30d",dark:"#84cc16"}, green:{light:"#16a34a",dark:"#22c55e"},
    emerald:{light:"#059669",dark:"#10b981"}, teal:{light:"#0d9488",dark:"#14b8a6"},
    cyan:{light:"#0891b2",dark:"#06b6d4"}, sky:{light:"#0284c7",dark:"#0ea5e9"},
    blue:{light:"#2563eb",dark:"#3b82f6"}, indigo:{light:"#4f46e5",dark:"#6366f1"},
    violet:{light:"#7c3aed",dark:"#8b5cf6"}, purple:{light:"#9333ea",dark:"#a855f7"},
    fuchsia:{light:"#c026d3",dark:"#d946ef"}, pink:{light:"#db2777",dark:"#ec4899"},
    rose:{light:"#e11d48",dark:"#f43f5e"}
  };

  // Brand on first paint: prefer <html data-brand="..."> set by picker; else site param; else blue
  const SITE_BRAND = "{{- lower (or .Site.Params.primaryColor .Site.Params.brandColor) -}}";
  function currentBrand(){
    return (html.getAttribute('data-brand') || SITE_BRAND || "blue").trim();
  }

  // Color helpers that write inline styles with !important (wins over main.min.css)
  function setImportant(el, prop, val){
    if (!el) return;
    el.style.setProperty(prop, val, 'important');
  }

  function recolorLinks(){
    const isDark = html.classList.contains('dark');
    const pal = BRAND_HEX[currentBrand()] || BRAND_HEX.blue;
    const hex = isDark ? pal.dark : pal.light;
    document.querySelectorAll('a.link-brand').forEach(a => setImportant(a, 'color', hex));
  }

  function recolorNavbar(){
    const isDark = html.classList.contains('dark');
    const pal = BRAND_HEX[currentBrand()] || BRAND_HEX.blue;
    const fg  = isDark ? pal.dark : pal.light;

    // Text color in navbar
    document.querySelectorAll('nav .nav-brand, [data-brand-nav="fg"]').forEach(el => setImportant(el, 'color', fg));

    // Background accents in navbar (e.g., badges, pills, active underline containers you want solid)
    document.querySelectorAll('nav .nav-brand-bg, [data-brand-nav="bg"]').forEach(el => setImportant(el, 'background-color', fg));

    // Borders (e.g., active item bottom border)
    document.querySelectorAll('nav .nav-brand-border, [data-brand-nav="border"]').forEach(el => setImportant(el, 'border-color', fg));
  }

  function recolorAll(){
    recolorLinks();
    recolorNavbar();
  }

  // Run on first paint
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', recolorAll, { once:true });
  } else {
    recolorAll();
  }

  // Re-run on theme flips (OS or any toggle that adds/removes .dark)
  new MutationObserver(m => {
    for (const x of m) if (x.attributeName === 'class') { recolorAll(); break; }
  }).observe(html, { attributes:true });

  // Listen for brand changes from the picker (you already dispatch this)
  window.addEventListener('cp:brandchange', e => {
    if (e && e.detail) html.setAttribute('data-brand', e.detail);
    recolorAll();
  });
})();
</script>

  <script>
  try {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.classList.toggle('dark', prefersDark);
  } catch (e) {}
</script>

  {{- /* Tailwind + Flowbite CSS via Hugo Pipes + minify (blocking to prevent FOUC) */ -}}
  {{- $css := resources.Get "css/main.css" | postCSS | minify }}
  <link rel="stylesheet"
    href="{{ $css.RelPermalink }}"
    {{ if $css.Data.Integrity }}integrity="{{ $css.Data.Integrity }}"{{ end }}
    crossorigin="anonymous">

  {{- /* Analytics (match PaperMod behavior: only in production) */ -}}
  {{- if or (hugo.IsProduction) (eq site.Params.env "production") -}}
    {{ partial "google_analytics.html" . }}
  {{- end -}}

  {{- /* LCP image preload: prefer AVIF source; extract only the clean URL */ -}}
  {{- if or .IsHome .Params.hero -}}
    {{- $avifTags := findRE `(?is)<source[^>]+type=\"image/avif\"[^>]+srcset=\"[^\"]+\"` .Content -}}
    {{- $imgTags  := findRE `(?is)<img[^>]+src=\"[^\"]+\"` .Content -}}
    {{- $lcp := "" -}}
    {{- if gt (len $avifTags) 0 -}}
      {{- $first := index $avifTags 0 -}}
      {{- $lcp = replaceRE `(?is).*srcset=\"([^\", ]+).*` "${1}" $first -}}
    {{- else if gt (len $imgTags) 0 -}}
      {{- $first := index $imgTags 0 -}}
      {{- $lcp = replaceRE `(?is).*src=\"([^\"]+).*` "${1}" $first -}}
    {{- end -}}
    {{- with $lcp -}}
      {{- $clean := . | strings.TrimSpace -}}
      {{- if $clean }}
        <link rel="preload" as="image" href="{{ $clean | absURL }}" fetchpriority="high">
      {{- end -}}
    {{- end -}}
  {{- end -}}
    {{- /* LCP preload */ -}}
    {{ partial "lcp-preload.html" . }}

  {{- /* JSON-LD schema (Event and per-page LocalBusiness) */ -}}
  {{ partial "schema.html" . }}
</head>

{{- /* Get shared palette once; use for body + navbar */ -}}
{{- $pal := partial "theme/palette.html" . -}}

<body id="top" class="flowbite-landing {{ $pal.bodyBg }} {{ $pal.bodyText }} transition-colors duration-200 twinkle-bg">
  {{ partial "navbar.html" . }}

  {{- /* If this is the homepage, or the page declares a hero, or uses a landing layout, remove the top pad */ -}}
  {{- $isHeroPage := or .IsHome .Params.hero (eq .Params.layout "landing") -}}
  <main id="content" class="min-h-screen{{ if $isHeroPage }} no-top-pad{{ end }}" data-bg-sync>
    <article class="prose prose-zinc max-w-none dark:prose-invert">
      {{ .Content }}
    </article>
  </main>

  <!-- Flowbite JS for interactive components -->
  <script defer src="{{ "js/flowbite.min.js" | relURL }}"></script>

  <!-- Header toggle (optional):
       If you have a button with id="theme-toggle" (and two icons with
       ids theme-toggle-dark-icon / theme-toggle-light-icon), this flips
       the same data-force-theme attribute the color-picker uses. -->
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      const html      = document.documentElement;
      const btn       = document.getElementById('theme-toggle');
      const darkIcon  = document.getElementById('theme-toggle-dark-icon');
      const lightIcon = document.getElementById('theme-toggle-light-icon');

      function syncIcons() {
        const isDark = html.classList.contains('dark');
        // Show the icon for the state you can switch TO (common UI pattern)
        if (darkIcon)  darkIcon.classList.toggle('hidden', isDark);     // show moon in light mode
        if (lightIcon) lightIcon.classList.toggle('hidden', !isDark);   // show sun in dark mode
      }

      function flipForcedTheme() {
        const forced = html.getAttribute('data-force-theme'); // "light" | "dark" | null
        if (forced === 'dark')      html.setAttribute('data-force-theme', 'light');
        else if (forced === 'light')html.setAttribute('data-force-theme', 'dark');
        else {
          // No override yet: flip away from current OS/effective state
          const isDark = html.classList.contains('dark');
          html.setAttribute('data-force-theme', isDark ? 'light' : 'dark');
        }
        // Head script will react and toggle html.dark; then update icons
        syncIcons();
      }

      // Initial icon state
      syncIcons();

      // Wire the button if present
      if (btn) btn.addEventListener('click', flipForcedTheme);
    });
  </script>

  <!-- Calculate header height and set --site-header-offset so CSS can align anchors correctly -->
  <!-- header offset script removed to restore default CSS behavior -->

  {{/* Footer (supports content/footer.md via partial) */}}
  {{ partialCached "footer.html" . .Layout .Kind (.Param "hideFooter") (.Param "ShowCodeCopyButtons") }}
</body>
</html>
