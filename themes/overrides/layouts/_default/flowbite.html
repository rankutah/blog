{{/* themes/overrides/layouts/_default/flowbite.html */}}
<!DOCTYPE html>
<html class="{{ .Site.Params.primaryColor | default "rose" }}" lang="{{ .Site.Language.Lang }}" dir="{{ .Site.Language.LanguageDirection | default "auto" }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ .Title }} | {{ .Site.Title }}</title>

  <!-- Meta description (page -> site -> summary/content fallback) -->
  <meta name="description" content='{{- with .Params.description -}}
    {{ . | plainify | htmlEscape }}
  {{- else -}}
    {{- with site.Params.description -}}
      {{ . | plainify | htmlEscape }}
    {{- else -}}
      {{- $auto := cond (gt (len .Summary) 0) (.Summary | plainify) (.Content | plainify) -}}
      {{- $clean := replace $auto "\n" " " | replace "\r" " " | truncate 160 -}}
      {{- $clean | htmlEscape -}}
    {{- end -}}
  {{- end -}}'>

  <!-- Dark-mode bootstrap:
       - If <html data-force-theme="dark|light"> is present, use that.
       - Otherwise follow the OS preference.
       - Reacts live to changes of data-force-theme AND (optionally) OS changes when not forced. -->
  <script>
(function(){
  const html = document.documentElement;

  // Static HEX map (light/dark) â€” no Tailwind involvement
  const BRAND_HEX = {
    gray:{light:"#4b5563",dark:"#6b7280"}, neutral:{light:"#525252",dark:"#737373"},
    red:{light:"#dc2626",dark:"#ef4444"}, orange:{light:"#ea580c",dark:"#f97316"},
    amber:{light:"#d97706",dark:"#f59e0b"}, yellow:{light:"#ca8a04",dark:"#eab308"},
    lime:{light:"#65a30d",dark:"#84cc16"}, green:{light:"#16a34a",dark:"#22c55e"},
    emerald:{light:"#059669",dark:"#10b981"}, teal:{light:"#0d9488",dark:"#14b8a6"},
    cyan:{light:"#0891b2",dark:"#06b6d4"}, sky:{light:"#0284c7",dark:"#0ea5e9"},
    blue:{light:"#2563eb",dark:"#3b82f6"}, indigo:{light:"#4f46e5",dark:"#6366f1"},
    violet:{light:"#7c3aed",dark:"#8b5cf6"}, purple:{light:"#9333ea",dark:"#a855f7"},
    fuchsia:{light:"#c026d3",dark:"#d946ef"}, pink:{light:"#db2777",dark:"#ec4899"},
    rose:{light:"#e11d48",dark:"#f43f5e"}
  };

  // Brand on first paint: prefer <html data-brand="..."> set by picker; else first class on <html>; else blue
  const SITE_BRAND = (document.documentElement.getAttribute('data-brand') || (document.documentElement.className || 'blue').split(' ')[0] || 'blue');
  function currentBrand(){
    return (html.getAttribute('data-brand') || SITE_BRAND || "blue").trim();
  }

  // Minimal navbar recolor hook (kept if you still use data-brand-nav markers)
  function recolorNavbar(){
    const isDark = html.classList.contains('dark');
    const pal = BRAND_HEX[currentBrand()] || BRAND_HEX.blue;
    const fg  = isDark ? pal.dark : pal.light;

    // Text color in navbar
    document.querySelectorAll('nav .nav-brand, [data-brand-nav="fg"]').forEach(el => el && (el.style.color = fg));

    // Background accents in navbar (e.g., badges, pills, active underline containers you want solid)
    document.querySelectorAll('nav .nav-brand-bg, [data-brand-nav="bg"]').forEach(el => el && (el.style.backgroundColor = fg));

    // Borders (e.g., active item bottom border)
    document.querySelectorAll('nav .nav-brand-border, [data-brand-nav="border"]').forEach(el => el && (el.style.borderColor = fg));
  }

  function recolorAll(){
    recolorNavbar();
  }

  // Run on first paint
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', recolorAll, { once:true });
  } else {
    recolorAll();
  }

  // Re-run on theme flips (OS or any toggle that adds/removes .dark)
  new MutationObserver(m => {
    for (const x of m) if (x.attributeName === 'class') { recolorAll(); break; }
  }).observe(html, { attributes:true });

  // Listen for brand changes from the picker (you already dispatch this)
  window.addEventListener('cp:brandchange', e => {
    if (e && e.detail) html.setAttribute('data-brand', e.detail);
    recolorAll();
  });
})();
</script>

  <script>
  try {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.classList.toggle('dark', prefersDark);
  } catch (e) {}
</script>

  {{- /* Tailwind + Flowbite CSS via Hugo Pipes + minify + fingerprint (blocking to prevent FOUC) */ -}}
  {{- $css := resources.Get "css/main.css" | postCSS | minify | fingerprint "sha384" }}
  <link rel="preload" as="style" href="{{ $css.RelPermalink }}?v={{ $css.Data.Integrity | urlquery }}" crossorigin="anonymous">
  <link rel="stylesheet"
    href="{{ $css.RelPermalink }}?v={{ $css.Data.Integrity | urlquery }}"
    {{ if $css.Data.Integrity }}integrity="{{ $css.Data.Integrity }}"{{ end }}
    crossorigin="anonymous">

  {{- /* Analytics (match PaperMod behavior: only in production) */ -}}
  {{- if or (hugo.IsProduction) (eq site.Params.env "production") -}}
    {{ partial "google_analytics.html" . }}
  {{- end -}}

  {{- /* Favicons */ -}}
  {{ partial "favicons.html" . }}

  {{- /* LCP preload */ -}}
  {{ partial "lcp-preload.html" . }}

  {{- /* JSON-LD schema (Event and per-page LocalBusiness) */ -}}
  {{ partial "schema.html" . }}
</head>

{{- /* Get shared palette once; use for body + navbar */ -}}
{{- $pal := partial "theme/palette.html" . -}}

<body id="top" class="flowbite-landing {{ $pal.bodyBg }} {{ $pal.bodyText }} transition-colors duration-200 twinkle-bg">
  {{ partial "navbar.html" . }}

  {{- /* If this is the homepage, or the page declares a hero, or uses a landing layout, remove the top pad */ -}}
  {{- $isHeroPage := or .IsHome .Params.hero (eq .Params.layout "landing") -}}
  <main id="content" class="min-h-screen{{ if $isHeroPage }} no-top-pad{{ end }}" data-bg-sync{{ if $isHeroPage }} style="padding-top:0;margin-top:0"{{ end }}>
    <article class="prose prose-zinc max-w-none dark:prose-invert"{{ if $isHeroPage }} style="margin-top:0"{{ end }}>
      {{ .Content }}
    </article>
  </main>

  <!-- Inline tiny UI for navbar collapse/dropdowns (removes JS request chain) -->
  <script type="module">
    function ready(fn){if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn,{once:true});}else{fn();}}
    function initCollapse(){document.querySelectorAll('[data-collapse-toggle]').forEach(btn=>{const id=btn.getAttribute('data-collapse-toggle');const target=id&&document.getElementById(id);if(!target)return;btn.addEventListener('click',()=>{const isHidden=target.classList.toggle('hidden');btn.setAttribute('aria-expanded',String(!isHidden));});});}
    function initDropdowns(){const buttons=Array.from(document.querySelectorAll('[data-dropdown-toggle]'));if(!buttons.length)return;function closeAll(exceptId){buttons.forEach(b=>{const id=b.getAttribute('data-dropdown-toggle');const el=id&&document.getElementById(id);if(!el||id===exceptId)return;el.classList.add('hidden');b.setAttribute('aria-expanded','false');});}
      buttons.forEach(btn=>{const id=btn.getAttribute('data-dropdown-toggle');const menu=id&&document.getElementById(id);if(!menu)return;btn.addEventListener('click',(e)=>{e.stopPropagation();const nowHidden=menu.classList.toggle('hidden');btn.setAttribute('aria-expanded',String(!nowHidden));if(!nowHidden)closeAll(id);});});
      document.addEventListener('click',(e)=>{const inside=e.target.closest&&(e.target.closest('[data-dropdown-toggle]')||e.target.closest('[id^="menu-"]'));if(!inside)closeAll();});}
    ready(()=>{initCollapse();initDropdowns();});
  </script>

  <!-- Header toggle (optional):
       If you have a button with id="theme-toggle" (and two icons with
       ids theme-toggle-dark-icon / theme-toggle-light-icon), this flips
       the same data-force-theme attribute the color-picker uses. -->
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      const html      = document.documentElement;
      const btn       = document.getElementById('theme-toggle');
      const darkIcon  = document.getElementById('theme-toggle-dark-icon');
      const lightIcon = document.getElementById('theme-toggle-light-icon');

      function syncIcons() {
        const isDark = html.classList.contains('dark');
        // Show the icon for the state you can switch TO (common UI pattern)
        if (darkIcon)  darkIcon.classList.toggle('hidden', isDark);     // show moon in light mode
        if (lightIcon) lightIcon.classList.toggle('hidden', !isDark);   // show sun in dark mode
      }

      function flipForcedTheme() {
        const forced = html.getAttribute('data-force-theme'); // "light" | "dark" | null
        if (forced === 'dark')      html.setAttribute('data-force-theme', 'light');
        else if (forced === 'light')html.setAttribute('data-force-theme', 'dark');
        else {
          // No override yet: flip away from current OS/effective state
          const isDark = html.classList.contains('dark');
          html.setAttribute('data-force-theme', isDark ? 'light' : 'dark');
        }
        // Head script will react and toggle html.dark; then update icons
        syncIcons();
      }

      // Initial icon state
      syncIcons();

      // Wire the button if present
      if (btn) btn.addEventListener('click', flipForcedTheme);
    });
  </script>

  <!-- Lazy-load Elfsight only when needed (below-the-fold + gated) -->
  <script>
    (function(){
      var loaded = false;
      function loadElfsight(){
        if (loaded) return; loaded = true;
        var s = document.createElement('script');
        s.src = 'https://static.elfsight.com/platform/platform.js';
        s.async = true;
        document.head.appendChild(s);
      }
      function onIntersect(entries, obs){
        for (var i=0;i<entries.length;i++){
          var e = entries[i];
          if (e.isIntersecting){ loadElfsight(); obs.disconnect(); break; }
        }
      }
      function setup(){
        try {
          var el = document.querySelector('[class^="elfsight-app-"]');
          if (!el) return; // no widget on this page
        } catch { return; }

        // Gate on user interaction OR when the widget comes near viewport
        var once = function(fn){ return function(){ fn();
          window.removeEventListener('scroll', onUser, {passive:true});
          window.removeEventListener('mousemove', onUser);
          window.removeEventListener('touchstart', onUser, {passive:true});
        }};
        var onUser = once(loadElfsight);
        window.addEventListener('scroll', onUser, {passive:true});
        window.addEventListener('mousemove', onUser);
        window.addEventListener('touchstart', onUser, {passive:true});

        // IntersectionObserver for the widget container
        if ('IntersectionObserver' in window){
          try {
            var obs = new IntersectionObserver(onIntersect, { root: null, rootMargin: '400px', threshold: 0.01 });
            document.querySelectorAll('[class^="elfsight-app-"]').forEach(function(node){ obs.observe(node); });
          } catch { /* noop */ }
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setup, { once:true });
      } else { setup(); }
    })();
  </script>

  <!-- Calculate header height and set --site-header-offset so CSS can align anchors correctly -->
  <!-- header offset script removed to restore default CSS behavior -->

  {{/* Footer (supports content/footer.md via partial) */}}
  {{ partialCached "footer.html" . .Layout .Kind (.Param "hideFooter") (.Param "ShowCodeCopyButtons") }}
</body>
</html>
