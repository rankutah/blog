{{- /* Markdown image render hook: responsive srcset (for Page Resources),
     site defaults, and an LCP toggle.

   Optional site defaults (config.toml):
   [params.images]
     defaultClasses = "rounded-lg shadow-sm w-full max-w-2xl mx-auto block object-cover"
     defaultSizes   = "(min-width:1024px) 800px, 100vw"

   Usage:
     ![Alt](carwash.jpg){ .rounded-xl }                         // lazy by default
     ![Hero](hero.jpg){ lcp="true" class="rounded-xl" }         // eager + high priority
     [![Alt](pic.jpg){ .rounded-xl } ](/contact/)               // wrapped link via Markdown
     ![Alt](pic.jpg){ link="/contact/" caption="Caption" }      // link/caption via attrs
*/ -}}

{{- $site       := .Page.Site -}}
{{- $imgParams  := ($site.Params.images | default (dict)) -}}
{{- $defClasses := cond (isset $imgParams "defaultClasses") $imgParams.defaultClasses "" -}}
{{- $defSizes   := cond (isset $imgParams "defaultSizes")   $imgParams.defaultSizes   "100vw" -}}

{{- $alt        := or .Text .Title | default "" -}}
{{- $attrClass  := .Attributes.class | default "" -}}
{{- $class      := strings.TrimSpace (printf "%s %s" $defClasses $attrClass) -}}

{{- $isLCP      := eq (.Attributes.lcp | default "") "true" -}}
{{- $loading    := cond $isLCP "eager" (.Attributes.loading | default "lazy") -}}
{{- $fetchprio  := cond $isLCP "high"  (.Attributes.fetchpriority | default "") -}}
{{- $decoding   := .Attributes.decoding | default "async" -}}
{{- $sizesAttr  := .Attributes.sizes    | default $defSizes -}}
{{- $widthAttr  := .Attributes.width    | default "" -}}
{{- $heightAttr := .Attributes.height   | default "" -}}
{{- $linkAttr   := .Attributes.link     | default "" -}}
{{- $caption    := .Attributes.caption  | default "" -}}

{{- $src        := .Destination -}}
{{- $srcset     := slice -}}
{{- $srcsetAvif := slice -}}
{{- $wHint  := 0 -}}
{{- $hHint  := 0 -}}
{{- $isPR   := false -}}

{{/* Build responsive variants only if the image is a Page Resource; include AVIF srcset too */}}
{{- $match := .Page.Resources.GetMatch (printf "**%s" (path.Base $src)) -}}
{{- if $match -}}
  {{- $isPR = true -}}
  {{- $img := $match -}}
  {{- $origW := $img.Width | default 0 -}}
  {{- $widths := slice 360 720 1080 1440 1920 -}}
  {{- $last := "" -}}
  {{- range $w := $widths -}}
    {{- if or (eq $origW 0) (ge $origW $w) -}}
      {{- $r := $img.Resize (printf "%dx" $w) -}}
      {{- $srcset = $srcset | append (printf "%s %dw" $r.RelPermalink $w) -}}
      {{- $last = $r.RelPermalink -}}
      {{- $ravif := $img.Resize (printf "%dx avif" $w) -}}
      {{- $srcsetAvif = $srcsetAvif | append (printf "%s %dw" $ravif.RelPermalink $w) -}}
    {{- end -}}
  {{- end -}}
  {{- if ne $last "" }}{{ $src = $last }}{{ end -}}
  {{- $wHint = $img.Width | default 0 -}}
  {{- $hHint = $img.Height | default 0 -}}
{{- end -}}

{{- /* If not a Page Resource, try to process static media via assets/media mount */ -}}
{{- $hasStaticAvif := false -}}
{{- $avifPath := "" -}}
{{- if and (not $isPR) (findRE `(^|/)media/[^?#]+\.(jpg|jpeg|png|webp)$` $src) -}}
  {{- /* Normalize leading /, ./, ../ so resources.Get resolves against assets/ mounts */ -}}
  {{- $clean := replaceRE `^(/|\\./|\\\.\./)+` "" $src -}}
  {{- $asset := resources.Get $clean -}}
  {{- if $asset -}}
    {{- $origW := $asset.Width | default 0 -}}
    {{- $widths := slice 360 720 1080 1440 1920 -}}
    {{- $last := "" -}}
    {{- range $w := $widths -}}
      {{- if or (eq $origW 0) (ge $origW $w) -}}
        {{- $r := $asset.Resize (printf "%dx" $w) -}}
        {{- $srcset = $srcset | append (printf "%s %dw" $r.RelPermalink $w) -}}
        {{- $last = $r.RelPermalink -}}
        {{- $ravif := $asset.Resize (printf "%dx avif" $w) -}}
        {{- $srcsetAvif = $srcsetAvif | append (printf "%s %dw" $ravif.RelPermalink $w) -}}
      {{- end -}}
    {{- end -}}
    {{- if ne $last "" }}{{ $src = $last }}{{ end -}}
    {{- $wHint = $asset.Width | default 0 -}}
    {{- $hHint = $asset.Height | default 0 -}}
    {{- $hasStaticAvif = gt (len $srcsetAvif) 0 -}}
  {{- else -}}
    {{- /* Fallback: just reference potential .avif sibling by path */ -}}
    {{- $avifPath = replaceRE `\.(jpg|jpeg|png|webp)$` ".avif" $src -}}
    {{- $hasStaticAvif = true -}}
  {{- end -}}
{{- else if and (not $isPR) (findRE `(^|/)media/[^?#]+\.avif$` $src) -}}
  {{- /* Author linked directly to a static AVIF. We cannot read dimensions from AVIF safely. */ -}}
  {{- $avifPath = $src -}}
  {{- $hasStaticAvif = true -}}
  {{- /* Try to locate a sibling raster file to infer width/height and serve as <img> fallback */ -}}
  {{- /* Normalize leading /, ./, ../ for sibling lookup */ -}}
  {{- $clean := replaceRE `^(/|\\./|\\\.\./)+` "" $src -}}
  {{- $base := replaceRE `\.avif$` "" $clean -}}
  {{- $candidates := slice "jpg" "jpeg" "png" "webp" -}}
  {{- range $ext := $candidates -}}
    {{- if and (eq $wHint 0) (eq $hHint 0) -}}
      {{- $cand := resources.Get (printf "%s.%s" $base $ext) -}}
      {{- if $cand -}}
        {{- /* Set intrinsic dimension hints and use the sibling as the <img> fallback src */ -}}
        {{- $wHint = $cand.Width | default 0 -}}
        {{- $hHint = $cand.Height | default 0 -}}
        {{- $src = $cand.RelPermalink -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Build <img> fallback tag (uses srcset if PR) */ -}}
{{- $imgTag := printf `<img src="%s"%s%s alt="%s"%s%s%s%s loading="%s" decoding="%s" />`
  $src
  (cond (gt (len $srcset) 0) (printf ` srcset="%s"` (delimit $srcset ", ")) "")
  (cond (gt (len $srcset) 0) (printf ` sizes="%s"` $sizesAttr) "")
  (printf "%s" $alt)
  (cond (ne $widthAttr  "") (printf ` width="%s"`  $widthAttr)  (cond (gt $wHint 0) (printf ` width="%d"`  $wHint)  "" ))
  (cond (ne $heightAttr "") (printf ` height="%s"` $heightAttr) (cond (gt $hHint 0) (printf ` height="%d"`  $hHint) "" ))
  (cond (ne $fetchprio  "") (printf ` fetchpriority="%s"` $fetchprio) "")
  (cond (ne $class      "") (printf ` class="%s"`  $class)      "")
  $loading
  $decoding
}}

{{- /* Build either <picture> with AVIF or plain <img> */ -}}
{{- $content := "" -}}
{{- if or (gt (len $srcsetAvif) 0) $hasStaticAvif -}}
  {{- if gt (len $srcsetAvif) 0 -}}
    {{- $content = printf `<picture><source type="image/avif" srcset="%s" sizes="%s" />%s</picture>` (delimit $srcsetAvif ", ") $sizesAttr $imgTag -}}
  {{- else -}}
    {{- $content = printf `<picture><source type="image/avif" srcset="%s" />%s</picture>` $avifPath $imgTag -}}
  {{- end -}}
{{- else -}}
  {{- $content = $imgTag -}}
{{- end -}}

{{- if or (ne $linkAttr "") (ne $caption "") -}}
  <figure>
    {{- if ne $linkAttr "" -}}<a href="{{ $linkAttr }}">{{ end -}}
      {{- $content | safeHTML -}}
    {{- if ne $linkAttr "" -}}</a>{{ end -}}
    {{- if ne $caption "" -}}<figcaption class="mt-2 text-sm text-gray-600 dark:text-gray-400">{{ $caption }}</figcaption>{{ end -}}
  </figure>
{{- else -}}
  {{- $content | safeHTML -}}
{{- end -}}
