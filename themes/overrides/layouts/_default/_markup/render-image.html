{{- /* Markdown image render hook: standardized manifest-based responsive images.
     This routes all Markdown images through the prebuilt derivatives manifest (Option B).

   Optional site defaults (config.toml):
   [params.images]
     defaultClasses = "rounded-lg shadow-sm w-full max-w-2xl mx-auto block object-cover"
     defaultSizes   = "(min-width:1024px) 800px, 100vw"

   Usage:
     ![Alt](carwash.jpg){ .rounded-xl }
     ![Hero](hero.jpg){ lcp="true" class="rounded-xl" }
     [![Alt](pic.jpg){ .rounded-xl } ](/contact/)
     ![Alt](pic.jpg){ link="/contact/" caption="Caption" }
*/ -}}

{{- $site       := .Page.Site -}}
{{- $imgParams  := ($site.Params.imageDefaults | default (dict)) -}}
{{- $defClasses := cond (isset $imgParams "defaultClasses") $imgParams.defaultClasses "" -}}
{{- $defSizes   := cond (isset $imgParams "defaultSizes")   $imgParams.defaultSizes   "100vw" -}}

{{- $alt        := or .Text .Title | default "" -}}
{{- $attrClass  := .Attributes.class | default "" -}}
{{- $class      := strings.TrimSpace (printf "%s %s" $defClasses $attrClass) -}}

{{- $isLCP      := eq (.Attributes.lcp | default "") "true" -}}
{{- $loading    := cond $isLCP "eager" (.Attributes.loading | default "lazy") -}}
{{- $decoding   := .Attributes.decoding | default "async" -}}
{{- $sizesAttr  := .Attributes.sizes    | default $defSizes -}}
{{- $linkAttr   := .Attributes.link     | default "" -}}
{{- $caption    := .Attributes.caption  | default "" -}}
{{- $object     := lower (.Attributes.object | default "cover") -}}
{{- $objectPos  := .Attributes.objectposition | default .Attributes.objectPosition | default "center" -}}

{{- /* Optional: override sizes via semantic class tokens when author hasn't provided sizes */ -}}
{{- if and (eq (.Attributes.sizes | default "") "") (ne $attrClass "") -}}
  {{- $cls := printf " %s " (lower $attrClass) -}}
  {{- if in $cls " img-xs " -}}
    {{- $sizesAttr = "(min-width:1024px) 320px, (min-width:768px) 280px, 90vw" -}}
  {{- else if in $cls " img-sm " -}}
    {{- $sizesAttr = "(min-width:1024px) 420px, (min-width:768px) 360px, 92vw" -}}
  {{- else if in $cls " img-md " -}}
    {{- $sizesAttr = "(min-width:1024px) 560px, (min-width:768px) 480px, 94vw" -}}
  {{- else if in $cls " img-lg " -}}
    {{- $sizesAttr = "(min-width:1536px) 800px, (min-width:1024px) 640px, (min-width:768px) 560px, 96vw" -}}
  {{- else -}}
    {{- /* Heuristic: detect common Tailwind fixed widths (w-16, w-24, w-32, w-48, w-64, w-72, w-80, w-96) and set a fixed sizes value. */ -}}
    {{- $fixedMap := dict "w-16" 64 "w-20" 80 "w-24" 96 "w-28" 112 "w-32" 128 "w-36" 144 "w-40" 160 "w-44" 176 "w-48" 192 "w-56" 224 "w-64" 256 "w-72" 288 "w-80" 320 "w-96" 384 -}}
    {{- range $k, $px := $fixedMap -}}
      {{- if and (eq $sizesAttr $defSizes) (in $cls (printf " %s " $k)) -}}
        {{- $sizesAttr = printf "%dpx" $px -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $src := .Destination -}}
{{- $picture := partial "img.manifest" (dict
    "src" $src
    "alt" $alt
    "class" $class
    "loading" $loading
    "decoding" $decoding
    "sizes" $sizesAttr
    "object" $object
    "objectPosition" $objectPos
  ) -}}

{{- if or (ne $linkAttr "") (ne $caption "") -}}
  <figure>
    {{- if ne $linkAttr "" -}}<a href="{{ $linkAttr }}">{{ end -}}
      {{- $picture | safeHTML -}}
    {{- if ne $linkAttr "" -}}</a>{{ end -}}
    {{- if ne $caption "" -}}<figcaption class="mt-2 text-sm text-gray-600 dark:text-gray-400">{{ $caption }}</figcaption>{{ end -}}
  </figure>
{{- else -}}
  {{- $picture | safeHTML -}}
{{- end -}}
