{{- /* Emits a safe LCP preload link by extracting the hero image and its srcset.
      Prefers AVIF <source> srcset; falls back to first <img src>.
      When AVIF srcset is found, also emits imagesrcset/imagesizes to help early selection.
      Only runs on hero/landing/home pages. */ -}}
{{- $ctx := . -}}
{{- /* Treat plainHome pages (no hero) as non-hero to avoid unnecessary preload */ -}}
{{- $plainHome := or $ctx.Params.plainHome false -}}
{{- $isHeroPage := or (and $ctx.IsHome (not $plainHome)) (or $ctx.Params.hero (eq $ctx.Params.layout "landing")) -}}
{{- /* Also preload when a priority carousel is present on the page */ -}}
{{- $hasPriorityCarousel := gt (len (findRE `(?is)data-priority="1"` $ctx.Content)) 0 -}}
{{- if or $isHeroPage $hasPriorityCarousel -}}
  {{- $html := $ctx.Content -}}
  {{- $avifSourceTags := findRE `(?is)<source[^>]+type="image/avif"[^>]*>` $html -}}
  {{- if gt (len $avifSourceTags) 0 -}}
    {{- $tag := index $avifSourceTags 0 -}}
    {{- $ssm := findRESubmatch `(?is)\bsrcset="([^"]+)"` $tag -}}
    {{- $szm := findRESubmatch `(?is)\bsizes="([^"]+)"` $tag -}}
    {{- $mdm := findRESubmatch `(?is)\bmedia="([^"]+)"` $tag -}}
    {{- $avifSrcset := "" -}}
    {{- $avifSizes := "100vw" -}}
    {{- $media := "" -}}
    {{- if gt (len $ssm) 0 -}}
      {{- $avifSrcset = index (index $ssm 0) 1 -}}
    {{- end -}}
    {{- if gt (len $szm) 0 -}}
      {{- $avifSizes = index (index $szm 0) 1 -}}
    {{- end -}}
    {{- if gt (len $mdm) 0 -}}
      {{- $media = index (index $mdm 0) 1 -}}
    {{- end -}}
    {{- if ne $avifSrcset "" -}}
      {{- $first := index (split $avifSrcset ",") 0 | default "" -}}
      {{- $first = trim $first " \t\n\r" -}}
      {{- $firstParts := split (trim $first " ") " " -}}
      {{- $url := "" -}}
      {{- if gt (len $firstParts) 0 -}}
        {{- $url = trim (index $firstParts 0) " \t\n\r\"'" -}}
      {{- end -}}
      {{- if and (ne $url "") (not (hasPrefix $url "data:")) -}}
        <link rel="preload" as="image" href="{{ $url | absURL }}" fetchpriority="high" imagesrcset="{{ $avifSrcset | safeHTMLAttr }}" imagesizes="{{ $avifSizes | safeHTMLAttr }}"{{ with $media }} media="{{ . | safeHTMLAttr }}"{{ end }}>
      {{- end -}}
    {{- end -}}
  {{- else -}}
    {{- $imgMatches  := findRESubmatch `(?is)<img[^>]+src="([^"]+)"` $html -}}
    {{- $url := "" -}}
    {{- if gt (len $imgMatches) 0 -}}
      {{- $url = trim (index (index $imgMatches 0) 1) " \t\n\r\"'" -}}
    {{- end -}}
    {{- if and (ne $url "") (not (hasPrefix $url "data:")) -}}
      <link rel="preload" as="image" href="{{ $url | absURL }}" fetchpriority="high">
    {{- end -}}
  {{- end -}}
{{- end -}}
