<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
{{- $forceTheme := site.Params.forceTheme | default "" -}}
{{- if eq $forceTheme "light" -}}
<meta name="color-scheme" content="light">
{{- else if eq $forceTheme "dark" -}}
<meta name="color-scheme" content="dark">
{{- else -}}
<meta name="color-scheme" content="light dark">
{{- end -}}
{{- if hugo.IsProduction | or (eq site.Params.env "production") | and (ne .Params.robotsNoIndex true) }}
<meta name="robots" content="index, follow">
{{- else }}
<meta name="robots" content="noindex, nofollow">
{{- end }}

{{- /* Title */}}
<title>{{ if and .Title (ne .Title site.Title) (gt (len (trim .Title " \n\r\t")) 0) }}{{ site.Title }} | {{ .Title }}{{ else }}{{ site.Title }}{{ end }}</title>

{{- /* Meta */}}
{{- if .IsHome }}
  {{ with site.Params.keywords -}}
    <meta name="keywords" content="{{- range $i, $e := . }}{{ if $i }}, {{ end }}{{ $e }}{{ end }}">
  {{ end }}
{{- else }}
  <meta name="keywords" content="{{ if .Params.keywords -}}
      {{- range $i, $e := .Params.keywords }}{{ if $i }}, {{ end }}{{ $e }}{{ end }}{{- else -}}
      {{- range $i, $e := .Params.tags }}{{ if $i }}, {{ end }}{{ $e }}{{ end }}{{- end -}}">
{{- end }}
<meta name="description" content="{{- with .Description }}{{ . }}{{- else }}{{- if or .IsPage .IsSection }}
    {{- .Summary | default (printf "%s - %s" .Title site.Title) }}{{- else }}
    {{- with site.Params.description }}{{ . }}{{- end }}{{- end }}{{- end -}}">
<meta name="author" content="{{ partial "author.html" . }}">
<link rel="canonical" href="{{ if .Params.canonicalURL -}} {{ trim .Params.canonicalURL " " }} {{- else -}} {{ .Permalink }} {{- end }}">
{{- /* Networking hints for GA only when loading immediately (no delay) */}}
{{- $gaDelay := site.Params.analytics.delayMs | default 5000 -}}
{{- $gaImmediate := eq $gaDelay 0 -}}
{{- if $gaImmediate -}}
  {{- with site.Params.analytics.google.id }}
  <link rel="dns-prefetch" href="//www.googletagmanager.com">
  <link rel="dns-prefetch" href="//www.google-analytics.com">
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
  {{- end -}}
{{- end }}
{{- if site.Params.analytics.google.SiteVerificationTag }}
<meta name="google-site-verification" content="{{ site.Params.analytics.google.SiteVerificationTag }}">
{{- end }}
{{- if site.Params.analytics.yandex.SiteVerificationTag }}
<meta name="yandex-verification" content="{{ site.Params.analytics.yandex.SiteVerificationTag }}">
{{- end }}
{{- if site.Params.analytics.bing.SiteVerificationTag }}
<meta name="msvalidate.01" content="{{ site.Params.analytics.bing.SiteVerificationTag }}">
{{- end }}
{{- if site.Params.analytics.naver.SiteVerificationTag }}
<meta name="naver-site-verification" content="{{ site.Params.analytics.naver.SiteVerificationTag }}">
{{- end }}

{{- /* Tailwind + optional compatibility CSS: centralized */}}
{{ partial "styles.html" . }}

{{- /* Local vendored Google Fonts (if configured) */}}
{{ partial "fonts.html" . }}

{{- /* Add taxonomy badge CSS here */}}
{{ partial "taxonomy-badges.html" . }}

{{/* Search page loads its own custom search.js via search-page partial; fastsearch removed. */}}

{{- /* Favicons */}}
{{ partial "favicons.html" . }}
<meta name="theme-color" content="{{ site.Params.assets.theme_color | default "#2e2e33" }}">
<meta name="msapplication-TileColor" content="{{ site.Params.assets.msapplication_TileColor | default "#2e2e33" }}">

{{/* Dark-mode bootstrap: keep html/body in sync with forced attr, saved pref, site default, or OS */}}
<script>
  (function(){
    var html = document.documentElement;
    var defaultTheme = {{ (site.Params.defaultTheme | default "auto") | jsonify | safeJS }}; /* "light" | "dark" | "auto" */

    {{ $themeSiteKey := os.Getenv "HUGO_SITE" }}
    {{ if not $themeSiteKey }}
      {{ $themeHost := "" }}
      {{ with (urls.Parse site.BaseURL) }}
        {{ $themeHost = .Host }}
      {{ end }}
      {{ $titleSlug := urlize site.Title }}
      {{ if and $themeHost $titleSlug }}
        {{ $themeSiteKey = printf "%s|%s" $themeHost $titleSlug }}
      {{ else if $themeHost }}
        {{ $themeSiteKey = $themeHost }}
      {{ else }}
        {{ $themeSiteKey = $titleSlug }}
      {{ end }}
    {{ end }}
    var siteKey = {{ $themeSiteKey | jsonify | safeJS }};
    var storageKey = siteKey ? ('pref-theme:' + siteKey) : 'pref-theme';
    var recoveredKey = siteKey ? ('pref-theme:recovered:' + siteKey) : 'pref-theme:recovered';
    function getStored(){
      try {
        var stored = localStorage.getItem(storageKey);

        // Localhost safety: if a leaked/accidental stored preference forces light in dev,
        // fall back to OS when defaultTheme=auto and no forceTheme is set.
        // This avoids requiring manual localStorage deletion.
        try {
          var host = (window.location && window.location.hostname) ? window.location.hostname : '';
          var isLocal = (host === 'localhost' || host === '127.0.0.1' || host === '0.0.0.0' || host.endsWith('.localhost'));
          var forced = html.getAttribute('data-force-theme');
          var recovered = localStorage.getItem(recoveredKey);
          if (isLocal && recovered !== '1' && !forced && defaultTheme === 'auto' && (stored === 'light' || stored === 'dark')) {
            var osDark = prefersDark();
            if ((osDark && stored === 'light') || (!osDark && stored === 'dark')) {
              localStorage.removeItem(storageKey);
              localStorage.setItem(recoveredKey, '1');
              stored = null;
            }
          }
        } catch(e) {}

        return stored;
      } catch(e){ return null; }
    }
    function prefersDark(){
      try { return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; } catch(e){ return false; }
    }
    function wantDark(){
      var forced = html.getAttribute('data-force-theme');
      if (forced === 'dark') return true;
      if (forced === 'light') return false;

      var stored = getStored();
      if (stored === 'dark') return true;
      if (stored === 'light') return false;

      if (defaultTheme === 'dark') return true;
      if (defaultTheme === 'light') return false;
      return prefersDark();
    }
    function setThemeAttrs(isDark){
      try {
        var v = isDark ? 'dark' : 'light';
        html.setAttribute('data-theme', v);
        if (document.body) document.body.setAttribute('data-theme', v);
      } catch(e){}
    }
    function syncBgClasses(isDark){
      try {
        var lightCls = html.getAttribute('data-bg-light');
        var darkCls  = html.getAttribute('data-bg-dark');

        if (lightCls) html.classList.remove(lightCls);
        if (darkCls)  html.classList.remove(darkCls);
        if (isDark) { if (darkCls) html.classList.add(darkCls); }
        else        { if (lightCls) html.classList.add(lightCls); }

        var body = document.body;
        if (body) {
          if (lightCls) body.classList.remove(lightCls);
          if (darkCls)  body.classList.remove(darkCls);
          if (isDark) { if (darkCls) body.classList.add(darkCls); }
          else        { if (lightCls) body.classList.add(lightCls); }
        }
      } catch(e){}
    }
    function apply(){
      var isDark = wantDark();
      if (isDark) {
        html.classList.add('dark');
        if (document.body) document.body.classList.add('dark');
      } else {
        html.classList.remove('dark');
        if (document.body) document.body.classList.remove('dark');
      }
      setThemeAttrs(isDark);
      syncBgClasses(isDark);
    }

    // Initial apply before CSS to avoid FOUC
    apply();

    // React to changes of data-force-theme
    try {
      new MutationObserver(function(muts){
        for (var i=0;i<muts.length;i++){
          if (muts[i].attributeName === 'data-force-theme') { apply(); break; }
        }
      }).observe(html, { attributes:true });
    } catch(e){}

    // React to OS changes
    try {
      var mql = window.matchMedia('(prefers-color-scheme: dark)');
      if (mql && mql.addEventListener) mql.addEventListener('change', apply);
      else if (mql && mql.addListener) mql.addListener(apply);
    } catch(e){}

    // React to localStorage changes (other tabs)
    try {
      window.addEventListener('storage', function(e){ if (e && e.key === storageKey) apply(); });
    } catch(e){}
  })();
</script>

{{- /* RSS / Alternate links */}}
{{ range .AlternativeOutputFormats -}}
  <link rel="{{ .Rel }}" type="{{ .MediaType.Type }}" href="{{ .Permalink }}">
{{- end -}}
{{- range .AllTranslations -}}
  <link rel="alternate" hreflang="{{ .Lang }}" href="{{ .Permalink }}">
{{- end -}}

<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }
    </style>
    {{- if (and (ne site.Params.forceTheme "light") (ne site.Params.forceTheme "dark") (ne site.Params.defaultTheme "light") (ne site.Params.defaultTheme "dark")) }}
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196,197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }
    </style>
    {{- end }}
</noscript>

{{- partial "extend_head.html" . -}}
{{- /* LCP image preload: prefer AVIF source; only emit if we find a clean URL */ -}}
{{- if or .IsHome .Params.hero -}}
  {{- /* Try to find the first <source type="image/avif" ... srcset="..."> */ -}}
  {{- $avifTags := findRE `(?is)<source[^>]+type=\"image/avif\"[^>]+srcset=\"[^\"]+\"` .Content -}}
  {{- $imgTags  := findRE `(?is)<img[^>]+src=\"[^\"]+\"` .Content -}}
  {{- $lcp := "" -}}
  {{- if or (gt (len $avifTags) 0) (gt (len $imgTags) 0) -}}
    {{- /* LCP preload */ -}}
    {{ partial "lcp-preload.html" . }}
  {{- end -}}
{{- end -}}
{{ partial "schema.html" . }}

{{- /* Misc: analytics & social previews */}}
{{- if hugo.IsProduction | or (eq site.Params.env "production") }}
  {{ partial "google_analytics.html" . }}

  {{- /* Prefer a full-bleed hero/carousel <img>. */ -}}
  {{- $heroImg := replaceRE `(?is).*<img[^>]+class=\"[^\"]*absolute[^\"]*inset-0[^\"]*w-full[^\"]*h-full[^\"]*\"[^>]+src=\"([^\"]+)\".*` "${1}" .Content -}}
  {{- /* Fallback: first <img> anywhere */ -}}
  {{- $firstImg := cond (ne $heroImg "") $heroImg (replaceRE `(?is).*<img[^>]+src=\"([^\"]+)\".*` "${1}" .Content) -}}
  {{- /* Homepage hero via section shortcode img="..." if no <img> found */ -}}
  {{- if and .IsHome (eq $firstImg "") -}}
    {{- $secMatch := findRE `(?is)\{\{<\s*section[^>]*img\s*=\s*\"([^\"]+)\"[^>]*>\}\}` .RawContent -}}
    {{- if gt (len $secMatch) 0 -}}
      {{- $firstImg = replaceRE `(?is).*img\s*=\s*\"([^\"]+)\".*` "${1}" (index $secMatch 0) -}}
    {{- end -}}
  {{- end -}}
  {{- /* Absolute URL for social */ -}}
  {{- if $firstImg -}}
    {{- $ogAbs := cond (hasPrefix $firstImg "http") $firstImg (absURL $firstImg) -}}
    <meta property="og:image" content="{{ $ogAbs }}" />
    <meta name="twitter:image" content="{{ $ogAbs }}" />
  {{- end -}}

  {{- if templates.Exists "partials/templates/opengraph.html" -}}
    {{ partial "templates/opengraph.html" . | safeHTML }}
  {{- end -}}
  {{- if templates.Exists "partials/templates/twitter_cards.html" -}}
    {{ partial "templates/twitter_cards.html" . }}
  {{- end -}}
{{- end -}}
