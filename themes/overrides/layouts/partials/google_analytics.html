{{- /* Build config object from site params (with back-compat) */ -}}
{{- $analytics := site.Params.analytics | default (dict) -}}
{{- $provider := (index $analytics "provider") | default "" -}}
{{- $useZaraz := eq (lower $provider) "zaraz" -}}
{{- $gaConf := (index $analytics "google") | default (dict) -}}
{{- $clarityConf := (index $analytics "clarity") | default (dict) -}}
{{- $adsConf := (index $analytics "googleAds") | default (dict) -}}
{{- $metaConf := (index $analytics "meta") | default (dict) -}}
{{- $gaId := cond (and (isset $gaConf "id") (gt (len (index $gaConf "id")) 0)) (index $gaConf "id") (site.Params.googleAnalyticsID) -}}
{{- $gaEnabled := not (eq (index $gaConf "enabled") false) -}}
{{- $clarityId := (index $clarityConf "id") | default "" -}}
{{- $clarityEnabled := not (eq (index $clarityConf "enabled") false) -}}
{{- $adsId := (index $adsConf "id") | default "" -}}
{{- $adsLabel := (index $adsConf "conversionLabel") | default "" -}}
{{- $adsCombined := (cond (and (ne $adsId "") (ne $adsLabel "")) (printf "%s/%s" $adsId $adsLabel) $adsId) -}}
{{- $adsEnabled := not (eq (index $adsConf "enabled") false) -}}
{{- $metaId := (index $metaConf "id") | default "" -}}
{{- $metaEnabled := not (eq (index $metaConf "enabled") false) -}}
{{- $delayMs := (index $analytics "delayMs") | default 4000 -}}
{{- $events := (index $analytics "loadEvents") | default (slice "scroll" "mousemove" "touchstart") -}}
{{- $onlyOnInteraction := (index $analytics "onlyOnInteraction") | default false -}}
{{- /* LCP-first gating (prioritize CWV over maximum analytics coverage) */ -}}
{{- $lcpGate := (index $analytics "lcpGate") | default true -}}
{{- $lcpMaxWaitMs := (index $analytics "lcpMaxWaitMs") | default 6000 -}}
{{- $lcpQuietWindowMs := (index $analytics "lcpQuietWindowMs") | default 350 -}}
{{- /* Optional per-platform overrides: clarity can be delayed even when global is 0 */ -}}
{{- $clarityDelayMs := (index $analytics "clarityDelayMs") | default nil -}}
{{- $clarityOnlyOnInteraction := (index $analytics "clarityOnlyOnInteraction") | default nil -}}
{{- $debugMode := (index $analytics "debugMode") | default false -}}
{{- /* Optional: enable Google Ads website call conversions (forwarding numbers) */ -}}
{{- $adsPhoneReplace := (index $adsConf "phoneReplace") | default false -}}
{{- $header := site.Params.header | default (dict) -}}
{{- $sitePhone := (index $header "phoneNumber") | default "" -}}

{{- $cfg := dict
  "gaId"        (cond $gaEnabled $gaId "")
  "clarityId"   (cond $clarityEnabled $clarityId "")
  "googleAdsId" (cond $adsEnabled $adsId "")
  "googleAdsCombinedId" (cond $adsEnabled $adsCombined "")
  "metaPixelId" (cond $metaEnabled $metaId "")
  "delayMs"     $delayMs
  "loadEvents"  $events
  "onlyOnInteraction" $onlyOnInteraction
  "lcpGate" $lcpGate
  "lcpMaxWaitMs" $lcpMaxWaitMs
  "lcpQuietWindowMs" $lcpQuietWindowMs
  "clarityDelayMs" $clarityDelayMs
  "clarityOnlyOnInteraction" $clarityOnlyOnInteraction
  "debugMode" $debugMode
  "enableAdsPhoneReplace" (and $adsEnabled $adsPhoneReplace)
  "sitePhoneNumber" $sitePhone
-}}

{{- if $useZaraz -}}
  {{- /*
    Cloudflare Zaraz (manual / delayed loader).

    Important: This only helps if Zaraz is NOT already being auto-injected by Cloudflare.
    If Cloudflare is injecting zaraz/s.js early, disable/pause that in Cloudflare first,
    then let this loader inject it after LCP.

    We intentionally inline a tiny loader (as a module) so it can't 404/redirect and trigger ORB.
    Module scripts are deferred by default.
  */ -}}

  <script>
    // Provide a global so any stray references don't throw if Zaraz is delayed.
    window.zaraz = window.zaraz || {};
  </script>
  <script type="module">
    // Cloudflare-recommended endpoint (same-origin). This is typically less likely to be blocked
    // than the static.cloudflareinsights.com host.
    const ZARAZ_SRC = '/cdn-cgi/zaraz/i.js';
    let loaded = false;

    function inject() {
      if (loaded) return;
      loaded = true;
      // Local/dev: Cloudflare endpoints don't exist, so don't 404-spam.
      try {
        const host = (window.location && window.location.hostname) ? window.location.hostname : '';
        const isLocal = (host === 'localhost' || host === '127.0.0.1' || host === '0.0.0.0' || host.endsWith('.localhost'));
        if (isLocal) return;
      } catch {}
      try {
        if (document.querySelector('script[src*="cloudflareinsights.com/zaraz/"]')) return;
      } catch {}
      try {
        if (document.querySelector('script[src^="/cdn-cgi/zaraz/"]')) return;
      } catch {}

      const s = document.createElement('script');
      s.src = ZARAZ_SRC;
      s.referrerPolicy = 'origin';
      s.async = true;
      document.head.appendChild(s);
    }

    function injectSoon() {
      try {
        if ('requestIdleCallback' in window) requestIdleCallback(inject, { timeout: 2000 });
        else setTimeout(inject, 1);
      } catch {
        setTimeout(inject, 1);
      }
    }

    // Conversions-first: if the user is interacting (likely to click a CTA, call, submit a form),
    // load Zaraz immediately rather than waiting for LCP.
    // This still avoids hurting LCP for "no interaction" users.
    function onConversionIntent() {
      injectSoon();
      try {
        window.removeEventListener('pointerdown', onConversionIntent, true);
        window.removeEventListener('touchstart', onConversionIntent, true);
        window.removeEventListener('click', onConversionIntent, true);
        window.removeEventListener('submit', onConversionIntent, true);
        window.removeEventListener('keydown', onConversionIntent, true);
      } catch {}
    }
    try {
      window.addEventListener('pointerdown', onConversionIntent, { capture: true, passive: true });
      window.addEventListener('touchstart', onConversionIntent, { capture: true, passive: true });
      window.addEventListener('click', onConversionIntent, { capture: true, passive: true });
      window.addEventListener('submit', onConversionIntent, { capture: true, passive: true });
      window.addEventListener('keydown', (e) => {
        const k = e && (e.key || e.code);
        if (k === 'Enter' || k === ' ') onConversionIntent();
      }, { capture: true, passive: true });
    } catch {
      // noop
    }

    // Hard fallback (never wait forever)
    setTimeout(injectSoon, 6000);

    // Prefer: wait for LCP to settle, then inject on idle.
    let quietTimer = null;
    try {
      if ('PerformanceObserver' in window) {
        const po = new PerformanceObserver((list) => {
          // Any LCP update restarts the quiet window.
          for (const _ of list.getEntries()) {
            if (quietTimer) clearTimeout(quietTimer);
            quietTimer = setTimeout(injectSoon, 350);
          }
        });
        po.observe({ type: 'largest-contentful-paint', buffered: true });
      }
    } catch {
      // noop
    }

    // If LCP observer is blocked/restricted, load after window load.
    window.addEventListener('load', () => setTimeout(injectSoon, 1500), { once: true });
  </script>

{{- else -}}


<script id="cp-analytics-config" type="application/json">{{ $cfg | jsonify | safeJS }}</script>
<script>
  // Stubs: safe no-ops that collect calls before real libs load
  window.dataLayer = window.dataLayer || [];
  window.gtag = window.gtag || function(){ window.dataLayer.push(arguments); };
</script>

{{- /* Defer loader JS so it doesn't block first paint / LCP */ -}}
{{- $loader := resources.Get "js/analytics-loader.js" | resources.Minify | resources.Fingerprint -}}
<script src="{{ $loader.RelPermalink }}" defer></script>

{{- end -}}
