{{- /* Build config object from site params (with back-compat) */ -}}
{{- $analytics := site.Params.analytics | default (dict) -}}
{{- $provider := (index $analytics "provider") | default "" -}}
{{- $useZaraz := eq (lower $provider) "zaraz" -}}
{{- $gaConf := (index $analytics "google") | default (dict) -}}
{{- $clarityConf := (index $analytics "clarity") | default (dict) -}}
{{- $adsConf := (index $analytics "googleAds") | default (dict) -}}
{{- $metaConf := (index $analytics "meta") | default (dict) -}}
{{- $gaId := cond (and (isset $gaConf "id") (gt (len (index $gaConf "id")) 0)) (index $gaConf "id") (site.Params.googleAnalyticsID) -}}
{{- $gaEnabled := not (eq (index $gaConf "enabled") false) -}}
{{- $clarityId := (index $clarityConf "id") | default "" -}}
{{- $clarityEnabled := not (eq (index $clarityConf "enabled") false) -}}
{{- $adsId := (index $adsConf "id") | default "" -}}
{{- $adsLabel := (index $adsConf "conversionLabel") | default "" -}}
{{- $adsCombined := (cond (and (ne $adsId "") (ne $adsLabel "")) (printf "%s/%s" $adsId $adsLabel) $adsId) -}}
{{- $adsEnabled := not (eq (index $adsConf "enabled") false) -}}
{{- $metaId := (index $metaConf "id") | default "" -}}
{{- $metaEnabled := not (eq (index $metaConf "enabled") false) -}}
{{- /* NOTE: Hugo's `default`/`with` treat 0 as "empty". Respect explicit 0 values. */ -}}
{{- $delayMs := 4000 -}}
{{- $delayMsRaw := (index $analytics "delayMs") -}}
{{- if ne $delayMsRaw nil -}}
  {{- $delayMs = $delayMsRaw -}}
{{- end -}}
{{- $events := (index $analytics "loadEvents") | default (slice "scroll" "mousemove" "touchstart") -}}
{{- $onlyOnInteraction := (index $analytics "onlyOnInteraction") | default false -}}
{{- /* LCP-first gating (prioritize CWV over maximum analytics coverage) */ -}}
{{- $lcpGate := (index $analytics "lcpGate") | default true -}}
{{- $lcpMaxWaitMs := (index $analytics "lcpMaxWaitMs") | default 6000 -}}
{{- $lcpQuietWindowMs := (index $analytics "lcpQuietWindowMs") | default 350 -}}
{{- /* Optional per-platform overrides: clarity can be delayed even when global is 0 */ -}}
{{- $clarityDelayMs := (index $analytics "clarityDelayMs") | default nil -}}
{{- $clarityOnlyOnInteraction := (index $analytics "clarityOnlyOnInteraction") | default nil -}}
{{- $debugMode := (index $analytics "debugMode") | default false -}}
{{- /* Optional: enable Google Ads website call conversions (forwarding numbers) */ -}}
{{- $adsPhoneReplace := (index $adsConf "phoneReplace") | default false -}}
{{- $header := site.Params.header | default (dict) -}}
{{- $sitePhone := (index $header "phoneNumber") | default "" -}}

{{- $cfg := dict
  "gaId"        (cond $gaEnabled $gaId "")
  "clarityId"   (cond $clarityEnabled $clarityId "")
  "googleAdsId" (cond $adsEnabled $adsId "")
  "googleAdsCombinedId" (cond $adsEnabled $adsCombined "")
  "metaPixelId" (cond $metaEnabled $metaId "")
  "delayMs"     $delayMs
  "loadEvents"  $events
  "onlyOnInteraction" $onlyOnInteraction
  "lcpGate" $lcpGate
  "lcpMaxWaitMs" $lcpMaxWaitMs
  "lcpQuietWindowMs" $lcpQuietWindowMs
  "clarityDelayMs" $clarityDelayMs
  "clarityOnlyOnInteraction" $clarityOnlyOnInteraction
  "debugMode" $debugMode
  "enableAdsPhoneReplace" (and $adsEnabled $adsPhoneReplace)
  "sitePhoneNumber" $sitePhone
-}}

{{- if $useZaraz -}}
  {{- /*
    Cloudflare Zaraz (manual / delayed loader).

    Key: keep JS out of the LCP window.
    So we inject our local Zaraz loader only after LCP settles (or a safe fallback).
  */ -}}

  <script id="cp-analytics-config" type="application/json">{{ $cfg | jsonify | safeJS }}</script>

  {{- $zloader := resources.Get "js/zaraz-loader-advanced.js" | resources.Minify | resources.Fingerprint -}}
  <script>
    (function(){
      var src = {{ $zloader.RelPermalink | jsonify | safeJS }};

      // Use the same LCP gate settings as the main analytics config.
      var cfgEl = document.getElementById('cp-analytics-config');
      var cfg = {};
      try { cfg = cfgEl ? JSON.parse(cfgEl.textContent || '{}') : {}; } catch(e) { cfg = {}; }

      var LCP_GATE = cfg.lcpGate !== false;
      var LCP_MAX_WAIT_MS = parseInt(cfg.lcpMaxWaitMs, 10);
      if (!(LCP_MAX_WAIT_MS >= 0)) LCP_MAX_WAIT_MS = 6000;
      var LCP_QUIET_WINDOW_MS = parseInt(cfg.lcpQuietWindowMs, 10);
      if (!(LCP_QUIET_WINDOW_MS >= 0)) LCP_QUIET_WINDOW_MS = 350;

      var injected = false;
      function inject(){
        if (injected) return;
        injected = true;
        try {
          var s = document.createElement('script');
          s.src = src;
          s.async = true;
          document.head.appendChild(s);
        } catch(e) {}
      }

      function injectSoon(){
        try {
          if ('requestIdleCallback' in window) requestIdleCallback(inject, { timeout: 2000 });
          else setTimeout(inject, 1);
        } catch(e) { setTimeout(inject, 1); }
      }

      if (!LCP_GATE) {
        injectSoon();
        return;
      }

      var quietTimer = null;
      function scheduleQuiet(){
        try { if (quietTimer) clearTimeout(quietTimer); } catch(e) {}
        quietTimer = setTimeout(injectSoon, LCP_QUIET_WINDOW_MS);
      }

      setTimeout(injectSoon, Math.max(0, LCP_MAX_WAIT_MS | 0));
      try { window.addEventListener('load', function(){ setTimeout(injectSoon, 1500); }, { once: true }); } catch(e) {}

      try {
        if ('PerformanceObserver' in window) {
          var po = new PerformanceObserver(function(list){
            var entries = list.getEntries();
            if (entries && entries.length) scheduleQuiet();
          });
          po.observe({ type: 'largest-contentful-paint', buffered: true });
        }
      } catch(e) {}
    })();
  </script>

{{- else -}}


<script id="cp-analytics-config" type="application/json">{{ $cfg | jsonify | safeJS }}</script>
<script>
  // Stubs: safe no-ops that collect calls before real libs load
  window.dataLayer = window.dataLayer || [];
  window.gtag = window.gtag || function(){ window.dataLayer.push(arguments); };
</script>

{{- /*
  Load the local analytics loader AFTER LCP settles.

  NOTE: `defer` prevents blocking, but the loader can still execute before LCP on
  some pages/browsers (especially when LCP is late or LCP entries aren't exposed).
*/ -}}
{{- $loader := resources.Get "js/analytics-loader.js" | resources.Minify | resources.Fingerprint -}}
<script>
  (function(){
    var src = {{ $loader.RelPermalink | jsonify | safeJS }};
    var cfgEl = document.getElementById('cp-analytics-config');
    var cfg = {};
    try { cfg = cfgEl ? JSON.parse(cfgEl.textContent || '{}') : {}; } catch(e) { cfg = {}; }

    var LCP_GATE = cfg.lcpGate !== false;
    var LCP_MAX_WAIT_MS = parseInt(cfg.lcpMaxWaitMs, 10);
    if (!(LCP_MAX_WAIT_MS >= 0)) LCP_MAX_WAIT_MS = 6000;
    var LCP_QUIET_WINDOW_MS = parseInt(cfg.lcpQuietWindowMs, 10);
    if (!(LCP_QUIET_WINDOW_MS >= 0)) LCP_QUIET_WINDOW_MS = 350;

    var injected = false;
    function inject(){
      if (injected) return;
      injected = true;
      try {
        var s = document.createElement('script');
        s.src = src;
        s.async = true;
        document.head.appendChild(s);
      } catch(e) {}
    }

    function injectSoon(){
      try {
        if ('requestIdleCallback' in window) requestIdleCallback(inject, { timeout: 2000 });
        else setTimeout(inject, 1);
      } catch(e) { setTimeout(inject, 1); }
    }

    if (!LCP_GATE) {
      injectSoon();
      return;
    }

    var quietTimer = null;
    function scheduleQuiet(){
      try { if (quietTimer) clearTimeout(quietTimer); } catch(e) {}
      quietTimer = setTimeout(injectSoon, LCP_QUIET_WINDOW_MS);
    }

    // Hard fallback: never wait forever.
    setTimeout(injectSoon, Math.max(0, LCP_MAX_WAIT_MS | 0));

    // If LCP entries are blocked/unavailable, wait until after window load.
    // (This is intentionally conservative to avoid pre-LCP loading on Safari-like engines.)
    try { window.addEventListener('load', function(){ setTimeout(injectSoon, 1500); }, { once: true }); } catch(e) {}

    try {
      if ('PerformanceObserver' in window) {
        var po = new PerformanceObserver(function(list){
          var entries = list.getEntries();
          if (entries && entries.length) scheduleQuiet();
        });
        po.observe({ type: 'largest-contentful-paint', buffered: true });
      }
    } catch(e) {}
  })();
</script>

{{- end -}}
