{{- /* Build config object from site params (with back-compat) */ -}}
{{- $analytics := site.Params.analytics | default (dict) -}}
{{- $gaConf := (index $analytics "google") | default (dict) -}}
{{- $clarityConf := (index $analytics "clarity") | default (dict) -}}
{{- $adsConf := (index $analytics "googleAds") | default (dict) -}}
{{- $metaConf := (index $analytics "meta") | default (dict) -}}
{{- $gaId := cond (and (isset $gaConf "id") (gt (len (index $gaConf "id")) 0)) (index $gaConf "id") (site.Params.googleAnalyticsID) -}}
{{- $gaEnabled := not (eq (index $gaConf "enabled") false) -}}
{{- $clarityId := (index $clarityConf "id") | default "" -}}
{{- $clarityEnabled := not (eq (index $clarityConf "enabled") false) -}}
{{- $adsId := (index $adsConf "id") | default "" -}}
{{- $adsEnabled := not (eq (index $adsConf "enabled") false) -}}
{{- $metaId := (index $metaConf "id") | default "" -}}
{{- $metaEnabled := not (eq (index $metaConf "enabled") false) -}}
{{- $delayMs := (index $analytics "delayMs") | default 4000 -}}
{{- $events := (index $analytics "loadEvents") | default (slice "scroll" "mousemove" "touchstart") -}}

{{- $cfg := dict
  "gaId"        (cond $gaEnabled $gaId "")
  "clarityId"   (cond $clarityEnabled $clarityId "")
  "googleAdsId" (cond $adsEnabled $adsId "")
  "metaPixelId" (cond $metaEnabled $metaId "")
  "delayMs"     $delayMs
  "loadEvents"  $events
-}}


<script id="cp-analytics-config" type="application/json">{{ $cfg | jsonify | safeJS }}</script>
<script>
// 0) Stubs: safe no-ops that collect calls before real libs load
window.dataLayer = window.dataLayer || [];
window.gtag = window.gtag || function(){ window.dataLayer.push(arguments); };

(function(){
  function readConfig(){
    try {
      var el = document.getElementById('cp-analytics-config');
      if (!el) return {};
      return JSON.parse(el.textContent || '{}');
    } catch(e) { return {}; }
  }
  var cfg = readConfig();
  var GA_ID = (cfg.gaId || '').trim();
  var CLARITY_ID = (cfg.clarityId || '').trim();
  var ADS_ID = (cfg.googleAdsId || '').trim();
  var META_ID = (cfg.metaPixelId || '').trim();
  var DELAY_MS = (parseInt(cfg.delayMs, 10) || 4000);
  var LOAD_EVENTS = Array.isArray(cfg.loadEvents) ? cfg.loadEvents : [];

  function ensureGtagLoaded(id){
    if (!id) return;
    // If gtag.js is already on the page, skip injecting again
    if ([].some && Array.prototype.some.call(document.scripts || [], function(s){
      return (s.src||'').indexOf('googletagmanager.com/gtag/js') !== -1;
    })) return;
    var s = document.createElement('script');
    s.async = true;
    s.src = 'https://www.googletagmanager.com/gtag/js?id=' + encodeURIComponent(id);
    document.head.appendChild(s);
  }

  function initGA4(){
    if (!GA_ID) return;
    ensureGtagLoaded(GA_ID);
    try { gtag('js', new Date()); gtag('config', GA_ID); } catch(e) {}
  }

  function initGoogleAds(){
    if (!ADS_ID) return;
    // Make sure gtag script exists even if GA4 is not configured
    ensureGtagLoaded(ADS_ID);
    try { gtag('config', ADS_ID); } catch(e) {}
  }

  function initClarity(){
    if (!CLARITY_ID) return;
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r); t.async=1;
      t.src='https://www.clarity.ms/tag/' + i;
      y=l.getElementsByTagName(r)[0];
      y.parentNode.insertBefore(t,y);
    })(window, document, 'clarity', 'script', CLARITY_ID);
  }

  function initMeta(){
    if (!META_ID) return;
    // fbq stub
    (function(f,b,e,v,n,t,s){
      if(f.fbq) return; n=f.fbq=function(){ n.callMethod? n.callMethod.apply(n,arguments): n.queue.push(arguments) };
      if(!f._fbq) f._fbq=n; n.push=n; n.loaded=!0; n.version='2.0'; n.queue=[];
      t=b.createElement(e); t.async=!0; t.src=v; s=b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t,s);
    })(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
    try { fbq('init', META_ID); fbq('track', 'PageView'); } catch(e) {}
  }

  function loadAll(){
    if (window.__trackingLoaded) return;
    window.__trackingLoaded = true;
    initGA4();
    initGoogleAds();
    initClarity();
    initMeta();
  }

  try { setTimeout(loadAll, Math.max(0, DELAY_MS|0)); } catch(_) { setTimeout(loadAll, 4000); }
  try {
    LOAD_EVENTS.forEach(function(evt){
      if (typeof evt === 'string' && evt) {
        document.addEventListener(evt, loadAll, { once:true, passive:true });
      }
    });
  } catch(_) {}
})();
</script>
