{{- /* Build config object from site params (with back-compat) */ -}}
{{- $analytics := site.Params.analytics | default (dict) -}}
{{- $provider := (index $analytics "provider") | default "" -}}
{{- $useZaraz := eq (lower $provider) "zaraz" -}}
{{- $gaConf := (index $analytics "google") | default (dict) -}}
{{- $clarityConf := (index $analytics "clarity") | default (dict) -}}
{{- $adsConf := (index $analytics "googleAds") | default (dict) -}}
{{- $metaConf := (index $analytics "meta") | default (dict) -}}
{{- $gaId := cond (and (isset $gaConf "id") (gt (len (index $gaConf "id")) 0)) (index $gaConf "id") (site.Params.googleAnalyticsID) -}}
{{- $gaEnabled := not (eq (index $gaConf "enabled") false) -}}
{{- $clarityId := (index $clarityConf "id") | default "" -}}
{{- $clarityEnabled := not (eq (index $clarityConf "enabled") false) -}}
{{- $adsId := (index $adsConf "id") | default "" -}}
{{- $adsLabel := (index $adsConf "conversionLabel") | default "" -}}
{{- $adsCombined := (cond (and (ne $adsId "") (ne $adsLabel "")) (printf "%s/%s" $adsId $adsLabel) $adsId) -}}
{{- $adsEnabled := not (eq (index $adsConf "enabled") false) -}}
{{- $metaId := (index $metaConf "id") | default "" -}}
{{- $metaEnabled := not (eq (index $metaConf "enabled") false) -}}
{{- $delayMs := (index $analytics "delayMs") | default 4000 -}}
{{- $events := (index $analytics "loadEvents") | default (slice "scroll" "mousemove" "touchstart") -}}
{{- $onlyOnInteraction := (index $analytics "onlyOnInteraction") | default false -}}
{{- /* Optional per-platform overrides: clarity can be delayed even when global is 0 */ -}}
{{- $clarityDelayMs := (index $analytics "clarityDelayMs") | default nil -}}
{{- $clarityOnlyOnInteraction := (index $analytics "clarityOnlyOnInteraction") | default nil -}}
{{- $debugMode := (index $analytics "debugMode") | default false -}}
{{- /* Optional: enable Google Ads website call conversions (forwarding numbers) */ -}}
{{- $adsPhoneReplace := (index $adsConf "phoneReplace") | default false -}}
{{- $header := site.Params.header | default (dict) -}}
{{- $sitePhone := (index $header "phoneNumber") | default "" -}}

{{- $cfg := dict
  "gaId"        (cond $gaEnabled $gaId "")
  "clarityId"   (cond $clarityEnabled $clarityId "")
  "googleAdsId" (cond $adsEnabled $adsId "")
  "googleAdsCombinedId" (cond $adsEnabled $adsCombined "")
  "metaPixelId" (cond $metaEnabled $metaId "")
  "delayMs"     $delayMs
  "loadEvents"  $events
  "onlyOnInteraction" $onlyOnInteraction
  "clarityDelayMs" $clarityDelayMs
  "clarityOnlyOnInteraction" $clarityOnlyOnInteraction
  "debugMode" $debugMode
  "enableAdsPhoneReplace" (and $adsEnabled $adsPhoneReplace)
  "sitePhoneNumber" $sitePhone
-}}
{{- if not $useZaraz -}}


<script id="cp-analytics-config" type="application/json">{{ $cfg | jsonify | safeJS }}</script>
<script>
  // Stubs: safe no-ops that collect calls before real libs load
  window.dataLayer = window.dataLayer || [];
  window.gtag = window.gtag || function(){ window.dataLayer.push(arguments); };
</script>

{{- /* Defer loader JS so it doesn't block first paint / LCP */ -}}
{{- $loader := resources.Get "js/analytics-loader.js" | resources.Minify | resources.Fingerprint -}}
<script src="{{ $loader.RelPermalink }}" defer></script>

{{- end -}}
