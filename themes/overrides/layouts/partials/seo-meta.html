{{/*
  SEO meta for Flowbite layout only.
  - Robots meta (index/follow in production unless page opts out)
  - Meta description with strong fallbacks
  - Canonical URL
  - Open Graph + Twitter tags with homepage-first-image fallback

  Description fallback logic:
    1) .Description (front matter)
    2) If .IsHome and .Site.Home.Description is set → use that
    3) Else generate from this page: .Summary (plain) truncated ~160 chars
    4) Final fallback: "<Title> – <Site.Title>"

  OG image fallback logic:
    1) .Params.images (array) | .Params.image | .Params.cover
    2) First image resource in page bundle (best-effort)
    3) First <img src> in this page’s content
    4) First major image on the homepage (parse .Site.Home.Content)
    5) Site logo (as a last resort)
*/}}

{{- $ctx := . -}}
{{- $isProd := or (hugo.IsProduction) (eq site.Params.env "production") -}}

{{/* Robots */}}
{{- if and $isProd (ne .Params.robotsNoIndex true) -}}
<meta name="robots" content="index, follow">
{{- else -}}
<meta name="robots" content="noindex, nofollow">
{{- end -}}

{{/* Helper: plain, trimmed, ~160 chars */}}
{{- $max := 160 -}}

{{/* Site-level homepage description (if provided on home) */}}
{{- $home := site.Home -}}
{{- $homeDesc := "" -}}
{{- with $home.Description -}}
  {{- $homeDesc = trim (plainify (htmlUnescape .)) " \n\r\t" -}}
{{- end -}}

{{/* Page description resolution */}}
{{- $desc := "" -}}
{{- if .Description -}}
  {{- $desc = trim (plainify (htmlUnescape .Description)) " \n\r\t" -}}
{{- else if $homeDesc -}}
  {{- $desc = $homeDesc -}}
{{- else -}}
  {{- $gen := trim (plainify (htmlUnescape (.Summary | default (printf "%s – %s" .Title site.Title)))) " \n\r\t" -}}
  {{- if gt (len $gen) $max -}}
    {{- $desc = printf "%s…" (substr $gen 0 (sub $max 1)) -}}
  {{- else -}}
    {{- $desc = $gen -}}
  {{- end -}}
{{- end -}}
<meta name="description" content="{{ $desc }}">

{{/* Canonical */}}
<link rel="canonical" href="{{ if .Params.canonicalURL }}{{ trim .Params.canonicalURL " " }}{{ else }}{{ replaceRE `index\.html$` `` .Permalink }}{{ end }}">

{{/* --- Open Graph & Twitter --- */}}
{{- $title := cond (and .Title (ne .Title site.Title)) (printf "%s - %s" .Title site.Title) site.Title -}}
{{- $ogtype := cond .IsHome "website" (cond .IsPage "article" "website") -}}

{{/* Resolve OG image with fallbacks (prefer per-page; ensure homepage hero wins) */}}
{{- $img := "" -}}
{{- if .Params.images }}
  {{- $img = index .Params.images 0 -}}
{{- else if .Params.image -}}
  {{- $img = .Params.image -}}
{{- else if .Params.cover -}}
  {{- $img = .Params.cover -}}
{{- else -}}
  {{/* On the homepage, first try to extract the hero image from the section shortcode (img="...") */}}
  {{- if and .IsHome (not $img) -}}
    {{- /* Look for {{< section ... img="/path" ... >}} in the raw Markdown to get the declared hero */ -}}
    {{- $heroMatch := findRE `(?is)\{\{<\s*section[^>]*img\s*=\s*"([^"]+)"[^>]*>\}\}` .RawContent -}}
    {{- if gt (len $heroMatch) 0 -}}
      {{- $img = replaceRE `(?is).*img\s*=\s*"([^"]+)".*` "$1" (index $heroMatch 0) -}}
    {{- end -}}
  {{- end -}}

  {{/* Prefer an eager/fetchpriority=high image within this page (hero/LCP) */}}
  {{- if not $img -}}
    {{- $eager := findRE `(?is)<img[^>]+(?:fetchpriority\s*=\s*"high"|loading\s*=\s*"eager")[^>]*src=\"([^\"]+)\"` .Content -}}
    {{- if gt (len $eager) 0 -}}
      {{- $img = replaceRE `(?is).*src="([^"]+)".*` "$1" (index $eager 0) -}}
    {{- end -}}
  {{- end -}}
  {{/* Try page bundle resources */}}
  {{- with .Resources.GetMatch "*feature*" -}}
    {{- $img = .RelPermalink -}}
  {{- else -}}
    {{- with .Resources.GetMatch "*cover*" -}}
      {{- $img = .RelPermalink -}}
    {{- else -}}
      {{- with .Resources.GetMatch "*hero*" -}}
        {{- $img = .RelPermalink -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- if not $img -}}
    {{/* First <img> in this page content */}}
    {{- $match := findRE `(?is)<img[^>]+src="([^"]+)"` .Content -}}
    {{- if gt (len $match) 0 -}}
      {{- $img = replaceRE `(?is).*<img[^>]+src="([^"]+)".*` "$1" (index $match 0) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if not $img -}}
  {{/* Fallback to homepage first main image */}}
  {{- $homeImg := "" -}}
  {{- /* Prefer eager/high-priority image on home (likely hero) */ -}}
  {{- $homeEager := findRE `(?is)<img[^>]+(?:fetchpriority\s*=\s*\"high\"|loading\s*=\s*\"eager\")[^>]*src=\"([^\"]+)\"` $home.Content -}}
  {{- if gt (len $homeEager) 0 -}}
    {{- $homeImg = replaceRE `(?is).*src=\"([^\"]+)\".*` "$1" (index $homeEager 0) -}}
  {{- else -}}
    {{- /* Fallback: first AVIF source or first <img> */ -}}
    {{- $avif := findRE `(?is)<source[^>]+type=\"image/avif\"[^>]+srcset=\"([^\"]+)\"` $home.Content -}}
    {{- if gt (len $avif) 0 -}}
      {{- $homeImg = replaceRE `(?is).*srcset=\"([^\"]+)\".*` "$1" (index $avif 0) -}}
    {{- end -}}
    {{- if not $homeImg -}}
      {{- $homeImgTags := findRE `(?is)<img[^>]+src=\"([^\"]+)\"` $home.Content -}}
      {{- if gt (len $homeImgTags) 0 -}}
        {{- $homeImg = replaceRE `(?is).*src=\"([^\"]+)\".*` "$1" (index $homeImgTags 0) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- $img = $homeImg -}}
{{- end -}}

{{- if not $img -}}
  {{/* Last resort: site logo if available */}}
  {{- with site.Params.logo -}}
    {{- $img = . -}}
  {{- end -}}
{{- end -}}

{{- if $img -}}
  {{/* Prefer a JPEG for social compatibility (FB/LinkedIn often ignore AVIF). Try to resolve via site images manifest. */}}
  {{- $ogimg := $img -}}
  {{- /* Access data file with a dot in its basename via index() */ -}}
  {{- $data := (index site.Data "images.manifest") -}}
  {{- if $data -}}
    {{- /* Normalize key: strip protocol/host, collapse relative segments, ensure leading slash */ -}}
    {{- $key := $img -}}
    {{- if $key -}}
      {{- $key = (replaceRE "^https?://[^/]+" "" $key) -}}
      {{- $key = (replace $key "../" "") -}}
      {{- $key = (replace $key "./" "") -}}
      {{- if not (hasPrefix $key "/") -}}
        {{- $key = (printf "/%s" $key) -}}
      {{- end -}}
    {{- end -}}
    {{- $entry := index $data $key -}}
    {{- if not $entry -}}
      {{/* Try extension swaps to find manifest entry */}}
      {{- $alt := "" -}}
      {{- if (hasSuffix $key ".avif") -}}
        {{- $alt = replaceRE `\.avif$` `.jpg` $key -}}
      {{- else if (hasSuffix $key ".webp") -}}
        {{- $alt = replaceRE `\.webp$` `.jpg` $key -}}
      {{- else if (hasSuffix $key ".png") -}}
        {{- $alt = replaceRE `\.png$` `.jpg` $key -}}
      {{- else if or (hasSuffix $key ".jpeg") (hasSuffix $key ".jpg") -}}
        {{- $alt = $key -}}
      {{- end -}}
      {{- if $alt -}}
        {{- $entry = index $data $alt -}}
      {{- end -}}
    {{- end -}}
    {{- if not $entry -}}
      {{- /* Try whitespace variants (normal space vs thin space vs NBSP) */ -}}
      {{- $thin := " " -}} {{/* U+202F NARROW NO-BREAK SPACE */}}
      {{- $nbsp := " " -}} {{/* U+00A0 NO-BREAK SPACE */}}
      {{- $alts := slice (replace $key " " $thin) (replace $key " " $nbsp) (replace $key $thin " ") (replace $key $nbsp " ") -}}
      {{- range $i, $ak := $alts -}}
        {{- if and (not $entry) (isset $data $ak) -}}
          {{- $entry = index $data $ak -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
    {{- if not $entry -}}
      {{/* As a robust fallback, try a base-name match across manifest keys (ignore extension). */}}
      {{- $base := replaceRE `(?i)\.(avif|webp|jpe?g|png)$` `` $key -}}
      {{- range $k, $v := $data -}}
        {{- $kb := replaceRE `(?i)\.(avif|webp|jpe?g|png)$` `` $k -}}
        {{- if eq $kb $base -}}
          {{- $entry = $v -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
    {{- if $entry -}}
      {{/* Use map indexing to access nested JSON keys reliably */}}
      {{- $variants := index $entry "variants" -}}
      {{- $jv := cond $variants (index $variants "jpeg") (slice) -}}
      {{- if gt (len $jv) 0 -}}
        {{- $last := index $jv (sub (len $jv) 1) -}}
        {{- $url := index $last "url" -}}
        {{- if $url -}}
          {{- $ogimg = $url -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- $abs := absURL $ogimg -}}
  <meta property="og:image" content="{{ $abs }}">
  <meta name="twitter:image" content="{{ $abs }}">
{{- end -}}

<meta property="og:title" content="{{ $title }}">
<meta property="og:description" content="{{ $desc }}">
<meta property="og:type" content="{{ $ogtype }}">
<meta property="og:url" content="{{ .Permalink }}">
<meta property="og:site_name" content="{{ site.Title }}">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ $title }}">
<meta name="twitter:description" content="{{ $desc }}">
