{{- if not (.Param "hideFooter") }}
<footer class="footer border-t border-[#d5d5d5] dark:border-white/10">
        {{- /* If a Markdown footer page exists at content/footer.md, render it.
                Recommended: set headless: true in front matter to avoid creating a public /footer page. */ -}}
        {{- $footerPage := or (site.GetPage "page" "footer") (site.GetPage "/footer") (site.GetPage "footer") -}}
        {{- if and $footerPage (gt (len (trim $footerPage.Content " \n\r\t")) 0) -}}
            {{- $footerWide := or (.Param "footerWide") (.Site.Params.footerWide) -}}
            <div class="prose prose-sm dark:prose-invert{{ if $footerWide }} max-w-none{{ end }}">
                {{ $footerPage.Content }}
            </div>
        {{- else -}}
            <!-- Default footer (shown when no custom Markdown footer is provided) -->
            <span>
                    © {{ now.Year }}
                    <a href="{{ .Site.Params.clientURL }}" rel="noopener" target="_blank"> {{ .Site.Params.clientName }}</a>
                    •
            </span>
            <span>
                    <a href="https://rankutah.com" rel="noopener" target="_blank">Rank Utah SEO & Web Design</a>
            </span>
        {{- end }}
</footer>
{{- end }}

{{- if (not site.Params.disableScrollToTop) }}
{{- /* Map primaryColor to purge-safe Tailwind classes for the scroll-to-top button */ -}}
{{- $brand := lower (or .Site.Params.primaryColor "blue") -}}
{{- $bg := dict
    "red"      "bg-red-600"
    "orange"   "bg-orange-600"
    "amber"    "bg-amber-500"
    "yellow"   "bg-yellow-500"
    "lime"     "bg-lime-600"
    "green"    "bg-green-600"
    "emerald"  "bg-emerald-600"
    "teal"     "bg-teal-600"
    "cyan"     "bg-cyan-600"
    "sky"      "bg-sky-600"
    "blue"     "bg-blue-600"
    "indigo"   "bg-indigo-600"
    "violet"   "bg-violet-600"
    "purple"   "bg-purple-600"
    "fuchsia"  "bg-fuchsia-600"
    "pink"     "bg-pink-600"
    "rose"     "bg-rose-600"
    "slate"    "bg-slate-700"
    "gray"     "bg-gray-700"
    "zinc"     "bg-zinc-700"
    "neutral"  "bg-neutral-700"
    "stone"    "bg-stone-700"
 -}}
{{- $text := dict
    "yellow"   "text-gray-900"
    "amber"    "text-gray-900"
    "slate"    "text-white"
    "gray"     "text-white"
    "zinc"     "text-white"
    "neutral"  "text-white"
    "stone"    "text-white"
 -}}
{{- $bgCls := (index $bg $brand) | default "bg-blue-600" -}}
{{- $textCls := (index $text $brand) | default "text-white" -}}
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link {{ $bgCls }} {{ $textCls }}" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>
{{- end }}

{{- partial "extend_footer.html" . }}
{{- /* Lazy loader for Cloudflare Turnstile widgets (only injects script when a widget nears viewport) */ -}}
{{- partial "turnstile-loader.html" . }}

{{- $clickTracker := resources.Get "js/click-tracker.js" | minify | fingerprint -}}
{{- $linkifyPhones := resources.Get "js/linkify-phones.js" | minify | fingerprint -}}

{{/*
    Delay low-priority first-party scripts slightly to keep the main thread clear.
    These are enhancements only:
    - click-tracker: analytics event helpers
    - linkify-phones: turns plain-text phone numbers into tel: links
*/}}
<script>
    (function(){
        var DELAY_MS = 4000;

        function injectScript(src, id){
            try {
                if (id && document.getElementById(id)) return;
                var s = document.createElement('script');
                if (id) s.id = id;
                s.src = src;
                s.async = true;
                document.head.appendChild(s);
            } catch(e) {}
        }

        function injectAll(){
            injectScript({{ $clickTracker.RelPermalink | jsonify | safeJS }}, 'cp-click-tracker');
            injectScript({{ $linkifyPhones.RelPermalink | jsonify | safeJS }}, 'cp-linkify-phones');
        }

        function schedule(){
            try {
                if ('requestIdleCallback' in window) requestIdleCallback(injectAll, { timeout: 2000 });
                else setTimeout(injectAll, 1);
            } catch(e) { setTimeout(injectAll, 1); }
        }

        try { setTimeout(schedule, DELAY_MS); } catch(e) { schedule(); }
    })();
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener("click", function (e) {
                        const href = this.getAttribute("href") || "";
                        const raw = href.replace(/^#/, "");
                        const id = decodeURIComponent(raw);
                        const target = document.getElementById(id);
                        if (!id || !target) return; // let browser handle if no target

                        e.preventDefault();

                        // Helper: measure current header height and expose CSS var
                        function setHeaderVar(){
                            var nav = document.querySelector('nav');
                            if (!nav) return;
                            var h = Math.ceil(nav.getBoundingClientRect().height);
                            document.documentElement.style.setProperty('--site-header-h', h + 'px');
                        }

                        const btn = document.querySelector('[data-collapse-toggle="navbar-sticky"]');
                        const menu = document.getElementById('navbar-sticky');
                        const isMobile = window.matchMedia('(max-width: 767.98px)').matches; // Tailwind md breakpoint
                        const menuOpen = !!(menu && !menu.classList.contains('hidden'));

                        function performScroll(){
                            // Recalculate header height before scrolling so scroll-margin-top is correct
                            setHeaderVar();
                            const smoothOk = !window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                            try {
                                target.scrollIntoView(smoothOk ? { behavior: 'smooth', block: 'start' } : { block: 'start' });
                            } catch { target.scrollIntoView(); }
                            if (id === 'top') history.replaceState(null, null, ' ');
                            else history.pushState(null, null, `#${id}`);
                        }

                        if (menuOpen && isMobile) {
                            // Close the mobile menu first so header shrinks, then scroll
                            menu.classList.add('hidden');
                            if (btn) btn.setAttribute('aria-expanded','false');
                            // Also close any open dropdowns inside the menu
                            document.querySelectorAll('[id^="menu-"]').forEach(el=>el.classList.add('hidden'));
                            document.querySelectorAll('[data-dropdown-toggle]').forEach(b=>b.setAttribute('aria-expanded','false'));
                            // Wait a couple frames to ensure layout updates, then scroll
                            requestAnimationFrame(()=>requestAnimationFrame(performScroll));
                        } else {
                            performScroll();
                        }
                }, { passive: false });
        });

</script>

{{- if (not site.Params.disableScrollToTop) }}
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
{{- end }}

{{- if (not site.Params.disableThemeToggle) }}
<script>
    (function(){
        var btn = document.getElementById("theme-toggle");
        if (!btn) return;
                {{- $themeSiteKey := os.Getenv "HUGO_SITE" -}}
                {{- if not $themeSiteKey -}}
                    {{- $themeHost := "" -}}
                    {{- with (urls.Parse site.BaseURL) -}}
                        {{- $themeHost = .Host -}}
                    {{- end -}}
                    {{- $titleSlug := urlize site.Title -}}
                    {{- if and $themeHost $titleSlug -}}
                        {{- $themeSiteKey = printf "%s|%s" $themeHost $titleSlug -}}
                    {{- else if $themeHost -}}
                        {{- $themeSiteKey = $themeHost -}}
                    {{- else -}}
                        {{- $themeSiteKey = $titleSlug -}}
                    {{- end -}}
                {{- end -}}
                var siteKey = {{ $themeSiteKey | jsonify | safeJS }};
        var storageKey = siteKey ? ('pref-theme:' + siteKey) : 'pref-theme';
        btn.addEventListener("click", function(){
            var html = document.documentElement;
                        var stored;
                        try { stored = localStorage.getItem(storageKey); } catch(e){ stored = null; }

                        // Cycle preference: auto -> dark -> light -> auto
                        var current = (stored === 'dark' || stored === 'light') ? stored : 'auto';
                        var next = (current === 'auto') ? 'dark' : (current === 'dark') ? 'light' : 'auto';

                        try {
                                if (next === 'auto') localStorage.removeItem(storageKey);
                                else localStorage.setItem(storageKey, next);
                        } catch(e){}

                        // Apply immediately (bootstrap also applies on load)
                        if (next === 'auto') html.setAttribute('data-force-theme', '');
                        else html.setAttribute('data-force-theme', next);

                        // Minimal immediate sync: set classes/attrs; background sync handled by bootstraps on next paint
                        var makeDark = (next === 'auto')
                            ? (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
                            : (next === 'dark');
                        if (makeDark) {
                                html.classList.add('dark');
                                if (document.body) document.body.classList.add('dark');
                                html.setAttribute('data-theme', 'dark');
                                if (document.body) document.body.setAttribute('data-theme', 'dark');
                        } else {
                                html.classList.remove('dark');
                                if (document.body) document.body.classList.remove('dark');
                                html.setAttribute('data-theme', 'light');
                                if (document.body) document.body.setAttribute('data-theme', 'light');
                        }
        });
    })();
</script>
{{- end }}


{{- if (and (eq .Kind "page") (ne .Layout "archives") (ne .Layout "search") (.Param "ShowCodeCopyButtons")) }}
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '{{- i18n "code_copy" | default "copy" }}';

        function copyingDone() {
            copybutton.innerHTML = '{{- i18n "code_copied" | default "copied!" }}';
            setTimeout(() => {
                copybutton.innerHTML = '{{- i18n "code_copy" | default "copy" }}';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
{{- end }}


<!-- Footer end -->
