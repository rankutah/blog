{{/* optimized-logo.html (robust, standardized sizing)
  Inputs: Logo (string), Class, Alt, Width, Height
  Behavior: Prefer assets/media/logo.* or assets/media/<Logo>.
         If Height provided (>0), generate 1x/2x by height and set width/height attrs to 1x size.
         Else if Width provided (>0), generate 1x/2x by width.
         Else default to 256px width single asset.
         Emit AVIF + JPEG <source>/<img> with density srcset.
         Fallback to static <img> if Hugo resource not found.
*/}}
{{- $ctx   := . -}}
{{- /* Coerce Logo to a safe string to avoid nil/non-string issues */ -}}
{{- $logo  := printf "%v" (or $ctx.Logo "logo.png") -}}
{{- $class := $ctx.Class | default "" -}}
{{- $alt   := $ctx.Alt   | default "logo" -}}
{{- $w     := $ctx.Width | default 0 -}}
{{- $h     := $ctx.Height | default 0 -}}
{{- $style := $ctx.Style | default "" -}}

{{- /* Prefer a concrete raster source via resources.Get (safe checks) */ -}}
{{- $logoRes := "" -}}
{{- $raw := strings.TrimPrefix "/" $logo -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get (printf "media/%s" $raw) -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get $raw -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get "media/logo.png" -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get "media/logo.jpg" -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get "media/logo.jpeg" -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}
{{- if eq $logoRes "" -}}
  {{- /* Do not prefer .webp explicitly; AVIF or raster are preferred */ -}}
{{- end -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get "media/logo.avif" -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}

{{- if ne $logoRes "" -}}
  {{- if eq $logoRes.MediaType.Type "image" -}}
  {{- /* Build density-aware variants based on provided Height or Width */ -}}
  {{- $avif1x := "" -}}
  {{- $avif2x := "" -}}
  {{- $jpeg1x := "" -}}
  {{- $jpeg2x := "" -}}
  {{- $outW := 0 -}}
  {{- $outH := 0 -}}
  {{- if gt (int $h) 0 -}}
    {{- $h1 := int $h -}}
    {{- $h2 := mul $h1 2 -}}
    {{- $avif1x = $logoRes.Fit (printf "x%v avif" $h1) -}}
    {{- $avif2x = $logoRes.Fit (printf "x%v avif" $h2) -}}
    {{- $jpeg1x = $logoRes.Fit (printf "x%v jpg" $h1) -}}
    {{- $jpeg2x = $logoRes.Fit (printf "x%v jpg" $h2) -}}
    {{- $outW = $jpeg1x.Width -}}
    {{- $outH = $h1 -}}
  {{- else if gt (int $w) 0 -}}
    {{- $w1 := int $w -}}
    {{- $w2 := mul $w1 2 -}}
    {{- $avif1x = $logoRes.Fit (printf "%vx avif" $w1) -}}
    {{- $avif2x = $logoRes.Fit (printf "%vx avif" $w2) -}}
    {{- $jpeg1x = $logoRes.Fit (printf "%vx jpg" $w1) -}}
    {{- $jpeg2x = $logoRes.Fit (printf "%vx jpg" $w2) -}}
    {{- $outW = $w1 -}}
    {{- $outH = $jpeg1x.Height -}}
  {{- else -}}
    {{- /* Default single variant, width 256px */ -}}
    {{- $avif1x = $logoRes.Fit "256x avif" -}}
    {{- $jpeg1x = $logoRes.Fit "256x jpg" -}}
    {{- $outW = $jpeg1x.Width -}}
    {{- $outH = $jpeg1x.Height -}}
  {{- end -}}
  <picture>
    {{- if and $avif1x $avif2x -}}
      <source srcset="{{ $avif1x.RelPermalink }} 1x, {{ $avif2x.RelPermalink }} 2x" type="image/avif" />
    {{- else -}}
      <source srcset="{{ $avif1x.RelPermalink }}" type="image/avif" />
    {{- end -}}
    {{- /* JPEG fallback */ -}}
    {{- if and $jpeg1x $jpeg2x -}}
      <source srcset="{{ $jpeg1x.RelPermalink }} 1x, {{ $jpeg2x.RelPermalink }} 2x" type="image/jpeg" />
    {{- else -}}
      <source srcset="{{ $jpeg1x.RelPermalink }}" type="image/jpeg" />
    {{- end -}}
    <img src="{{ $jpeg1x.RelPermalink }}"
         {{- if and $jpeg1x $jpeg2x -}} srcset="{{ $jpeg1x.RelPermalink }} 1x, {{ $jpeg2x.RelPermalink }} 2x"{{- end -}}
         alt="{{ $alt }}"
         class="{{ $class }}"
         width="{{ $outW }}"
         height="{{ $outH }}"
          {{ with $style }}style="{{ . | safeCSS }}"{{ end }}
         loading="eager"
         fetchpriority="high"
         decoding="async" />
  </picture>
  {{- else -}}
  {{- /* Not an image resource: fallback to static path */ -}}
  {{- $raw := strings.TrimPrefix "/" $logo -}}
  {{- $ext := path.Ext $raw -}}
  {{- $stem := strings.TrimSuffix $raw $ext -}}
  {{- $stemMedia := strings.TrimPrefix "media/" $stem -}}
  {{- $avifRes := resources.Get (printf "media/%s.avif" $stemMedia) -}}
  {{- /* No WebP preferred here */ -}}
  {{- $staticAvif := "" -}}
  {{- $staticJpeg := "" -}}
  {{- with $avifRes -}}{{- $staticAvif = .RelPermalink -}}{{- end -}}
  {{- /* Try to find a JPEG sibling for fallback */ -}}
  {{- with resources.Get (printf "media/%s.jpg" $stemMedia) -}}{{- $staticJpeg = .RelPermalink -}}{{- end -}}
  {{- if and (eq $staticJpeg "") (resources.Get (printf "media/%s.jpeg" $stemMedia)) -}}
    {{- $staticJpeg = (resources.Get (printf "media/%s.jpeg" $stemMedia)).RelPermalink -}}
  {{- end -}}
  {{- $outW := 0 -}}
  {{- if gt (int $w) 0 -}}{{- $outW = int $w -}}{{- else if gt (int $h) 0 -}}{{- $outW = int $h -}}{{- end -}}
  {{- if or $staticAvif $staticJpeg -}}
    <picture>
      {{- if $staticAvif -}}<source srcset="{{ $staticAvif }}" type="image/avif" />{{- end -}}
      {{- if $staticJpeg -}}<source srcset="{{ $staticJpeg }}" type="image/jpeg" />{{- end -}}
      <img src="{{ $logo | relURL }}"
           alt="{{ $alt }}"
           class="{{ $class }}"
           {{- if gt $outW 0 }} width="{{ $outW }}"{{- end -}}
           {{- with $h }}{{ if gt (int .) 0 }} height="{{ . }}"{{ end }}{{ end }}
           loading="eager"
           fetchpriority="high"
           decoding="async" />
    </picture>
  {{- else -}}
    <img src="{{ $logo | relURL }}"
         alt="{{ $alt }}"
         class="{{ $class }}"
         {{- if gt $outW 0 }} width="{{ $outW }}"{{- end -}}
         {{ with $h }}{{ if gt (int .) 0 }} height="{{ . }}"{{ end }}{{ end }}
         loading="eager"
         fetchpriority="high"
         decoding="async" />
  {{- end -}}
  {{- end -}}
{{- else -}}
  {{- /* Fallback: static files. Try to serve AVIF/WebP if present alongside the provided Logo path. */ -}}
  {{- $raw := strings.TrimPrefix "/" $logo -}}
  {{- $ext := path.Ext $raw -}}
  {{- $stem := strings.TrimSuffix $raw $ext -}}
  {{- /* Normalize stem for media checks (avoid double 'media/media/...') */ -}}
  {{- $stemMedia := strings.TrimPrefix "media/" $stem -}}
  {{- /* Try media/ mounts via resources to detect AVIF/WebP */ -}}
  {{- $avifRes := resources.Get (printf "media/%s.avif" $stemMedia) -}}
  {{- /* No WebP preferred in static fallback */ -}}
  {{- $staticAvif := "" -}}
  {{- $staticJpeg := "" -}}
  {{- with $avifRes -}}{{- $staticAvif = .RelPermalink -}}{{- end -}}
  {{- with resources.Get (printf "media/%s.jpg" $stemMedia) -}}{{- $staticJpeg = .RelPermalink -}}{{- end -}}
  {{- if and (eq $staticJpeg "") (resources.Get (printf "media/%s.jpeg" $stemMedia)) -}}
    {{- $staticJpeg = (resources.Get (printf "media/%s.jpeg" $stemMedia)).RelPermalink -}}
  {{- end -}}
  {{- /* Compute width attr when only Height is provided (helps PSI). Assumes square if Width unknown. */ -}}
  {{- $outW := 0 -}}
  {{- if gt (int $w) 0 -}}
    {{- $outW = int $w -}}
  {{- else if gt (int $h) 0 -}}
    {{- $outW = int $h -}}
  {{- end -}}
  {{- if or $staticAvif $staticJpeg -}}
    <picture>
      {{- if $staticAvif -}}<source srcset="{{ $staticAvif }}" type="image/avif" />{{- end -}}
      {{- if $staticJpeg -}}<source srcset="{{ $staticJpeg }}" type="image/jpeg" />{{- end -}}
      <img src="{{ $logo | relURL }}"
           alt="{{ $alt }}"
           class="{{ $class }}"
           {{- if gt $outW 0 }} width="{{ $outW }}"{{- end -}}
           {{- with $h }}{{ if gt (int .) 0 }} height="{{ . }}"{{ end }}{{ end }}
           loading="eager"
           fetchpriority="high"
           decoding="async" />
    </picture>
  {{- else -}}
    <img src="{{ $logo | relURL }}"
         alt="{{ $alt }}"
         class="{{ $class }}"
         {{- if gt $outW 0 }} width="{{ $outW }}"{{- end -}}
         {{ with $h }}{{ if gt (int .) 0 }} height="{{ . }}"{{ end }}{{ end }}
         loading="eager"
         fetchpriority="high"
         decoding="async" />
  {{- end -}}
{{- end -}}
