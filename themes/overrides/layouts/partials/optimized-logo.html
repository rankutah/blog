{{/* optimized-logo.html (robust, standardized sizing)
  Inputs: Logo (string), Class, Alt, Width, Height
  Behavior: Prefer assets/media/logo.* or assets/media/<Logo>.
         If Height provided (>0), generate 1x/2x by height and set width/height attrs to 1x size.
         Else if Width provided (>0), generate 1x/2x by width.
         Else default to 256px width single asset.
         Emit AVIF+WebP <source> with density srcset and <img> WebP fallback.
         Fallback to static <img> if Hugo resource not found.
*/}}
{{- $ctx   := . -}}
{{- /* Coerce Logo to a safe string to avoid nil/non-string issues */ -}}
{{- $logo  := printf "%v" (or $ctx.Logo "logo.png") -}}
{{- $class := $ctx.Class | default "" -}}
{{- $alt   := $ctx.Alt   | default "logo" -}}
{{- $w     := $ctx.Width | default 0 -}}
{{- $h     := $ctx.Height | default 0 -}}

{{- /* Prefer a concrete raster source via resources.Get (safe checks) */ -}}
{{- $logoRes := "" -}}
{{- $raw := strings.TrimPrefix "/" $logo -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get (printf "media/%s" $raw) -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get $raw -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get "media/logo.png" -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get "media/logo.jpg" -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get "media/logo.jpeg" -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get "media/logo.webp" -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}
{{- if eq $logoRes "" -}}
  {{- with resources.Get "media/logo.avif" -}}
    {{- if eq .MediaType.Type "image" -}}{{- $logoRes = . -}}{{- end -}}
  {{- end -}}
{{- end -}}

{{- if ne $logoRes "" -}}
  {{- if eq $logoRes.MediaType.Type "image" -}}
  {{- /* Build density-aware variants based on provided Height or Width */ -}}
  {{- $avif1x := "" -}}
  {{- $avif2x := "" -}}
  {{- $webp1x := "" -}}
  {{- $webp2x := "" -}}
  {{- $outW := 0 -}}
  {{- $outH := 0 -}}
  {{- if gt (int $h) 0 -}}
    {{- $h1 := int $h -}}
    {{- $h2 := mul $h1 2 -}}
    {{- $avif1x = $logoRes.Fit (printf "x%v avif" $h1) -}}
    {{- $avif2x = $logoRes.Fit (printf "x%v avif" $h2) -}}
    {{- $webp1x = $logoRes.Fit (printf "x%v webp" $h1) -}}
    {{- $webp2x = $logoRes.Fit (printf "x%v webp" $h2) -}}
    {{- $outW = $webp1x.Width -}}
    {{- $outH = $h1 -}}
  {{- else if gt (int $w) 0 -}}
    {{- $w1 := int $w -}}
    {{- $w2 := mul $w1 2 -}}
    {{- $avif1x = $logoRes.Fit (printf "%vx avif" $w1) -}}
    {{- $avif2x = $logoRes.Fit (printf "%vx avif" $w2) -}}
    {{- $webp1x = $logoRes.Fit (printf "%vx webp" $w1) -}}
    {{- $webp2x = $logoRes.Fit (printf "%vx webp" $w2) -}}
    {{- $outW = $w1 -}}
    {{- $outH = $webp1x.Height -}}
  {{- else -}}
    {{- /* Default single variant, width 256px */ -}}
    {{- $avif1x = $logoRes.Fit "256x avif" -}}
    {{- $webp1x = $logoRes.Fit "256x webp" -}}
    {{- $outW = $webp1x.Width -}}
    {{- $outH = $webp1x.Height -}}
  {{- end -}}
  <picture>
    {{- if and $avif1x $avif2x -}}
      <source srcset="{{ $avif1x.RelPermalink }} 1x, {{ $avif2x.RelPermalink }} 2x" type="image/avif" />
    {{- else -}}
      <source srcset="{{ $avif1x.RelPermalink }}" type="image/avif" />
    {{- end -}}
    {{- if and $webp1x $webp2x -}}
      <source srcset="{{ $webp1x.RelPermalink }} 1x, {{ $webp2x.RelPermalink }} 2x" type="image/webp" />
    {{- else -}}
      <source srcset="{{ $webp1x.RelPermalink }}" type="image/webp" />
    {{- end -}}
    <img src="{{ $webp1x.RelPermalink }}"
         {{- if and $webp1x $webp2x -}} srcset="{{ $webp1x.RelPermalink }} 1x, {{ $webp2x.RelPermalink }} 2x"{{- end -}}
         alt="{{ $alt }}"
         class="{{ $class }}"
         width="{{ $outW }}"
         height="{{ $outH }}"
         loading="eager"
         fetchpriority="high"
         decoding="async" />
  </picture>
  {{- else -}}
  {{- /* Not an image resource: fallback to static path */ -}}
  {{- $raw := strings.TrimPrefix "/" $logo -}}
  {{- $ext := path.Ext $raw -}}
  {{- $stem := strings.TrimSuffix $raw $ext -}}
  {{- $stemMedia := strings.TrimPrefix "media/" $stem -}}
  {{- $avifRes := resources.Get (printf "media/%s.avif" $stemMedia) -}}
  {{- $webpRes := resources.Get (printf "media/%s.webp" $stemMedia) -}}
  {{- $staticAvif := "" -}}
  {{- $staticWebp := "" -}}
  {{- with $avifRes -}}{{- $staticAvif = .RelPermalink -}}{{- end -}}
  {{- with $webpRes -}}{{- $staticWebp = .RelPermalink -}}{{- end -}}
  {{- $outW := 0 -}}
  {{- if gt (int $w) 0 -}}{{- $outW = int $w -}}{{- else if gt (int $h) 0 -}}{{- $outW = int $h -}}{{- end -}}
  {{- if or $staticAvif $staticWebp -}}
    <picture>
      {{- if $staticAvif -}}<source srcset="{{ $staticAvif }}" type="image/avif" />{{- end -}}
      {{- if $staticWebp -}}<source srcset="{{ $staticWebp }}" type="image/webp" />{{- end -}}
      <img src="{{ $logo | relURL }}"
           alt="{{ $alt }}"
           class="{{ $class }}"
           {{- if gt $outW 0 }} width="{{ $outW }}"{{- end -}}
           {{- with $h }}{{ if gt (int .) 0 }} height="{{ . }}"{{ end }}{{ end }}
           loading="eager"
           fetchpriority="high"
           decoding="async" />
    </picture>
  {{- else -}}
    <img src="{{ $logo | relURL }}"
         alt="{{ $alt }}"
         class="{{ $class }}"
         {{- if gt $outW 0 }} width="{{ $outW }}"{{- end -}}
         {{ with $h }}{{ if gt (int .) 0 }} height="{{ . }}"{{ end }}{{ end }}
         loading="eager"
         fetchpriority="high"
         decoding="async" />
  {{- end -}}
  {{- end -}}
{{- else -}}
  {{- /* Fallback: static files. Try to serve AVIF/WebP if present alongside the provided Logo path. */ -}}
  {{- $raw := strings.TrimPrefix "/" $logo -}}
  {{- $ext := path.Ext $raw -}}
  {{- $stem := strings.TrimSuffix $raw $ext -}}
  {{- /* Normalize stem for media checks (avoid double 'media/media/...') */ -}}
  {{- $stemMedia := strings.TrimPrefix "media/" $stem -}}
  {{- /* Try media/ mounts via resources to detect AVIF/WebP */ -}}
  {{- $avifRes := resources.Get (printf "media/%s.avif" $stemMedia) -}}
  {{- $webpRes := resources.Get (printf "media/%s.webp" $stemMedia) -}}
  {{- $staticAvif := "" -}}
  {{- $staticWebp := "" -}}
  {{- with $avifRes -}}{{- $staticAvif = .RelPermalink -}}{{- end -}}
  {{- with $webpRes -}}{{- $staticWebp = .RelPermalink -}}{{- end -}}
  {{- /* Compute width attr when only Height is provided (helps PSI). Assumes square if Width unknown. */ -}}
  {{- $outW := 0 -}}
  {{- if gt (int $w) 0 -}}
    {{- $outW = int $w -}}
  {{- else if gt (int $h) 0 -}}
    {{- $outW = int $h -}}
  {{- end -}}
  {{- if or $staticAvif $staticWebp -}}
    <picture>
      {{- if $staticAvif -}}<source srcset="{{ $staticAvif }}" type="image/avif" />{{- end -}}
      {{- if $staticWebp -}}<source srcset="{{ $staticWebp }}" type="image/webp" />{{- end -}}
      <img src="{{ $logo | relURL }}"
           alt="{{ $alt }}"
           class="{{ $class }}"
           {{- if gt $outW 0 }} width="{{ $outW }}"{{- end -}}
           {{- with $h }}{{ if gt (int .) 0 }} height="{{ . }}"{{ end }}{{ end }}
           loading="eager"
           fetchpriority="high"
           decoding="async" />
    </picture>
  {{- else -}}
    <img src="{{ $logo | relURL }}"
         alt="{{ $alt }}"
         class="{{ $class }}"
         {{- if gt $outW 0 }} width="{{ $outW }}"{{- end -}}
         {{ with $h }}{{ if gt (int .) 0 }} height="{{ . }}"{{ end }}{{ end }}
         loading="eager"
         fetchpriority="high"
         decoding="async" />
  {{- end -}}
{{- end -}}
