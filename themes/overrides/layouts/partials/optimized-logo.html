{{/* optimized-logo.html (robust, standardized sizing)
  Inputs: Logo (string), Class, Alt, Width, Height
  Behavior: Prefer assets/media/logo.* or assets/media/<Logo>.
         If Height provided (>0), generate 1x/2x by height and set width/height attrs to 1x size.
         Else if Width provided (>0), generate 1x/2x by width.
         Else default to 256px width single asset.
         Emit AVIF+WebP <source> with density srcset and <img> WebP fallback.
         Fallback to static <img> if Hugo resource not found.
*/}}
{{- $ctx   := . -}}
{{- $logo  := $ctx.Logo | default "logo.png" -}}
{{- $class := $ctx.Class | default "" -}}
{{- $alt   := $ctx.Alt   | default "logo" -}}
{{- $w     := $ctx.Width | default 0 -}}
{{- $h     := $ctx.Height | default 0 -}}

{{- /* Prefer assets/media/logo.* */ -}}
{{- $logoRes := (index (resources.Match "media/logo.*") 0) -}}
{{- /* If not found, try the configured path under assets/media */ -}}
{{- if not $logoRes -}}
  {{- $raw := strings.TrimPrefix "/" $logo -}}
  {{- $logoRes = resources.Get (printf "media/%s" $raw) -}}
  {{- if not $logoRes -}}
    {{- $logoRes = resources.Get $raw -}}
  {{- end -}}
{{- end -}}

{{- if and $logoRes (eq $logoRes.MediaType.Type "image") -}}
  {{- /* Build density-aware variants based on provided Height or Width */ -}}
  {{- $avif1x := nil -}}
  {{- $avif2x := nil -}}
  {{- $webp1x := nil -}}
  {{- $webp2x := nil -}}
  {{- $outW := 0 -}}
  {{- $outH := 0 -}}
  {{- if gt (int $h) 0 -}}
    {{- $h1 := int $h -}}
    {{- $h2 := mul $h1 2 -}}
    {{- $avif1x = $logoRes.Fit (printf "x%v avif" $h1) -}}
    {{- $avif2x = $logoRes.Fit (printf "x%v avif" $h2) -}}
    {{- $webp1x = $logoRes.Fit (printf "x%v webp" $h1) -}}
    {{- $webp2x = $logoRes.Fit (printf "x%v webp" $h2) -}}
    {{- $outW = $webp1x.Width -}}
    {{- $outH = $h1 -}}
  {{- else if gt (int $w) 0 -}}
    {{- $w1 := int $w -}}
    {{- $w2 := mul $w1 2 -}}
    {{- $avif1x = $logoRes.Fit (printf "%vx avif" $w1) -}}
    {{- $avif2x = $logoRes.Fit (printf "%vx avif" $w2) -}}
    {{- $webp1x = $logoRes.Fit (printf "%vx webp" $w1) -}}
    {{- $webp2x = $logoRes.Fit (printf "%vx webp" $w2) -}}
    {{- $outW = $w1 -}}
    {{- $outH = $webp1x.Height -}}
  {{- else -}}
    {{- /* Default single variant, width 256px */ -}}
    {{- $avif1x = $logoRes.Fit "256x avif" -}}
    {{- $webp1x = $logoRes.Fit "256x webp" -}}
    {{- $outW = $webp1x.Width -}}
    {{- $outH = $webp1x.Height -}}
  {{- end -}}
  <picture>
    {{- if and $avif1x $avif2x -}}
      <source srcset="{{ $avif1x.RelPermalink }} 1x, {{ $avif2x.RelPermalink }} 2x" type="image/avif" />
    {{- else -}}
      <source srcset="{{ $avif1x.RelPermalink }}" type="image/avif" />
    {{- end -}}
    {{- if and $webp1x $webp2x -}}
      <source srcset="{{ $webp1x.RelPermalink }} 1x, {{ $webp2x.RelPermalink }} 2x" type="image/webp" />
    {{- else -}}
      <source srcset="{{ $webp1x.RelPermalink }}" type="image/webp" />
    {{- end -}}
    <img src="{{ $webp1x.RelPermalink }}"
         {{- if and $webp1x $webp2x -}} srcset="{{ $webp1x.RelPermalink }} 1x, {{ $webp2x.RelPermalink }} 2x"{{- end -}}
         alt="{{ $alt }}"
         class="{{ $class }}"
         width="{{ $outW }}"
         height="{{ $outH }}"
         loading="eager"
         fetchpriority="high"
         decoding="async" />
  </picture>
{{- else -}}
  {{- /* Fallback: static files. Try to serve AVIF/WebP if present alongside the provided Logo path. */ -}}
  {{- $raw := strings.TrimPrefix "/" $logo -}}
  {{- $ext := path.Ext $raw -}}
  {{- $stem := strings.TrimSuffix $raw $ext -}}
  {{- /* Normalize stem for media checks (avoid double 'media/media/...') */ -}}
  {{- $stemMedia := strings.TrimPrefix "media/" $stem -}}
  {{- /* Try static root first (e.g., /logo.*) */ -}}
  {{- $staticAvif := cond (fileExists (printf "static/%s.avif" $stem)) (printf "/%s.avif" $stem | relURL) "" -}}
  {{- $staticWebp := cond (fileExists (printf "static/%s.webp" $stem)) (printf "/%s.webp" $stem | relURL) "" -}}
  {{- /* Also try media/ mounts (served at /media/*) */ -}}
  {{- if not $staticAvif -}}
    {{- if fileExists (printf "media/%s.avif" $stemMedia) -}}
      {{- $staticAvif = (printf "/media/%s.avif" $stemMedia) | relURL -}}
    {{- end -}}
  {{- end -}}
  {{- if not $staticWebp -}}
    {{- if fileExists (printf "media/%s.webp" $stemMedia) -}}
      {{- $staticWebp = (printf "/media/%s.webp" $stemMedia) | relURL -}}
    {{- end -}}
  {{- end -}}
  {{- /* Compute width attr when only Height is provided (helps PSI). Assumes square if Width unknown. */ -}}
  {{- $outW := 0 -}}
  {{- if gt (int $w) 0 -}}
    {{- $outW = int $w -}}
  {{- else if gt (int $h) 0 -}}
    {{- $outW = int $h -}}
  {{- end -}}
  {{- if or $staticAvif $staticWebp -}}
    <picture>
      {{- if $staticAvif -}}<source srcset="{{ $staticAvif }}" type="image/avif" />{{- end -}}
      {{- if $staticWebp -}}<source srcset="{{ $staticWebp }}" type="image/webp" />{{- end -}}
      <img src="{{ $logo | relURL }}"
           alt="{{ $alt }}"
           class="{{ $class }}"
           {{- if gt $outW 0 }} width="{{ $outW }}"{{- end -}}
           {{- with $h }}{{ if gt (int .) 0 }} height="{{ . }}"{{ end }}{{ end }}
           loading="eager"
           fetchpriority="high"
           decoding="async" />
    </picture>
  {{- else -}}
    <img src="{{ $logo | relURL }}"
         alt="{{ $alt }}"
         class="{{ $class }}"
         {{- if gt $outW 0 }} width="{{ $outW }}"{{- end -}}
         {{ with $h }}{{ if gt (int .) 0 }} height="{{ . }}"{{ end }}{{ end }}
         loading="eager"
         fetchpriority="high"
         decoding="async" />
  {{- end -}}
{{- end -}}
