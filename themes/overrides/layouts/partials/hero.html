{{/*
  Partial: hero.html
  Renders a hero (full-bleed or in-container) with optional overlay and responsive images.
  Accepts a dict with keys:
    - page        : . (Hugo page context) [required]
    - image       : string (path to image) [required]
    - alt         : string
    - bleed       : bool (full-bleed when true)
    - overlay     : bool
    - overlayShade: string (e.g., "bg-black/40")
    - imgClasses  : string (tailwind classes)
    - imgStyle    : string (inline style)
    - vh          : string ("vh" | "svh" | "dvh")
    - brighten    : string ("sm"|"md"|"lg"|"true")
    - max         : string (sm|md|lg|xl|2xl|full)
    - pad         : string (none|sm|md|lg)
    - align       : string (start|center)
    - alignY      : string (start|center|end|between)
    - minh        : string (screen|full|"")
*/}}
{{- $p := . -}}
{{- $page := $p.page -}}
{{- $img  := ($p.image | default "") -}}
{{- if eq $img "" -}}{{- return -}}{{- end -}}

{{- /* Optional responsive hero sources */ -}}
{{- $imgDesktop := ($p.imageDesktop | default "") -}}
{{- $imgMobile  := ($p.imageMobile  | default "") -}}

{{- $alt         := $p.alt | default "" -}}
{{- $bleed       := cond (ne $img "") (or ($p.bleed | default false) false) false -}}
{{- $overlay     := $p.overlay | default false -}}
{{- $overlayShade:= $p.overlayShade | default "" -}}
{{- $overlayPos  := lower ($p.overlayPos | default "") -}}
{{- $imgClasses  := $p.imgClasses | default "block w-full h-64 md:h-80 lg:h-96 object-cover" -}}
{{- $imgStyle    := $p.imgStyle   | default "" -}}
{{- $vhMode      := lower ($p.vh | default "") -}}
{{- $vhHeightRaw := printf "%v" ($p.vhHeight | default "100") -}}
{{- $vhHeight    := cond (gt (len (findRE `^[0-9]+(?:\.[0-9]+)?$` $vhHeightRaw)) 0) $vhHeightRaw "100" -}}
{{- $brighten    := lower ($p.brighten | default "") -}}

{{- /* Optional explicit dimensions (reduces layout work; helps LCP stability) */ -}}
{{- $imgW := 0 -}}
{{- $imgH := 0 -}}

{{- $defs := $page.Site.Params.section.defaults | default (dict) -}}
{{- $defMax   := (index $defs "max")   | default "xl" -}}
{{- $defPad   := (index $defs "pad")   | default "lg" -}}
{{- $defAlign := (index $defs "align") | default "start" -}}
{{- $defAlignY:= (index $defs "alignY")| default "" -}}
{{- $defMinh  := (index $defs "minh")  | default "" -}}

{{- $max     := $p.max    | default $defMax -}}
{{- $pad     := $p.pad    | default $defPad -}}
{{- $padMobile := $p.padMobile | default "" -}}
{{- $align   := $p.align  | default $defAlign -}}
{{- $alignY  := $p.alignY | default $defAlignY -}}
{{- $minh    := $p.minh   | default $defMinh -}}

{{- $maxMap := dict "sm" "max-w-screen-sm" "md" "max-w-3xl" "lg" "max-w-5xl" "xl" "max-w-7xl" "2xl" "max-w-screen-2xl" "full" "max-w-none" -}}
{{- $padMap := dict "none" "px-0" "sm" "px-4" "md" "px-6" "lg" "px-8" "xl" "px-12" "2xl" "px-16" -}}
{{- $alMap  := dict "start" "text-left" "center" "text-center" -}}
{{- $alignYMap := dict "" "" "start" "justify-start" "center" "justify-center" "end" "justify-end" "between" "justify-between" -}}

{{- /* Brighten convenience → default overlay shade when not provided */ -}}
{{- if and (ne $brighten "") (eq $overlayShade "") -}}
  {{- $overlay = true -}}
  {{- $level := cond (or (eq $brighten "true") (eq $brighten "md")) "20" (cond (eq $brighten "sm") "10" (cond (eq $brighten "lg") "30" "")) -}}
  {{- if ne $level "" -}}
    {{- $overlayShade = printf "bg-white/%s" $level -}}
  {{- else -}}
    {{- $overlayShade = "bg-white/20" -}}
  {{- end -}}
{{- end -}}

{{- /* Accessibility: if overlay is enabled but no shade was provided, default to a dark scrim. */ -}}
{{- if and $overlay (eq $overlayShade "") -}}
  {{- $overlayShade = "bg-black/55" -}}
{{- end -}}

{{- /* If the overlay shade is light (e.g. brighten uses bg-white/..), keep dark text; otherwise invert text. */ -}}
{{- $overlayIsLight := and $overlay (in $overlayShade "bg-white") -}}
{{- $overlayProse := "prose prose-zinc max-w-none dark:prose-invert" -}}
{{- if and $overlay (not $overlayIsLight) -}}
  {{- /* Avoid forcing headings to white via utilities; allow per-heading overrides like {.text-black}. */ -}}
  {{- $overlayProse = "prose max-w-none prose-invert text-white prose-a:text-white" -}}
{{- end -}}

{{- /* If author provided a vh-based inline height, append svh so it wins on mobile */ -}}
{{- $hasVhInStyle := and (ne $imgStyle "") (gt (len (findRE `\b[0-9.]+vh\b` $imgStyle)) 0) -}}
{{- if and (ne $img "") $hasVhInStyle -}}
  {{- $svhStyle := replaceRE `([0-9.]+)vh` `${1}svh` $imgStyle -}}
  {{- $imgStyle = printf "%s; %s" $imgStyle $svhStyle -}}
{{- end -}}
{{- $vhDisabled := or (eq $vhMode "none") (or (eq $vhMode "off") (eq $vhMode "auto")) -}}
{{- if and (eq $vhMode "") (ne $img "") -}}
  {{- $vhMode = "svh" -}}
{{- end -}}
{{- if and (ne $vhMode "") (not $vhDisabled) (ne $img "") -}}
  {{- if eq $vhMode "svh" -}}
    {{- $imgStyle = printf "height: %svh; height: %ssvh;%s" $vhHeight $vhHeight (cond (ne $imgStyle "") (printf " %s" $imgStyle) "") -}}
  {{- else if eq $vhMode "dvh" -}}
    {{- $imgStyle = printf "height: %svh; height: %sdvh;%s" $vhHeight $vhHeight (cond (ne $imgStyle "") (printf " %s" $imgStyle) "") -}}
  {{- else if eq $vhMode "vh" -}}
    {{- $imgStyle = printf "height: %svh;%s" $vhHeight (cond (ne $imgStyle "") (printf " %s" $imgStyle) "") -}}
  {{- end -}}
{{- end -}}

{{- /* Overlay positioning (defaults to vertically centered). */ -}}
{{- $overlayWrapClass := "absolute inset-0 flex items-center" -}}
{{- $overlayWrapStyle := "" -}}
{{- if or (eq $overlayPos "mobilebottom") (eq $overlayPos "mobile-bottom") (eq $overlayPos "mobile_bottom") (eq $overlayPos "bottommobile") (eq $overlayPos "bottom-mobile") (eq $overlayPos "bottom_mobile") -}}
  {{- /* Mobile: bottom align; Desktop: keep centered. */ -}}
  {{- $overlayWrapClass = "absolute inset-0 flex items-end md:items-center pb-6 md:pb-0" -}}
{{- else if or (eq $overlayPos "bottom") (eq $overlayPos "stickbottom") (eq $overlayPos "stick-bottom") (eq $overlayPos "pinnedbottom") (eq $overlayPos "pinned-bottom") -}}
  {{- $overlayWrapClass = "absolute inset-0 flex items-end" -}}
  {{- /* Pin to bottom with a little breathing room + safe-area inset. */ -}}
  {{- $overlayWrapStyle = "padding-bottom: max(env(safe-area-inset-bottom), 1.5rem);" -}}
{{- else if or (eq $overlayPos "lowerthird") (eq $overlayPos "lower-third") (eq $overlayPos "lower_third") (eq $overlayPos "bottomthird") (eq $overlayPos "bottom-third") -}}
  {{- $overlayWrapClass = "absolute inset-0 flex items-end" -}}
  {{- /* Lift up from bottom so content sits in the lower third (optional). */ -}}
  {{- $overlayWrapStyle = "padding-bottom: 33vh; padding-bottom: 33svh;" -}}
{{- end -}}

{{- $padClass := (index $padMap $pad | default "px-8") -}}
{{- if ne $padMobile "" -}}
  {{- $padM := (index $padMap $padMobile | default "px-0") -}}
  {{- $padClass = printf "%s md:%s" $padM $padClass -}}
{{- end -}}

{{- $mobileBleed := eq (lower (printf "%v" $padMobile)) "none" -}}

{{- /* Overlay content padding: keep image edge-to-edge on mobile, but give overlay text site-like margins. */ -}}
{{- $overlayPadClass := $padClass -}}
{{- if and $overlay $mobileBleed -}}
  {{- $overlayPadClass = replaceRE `^px-0\b` `px-4` $overlayPadClass -}}
{{- end -}}

{{- $overlayContainer := printf "%s mx-auto %s"
    (index $maxMap $max | default "max-w-7xl")
    $overlayPadClass
-}}

{{- $motionEnabled := $page.Site.Params.motion.enabled | default false -}}

{{- $container := printf "%s mx-auto %s %s"
    (index $maxMap $max   | default "max-w-7xl")
    $padClass
    (index $alMap  $align | default "text-left")
-}}
{{- $vWrap := "" -}}
{{- if or (ne $alignY "") (ne $minh "") -}}
  {{- $vWrap = printf "flex flex-col w-full %s %s"
        (cond (eq $minh "screen") "min-h-screen" (cond (eq $minh "full") "min-h-full" ""))
        (index $alignYMap $alignY | default "")
  -}}
{{- end -}}

{{- /* Image rendering:
      - default: shared manifest pipeline
      - responsive: if imageDesktop+imageMobile are provided, emit a single <picture>
        with media conditions so desktop picks desktop and mobile picks mobile.
        This avoids relying on CSS show/hide (which can double-download). */ -}}
{{- $imgStr := $img | safeURL -}}
{{- $sizes := "100vw" -}}

{{- $heroImg := "" -}}

{{- $hasResponsive := and (ne $imgDesktop "") (ne $imgMobile "") -}}
{{- if $hasResponsive -}}
  {{- $m := index site.Data "images.manifest" -}}

  {{- $thin := " " -}} {{/* U+202F NARROW NO-BREAK SPACE */}}
  {{- $nbsp := " " -}} {{/* U+00A0 NO-BREAK SPACE */}}

  {{- /* resolve desktop entry */ -}}
  {{- $keyD := (replaceRE "^https?://[^/]+" "" $imgDesktop) -}}
  {{- $keyD = (replace $keyD "../" "") -}}
  {{- $keyD = (replace $keyD "./" "") -}}
  {{- if not (hasPrefix $keyD "/") -}}{{- $keyD = (printf "/%s" $keyD) -}}{{- end -}}
  {{- $entryD := (cond $m (index $m $keyD) nil) -}}
  {{- if not $entryD -}}
    {{- $alts := slice (replace $keyD " " $thin) (replace $keyD " " $nbsp) (replace $keyD $thin " ") (replace $keyD $nbsp " ") -}}
    {{- range $i, $alt := $alts -}}
      {{- if and (not $entryD) $m (isset $m $alt) -}}
        {{- $entryD = index $m $alt -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- if not $entryD -}}
    {{- if (hasSuffix $keyD ".jpg") -}}
      {{- $altKey := replace $keyD ".jpg" ".avif" -}}
      {{- if and $m (isset $m $altKey) -}}{{- $entryD = index $m $altKey -}}{{- end -}}
    {{- else if (hasSuffix $keyD ".jpeg") -}}
      {{- $altKey := replace $keyD ".jpeg" ".avif" -}}
      {{- if and $m (isset $m $altKey) -}}{{- $entryD = index $m $altKey -}}{{- end -}}
    {{- else if (hasSuffix $keyD ".avif") -}}
      {{- $altKey := replace $keyD ".avif" ".jpg" -}}
      {{- if and $m (isset $m $altKey) -}}{{- $entryD = index $m $altKey -}}{{- end -}}
    {{- end -}}
  {{- end -}}

  {{- /* resolve mobile entry */ -}}
  {{- $keyM := (replaceRE "^https?://[^/]+" "" $imgMobile) -}}
  {{- $keyM = (replace $keyM "../" "") -}}
  {{- $keyM = (replace $keyM "./" "") -}}
  {{- if not (hasPrefix $keyM "/") -}}{{- $keyM = (printf "/%s" $keyM) -}}{{- end -}}
  {{- $entryM := (cond $m (index $m $keyM) nil) -}}
  {{- if not $entryM -}}
    {{- $alts := slice (replace $keyM " " $thin) (replace $keyM " " $nbsp) (replace $keyM $thin " ") (replace $keyM $nbsp " ") -}}
    {{- range $i, $alt := $alts -}}
      {{- if and (not $entryM) $m (isset $m $alt) -}}
        {{- $entryM = index $m $alt -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- if not $entryM -}}
    {{- if (hasSuffix $keyM ".jpg") -}}
      {{- $altKey := replace $keyM ".jpg" ".avif" -}}
      {{- if and $m (isset $m $altKey) -}}{{- $entryM = index $m $altKey -}}{{- end -}}
    {{- else if (hasSuffix $keyM ".jpeg") -}}
      {{- $altKey := replace $keyM ".jpeg" ".avif" -}}
      {{- if and $m (isset $m $altKey) -}}{{- $entryM = index $m $altKey -}}{{- end -}}
    {{- else if (hasSuffix $keyM ".avif") -}}
      {{- $altKey := replace $keyM ".avif" ".jpg" -}}
      {{- if and $m (isset $m $altKey) -}}{{- $entryM = index $m $altKey -}}{{- end -}}
    {{- end -}}
  {{- end -}}

  {{- /* If both entries are present, build a responsive <picture>. Otherwise, fall back to normal manifest rendering. */ -}}
  {{- if and $entryD $entryM -}}
    {{- $avifD := $entryD.variants.avif | default slice -}}
    {{- $jpegD := $entryD.variants.jpeg | default slice -}}
    {{- $avifM := $entryM.variants.avif | default slice -}}
    {{- $jpegM := $entryM.variants.jpeg | default slice -}}

    {{- $avifSrcsetD := "" -}}
    {{- range $i, $v := $avifD -}}
      {{- $avifSrcsetD = printf "%s%s%s %vw" $avifSrcsetD (cond (gt $i 0) ", " "") ($v.url | safeURL) $v.w -}}
    {{- end -}}
    {{- $jpegSrcsetD := "" -}}
    {{- range $i, $v := $jpegD -}}
      {{- $jpegSrcsetD = printf "%s%s%s %vw" $jpegSrcsetD (cond (gt $i 0) ", " "") ($v.url | safeURL) $v.w -}}
    {{- end -}}
    {{- $avifSrcsetM := "" -}}
    {{- range $i, $v := $avifM -}}
      {{- $avifSrcsetM = printf "%s%s%s %vw" $avifSrcsetM (cond (gt $i 0) ", " "") ($v.url | safeURL) $v.w -}}
    {{- end -}}
    {{- $jpegSrcsetM := "" -}}
    {{- range $i, $v := $jpegM -}}
      {{- $jpegSrcsetM = printf "%s%s%s %vw" $jpegSrcsetM (cond (gt $i 0) ", " "") ($v.url | safeURL) $v.w -}}
    {{- end -}}

    {{- $wM := $entryM.width | default 0 -}}
    {{- $hM := $entryM.height | default 0 -}}
    {{- $srcFallbackM := (cond (gt (len $jpegM) 0) (index $jpegM (sub (len $jpegM) 1)).url ($imgMobile | safeURL)) -}}

    {{- /* Only include a default object-position if author didn't provide one (e.g. object-[75%_50%]). */ -}}
    {{- $hasObjPos := gt (len (findRE `\bobject-(?:left|right|center|top|bottom|\[[^\]]+\])\b` $imgClasses)) 0 -}}
    {{- $objPosClass := cond $hasObjPos "" " object-center" -}}
    {{- $classes := (printf "object-cover%s not-prose %s" $objPosClass $imgClasses) -}}
    {{- $fetchpri := "high" -}}

    {{- $hasHeightInStyle := and (ne $imgStyle "") (gt (len (findRE `\b[0-9.]+(?:vh|svh|dvh)\b` $imgStyle)) 0) -}}
    {{- $pictureStyleAttr := "" -}}
    {{- $imgStyleAttr := "" -}}
    {{- if $hasHeightInStyle -}}
      {{- $pictureStyleAttr = "display:block;" -}}
      {{- $imgStyleAttr = $imgStyle -}}
    {{- else -}}
      {{- $pictureStyleAttr = (cond (ne $imgStyle "") (printf "display:block; %s" $imgStyle) "display:block;") -}}
    {{- end -}}

    {{- $mediaDesktop := "(min-width: 768px)" -}}
    {{- $mediaMobile := "(max-width: 767.98px)" -}}

    {{- $heroImg = "" -}}
    {{- $heroImg = printf "%s<picture style=\"%s\">" $heroImg ($pictureStyleAttr | safeCSS) -}}
    {{- if ne $avifSrcsetD "" -}}
      {{- $heroImg = printf "%s<source media=\"%s\" type=\"image/avif\" srcset=\"%s\" sizes=\"%s\">" $heroImg $mediaDesktop ($avifSrcsetD | safeHTMLAttr) $sizes -}}
    {{- end -}}
    {{- if ne $jpegSrcsetD "" -}}
      {{- $heroImg = printf "%s<source media=\"%s\" srcset=\"%s\" sizes=\"%s\">" $heroImg $mediaDesktop ($jpegSrcsetD | safeHTMLAttr) $sizes -}}
    {{- end -}}
    {{- if ne $avifSrcsetM "" -}}
      {{- $heroImg = printf "%s<source media=\"%s\" type=\"image/avif\" srcset=\"%s\" sizes=\"%s\">" $heroImg $mediaMobile ($avifSrcsetM | safeHTMLAttr) $sizes -}}
    {{- end -}}
    {{- if ne $jpegSrcsetM "" -}}
      {{- $heroImg = printf "%s<source media=\"%s\" srcset=\"%s\" sizes=\"%s\">" $heroImg $mediaMobile ($jpegSrcsetM | safeHTMLAttr) $sizes -}}
    {{- end -}}

    {{- $imgStyleFrag := cond (ne $imgStyleAttr "") (printf " style=\"%s\"" ($imgStyleAttr | safeCSS)) "" -}}
    {{- $srcsetFrag := cond (ne $jpegSrcsetM "") (printf " srcset=\"%s\"" ($jpegSrcsetM | safeHTMLAttr)) "" -}}
    {{- $dimFrag := cond (and $wM $hM) (printf " width=\"%v\" height=\"%v\"" $wM $hM) "" -}}
    {{- $heroImg = printf "%s<img src=\"%s\" alt=\"%s\" loading=\"eager\" decoding=\"async\" fetchpriority=\"%s\" sizes=\"%s\"%s%s%s class=\"block %s\"></picture>" $heroImg ($srcFallbackM | safeURL) ($alt | htmlEscape) $fetchpri $sizes $srcsetFrag $dimFrag $imgStyleFrag $classes -}}
  {{- end -}}
{{- end -}}

{{- if eq $heroImg "" -}}
  {{- /* default single-image manifest rendering */ -}}
  {{- $hasObjPos := gt (len (findRE `\bobject-(?:left|right|center|top|bottom|\[[^\]]+\])\b` $imgClasses)) 0 -}}
  {{- $objPosParam := cond $hasObjPos "custom" "center" -}}
  {{- $heroImg = partial "img.manifest" (dict
      "src" $imgStr
      "alt" $alt
      "class" (printf "not-prose %s" $imgClasses)
      "loading" "eager"
      "decoding" "async"
      "sizes" $sizes
      "style" $imgStyle
      "object" "cover"
      "objectPosition" $objPosParam
    ) -}}
{{- end -}}

{{- if $bleed -}}
  <div class="section hero bleed{{ if $mobileBleed }} mobile-bleed{{ end }}">
    <div class="relative left-1/2 right-1/2 ml-[-50vw] mr-[-50vw] w-screen">
      <div class="not-prose">{{- $heroImg | safeHTML -}}</div>
      {{- if $overlay -}}
        <div class="{{ $overlayWrapClass }}"{{ with $overlayWrapStyle }} style="{{ . | safeCSS }}"{{ end }}>
          {{- if $overlayShade }}<div class="absolute inset-0 {{ $overlayShade }}"></div>{{- end }}
          <div class="relative z-10 w-full {{ $overlayContainer }}"{{ if $motionEnabled }} data-motion="hero"{{ end }}>
            <div class="{{ $vWrap }}">
              <div class="{{ $overlayProse }} {{ (index $alMap $align | default "text-left") }}">
                {{- $page.Scratch.Get "heroInner" -}}
              </div>
            </div>
          </div>
        </div>
      {{- end }}
    </div>
  </div>
{{- else -}}
  <div class="section hero{{ if $mobileBleed }} mobile-bleed{{ end }}">
    <div class="{{ $container }}">
      <div class="relative">
        <div class="not-prose">{{- $heroImg | safeHTML -}}</div>
        {{- if $overlay -}}
          <div class="{{ $overlayWrapClass }}"{{ with $overlayWrapStyle }} style="{{ . | safeCSS }}"{{ end }}>
            {{- if $overlayShade }}<div class="absolute inset-0 {{ $overlayShade }}"></div>{{- end }}
            <div class="relative z-10 w-full {{ $overlayContainer }}"{{ if $motionEnabled }} data-motion="hero"{{ end }}>
              <div class="{{ $vWrap }}">
                <div class="{{ $overlayProse }} {{ (index $alMap $align | default "text-left") }}">
                  {{- $page.Scratch.Get "heroInner" -}}
                </div>
              </div>
            </div>
          </div>
        {{- end }}
      </div>
    </div>
  </div>
{{- end -}}
