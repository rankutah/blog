{{- /* Determine if this page is an Event (via startDate) */ -}}
{{- $isEvent := .Params.startDate -}}

{{- /* Grab the first <img> src from the rendered body HTML for schema fallbacks */ -}}
{{- $firstImg := replaceRE `(?is).*<img[^>]+src="([^"]+)".*` "${1}" .Content -}}

{{- /* Collect LocalBusiness config from page params (preferred keys) */ -}}
{{- $lb := false -}}
{{- with .Params.schema.localBusiness -}}
  {{- $lb = . -}}
{{- end -}}
{{- if not $lb -}}
  {{- with .Params.localBusiness -}}
    {{- $lb = . -}}
  {{- end -}}
{{- end -}}

{{- /* Helper: get value from a map key safely */ -}}
{{- $lbEnabled := false -}}
{{- if $lb -}}
  {{- if (or (eq (printf "%T" $lb) "bool") (eq (printf "%T" $lb) "string")) -}}
    {{- /* Boolean or string true */ -}}
    {{- $lbEnabled = or (eq $lb true) (eq (lower (printf "%v" $lb)) "true") -}}
  {{- else -}}
    {{- /* Map/object: require enabled=true if present; if not present, treat as enabled */ -}}
    {{- $lbEnabled = or (and (isset $lb "enabled") (index $lb "enabled")) (not (isset $lb "enabled")) -}}
  {{- end -}}
{{- end -}}

{{/* -------------------- Output Event schema (if present) -------------------- */}}
{{- if $isEvent -}}
<script type="application/ld+json">
{{- $event := dict "@context" "https://schema.org" "@type" "Event" "name" .Title "url" .Permalink -}}
{{- with .Params.startDate -}}
  {{- $event = merge $event (dict "startDate" .) -}}
{{- end -}}
{{- with .Params.endDate -}}
  {{- $event = merge $event (dict "endDate" .) -}}
{{- end -}}
{{- $loc := dict "@type" "Place" -}}
{{- with .Params.locationName -}}
  {{- $loc = merge $loc (dict "name" .) -}}
{{- end -}}
{{- with .Params.locationAddress -}}
  {{- $loc = merge $loc (dict "address" .) -}}
{{- end -}}
{{- $event = merge $event (dict "location" $loc) -}}
{{- $img := (cond (ne $firstImg "") $firstImg (cond .Params.image (.Params.image | relURL) "")) -}}
{{- if $img -}}
  {{- $event = merge $event (dict "image" (slice $img)) -}}
{{- end -}}
{{- $desc := (or (.Summary | htmlUnescape) (.Params.body | plainify)) -}}
{{- if $desc -}}
  {{- $event = merge $event (dict "description" $desc) -}}
{{- end -}}
{{ $event | jsonify | safeJS }}
</script>
{{- end -}}

{{/* --------------- Output LocalBusiness schema (opt-in) ---------------- */}}
{{- if $lbEnabled -}}
<script type="application/ld+json">
{{- $s := newScratch -}}
{{- $type := "LocalBusiness" -}}
{{- if (and (ne (printf "%T" $lb) "bool") (isset $lb "type")) -}}
  {{- $type = (index $lb "type") -}}
{{- end -}}

{{- $name := .Title -}}
{{- if (and (ne (printf "%T" $lb) "bool") (isset $lb "name")) -}}
  {{- $name = (index $lb "name") -}}
{{- else if .Site.Title -}}
  {{- $name = cond (ne .Title "") .Title .Site.Title -}}
{{- end -}}

{{- $obj := dict "@context" "https://schema.org" "@type" $type "@id" .Permalink "url" .Permalink "name" $name -}}

{{- /* image/logo fallbacks: prefer explicit, else page image, else first content image */ -}}
{{- $image := "" -}}
{{- if (and (ne (printf "%T" $lb) "bool") (isset $lb "image")) -}}
  {{- $image = (index $lb "image") -}}
{{- else if .Params.image -}}
  {{- $image = (.Params.image | relURL) -}}
{{- else if $firstImg -}}
  {{- $image = $firstImg -}}
{{- end -}}
{{- if $image -}}
  {{- $obj = merge $obj (dict "image" (slice $image)) -}}
{{- end -}}

{{- if (and (ne (printf "%T" $lb) "bool") (isset $lb "logo")) -}}
  {{- $lbLogo := (index $lb "logo") -}}
  {{- if eq (printf "%T" $lbLogo) "string" -}}
    {{- if not (findRE "^https?://" $lbLogo) -}}
      {{- $lbLogo = $lbLogo | absURL -}}
    {{- end -}}
  {{- end -}}
  {{- $obj = merge $obj (dict "logo" $lbLogo) -}}
{{- end -}}

{{- /* phone & priceRange */ -}}
{{- $phone := "" -}}
{{- if (and (ne (printf "%T" $lb) "bool") (isset $lb "telephone")) -}}
  {{- $phone = (index $lb "telephone") -}}
{{- else if .Site.Params.header.phoneNumber -}}
  {{- $phone = .Site.Params.header.phoneNumber -}}
{{- end -}}
{{- if $phone -}}
  {{- $obj = merge $obj (dict "telephone" $phone) -}}
{{- end -}}
{{- with (and (ne (printf "%T" $lb) "bool") (index $lb "priceRange")) -}}
  {{- $obj = merge $obj (dict "priceRange" .) -}}
{{- end -}}

{{- /* address */ -}}
{{- if (and (ne (printf "%T" $lb) "bool") (isset $lb "address")) -}}
  {{- $addr := (index $lb "address") -}}
  {{- if $addr -}}
    {{- $paddr := dict "@type" "PostalAddress" -}}
    {{- with (index $addr "streetAddress") -}}
      {{- $paddr = merge $paddr (dict "streetAddress" .) -}}
    {{- end -}}
    {{- with (index $addr "addressLocality") -}}
      {{- $paddr = merge $paddr (dict "addressLocality" .) -}}
    {{- end -}}
    {{- with (index $addr "addressRegion") -}}
      {{- $paddr = merge $paddr (dict "addressRegion" .) -}}
    {{- end -}}
    {{- with (index $addr "postalCode") -}}
      {{- $paddr = merge $paddr (dict "postalCode" .) -}}
    {{- end -}}
    {{- with (index $addr "addressCountry") -}}
      {{- $paddr = merge $paddr (dict "addressCountry" .) -}}
    {{- end -}}
    {{- $obj = merge $obj (dict "address" $paddr) -}}
  {{- end -}}
{{- end -}}

{{- /* geo */ -}}
{{- if (and (ne (printf "%T" $lb) "bool") (isset $lb "geo")) -}}
  {{- $geo := (index $lb "geo") -}}
  {{- if $geo -}}
    {{- $g := dict "@type" "GeoCoordinates" -}}
    {{- with (or (index $geo "lat") (index $geo "latitude")) -}}
      {{- $g = merge $g (dict "latitude" .) -}}
    {{- end -}}
    {{- with (or (index $geo "lng") (index $geo "longitude")) -}}
      {{- $g = merge $g (dict "longitude" .) -}}
    {{- end -}}
    {{- $obj = merge $obj (dict "geo" $g) -}}
  {{- end -}}
{{- end -}}

{{- /* openingHoursSpecification: pass-through array of objects if provided */ -}}
{{- if (and (ne (printf "%T" $lb) "bool") (isset $lb "openingHoursSpecification")) -}}
  {{- $oh := (index $lb "openingHoursSpecification") -}}
  {{- if $oh -}}
    {{- $obj = merge $obj (dict "openingHoursSpecification" $oh) -}}
  {{- end -}}
{{- end -}}

{{- /* sameAs, areaServed, hasMap, aggregateRating (optional pass-throughs) */ -}}
{{- with (and (ne (printf "%T" $lb) "bool") (index $lb "sameAs")) -}}
  {{- $obj = merge $obj (dict "sameAs" .) -}}
{{- end -}}
{{- with (and (ne (printf "%T" $lb) "bool") (index $lb "areaServed")) -}}
  {{- $obj = merge $obj (dict "areaServed" .) -}}
{{- end -}}
{{- with (and (ne (printf "%T" $lb) "bool") (index $lb "hasMap")) -}}
  {{- $obj = merge $obj (dict "hasMap" .) -}}
{{- end -}}
{{- with (and (ne (printf "%T" $lb) "bool") (index $lb "aggregateRating")) -}}
  {{- $obj = merge $obj (dict "aggregateRating" .) -}}
{{- end -}}
{{- with (and (ne (printf "%T" $lb) "bool") (index $lb "review")) -}}
  {{- $obj = merge $obj (dict "review" .) -}}
{{- end -}}

{{ $obj | jsonify | safeJS }}
</script>
{{- end -}}

{{/* --------------- Organization schema (site-wide) ---------------- */}}
{{- $org := false -}}
{{- with site.Params.schema.organization -}}
  {{- if or (and (isset . "enabled") (index . "enabled")) (not (isset . "enabled")) -}}
    {{- $org = . -}}
  {{- end -}}
{{- end -}}
{{- if not $org -}}
  {{- /* Auto Organization schema when not explicitly configured, using site title + logo if present */ -}}
  {{- $autoLogo := "" -}}
  {{- with site.Params.logo -}}
    {{- $autoLogo = (printf "%v" .) -}}
  {{- end -}}
  {{- if $autoLogo -}}
    {{- $org = dict "name" site.Title "logo" $autoLogo -}}
  {{- end -}}
{{- end -}}
{{- if $org -}}
<script type="application/ld+json">
{{- $o := dict "@context" "https://schema.org" "@type" "Organization" "@id" (printf "%s#organization" site.BaseURL) "url" site.BaseURL -}}
{{- with (index $org "name") -}}{{- $o = merge $o (dict "name" .) -}}{{- end -}}
{{- with (index $org "legalName") -}}{{- $o = merge $o (dict "legalName" .) -}}{{- end -}}
{{- with (index $org "logo") -}}
  {{- $orgLogo := . -}}
  {{- if eq (printf "%T" $orgLogo) "string" -}}
    {{- if not (findRE "^https?://" $orgLogo) -}}
      {{- $orgLogo = $orgLogo | absURL -}}
    {{- end -}}
  {{- end -}}
  {{- $o = merge $o (dict "logo" $orgLogo) -}}
{{- end -}}
{{- with (index $org "sameAs") -}}{{- $o = merge $o (dict "sameAs" .) -}}{{- end -}}
{{ $o | jsonify | safeJS }}
</script>
{{- end -}}

{{/* --------------- Service schema (per-page opt-in) ---------------- */}}
{{- $svc := false -}}
{{- with .Params.schema.service -}}
  {{- if or (and (isset . "enabled") (index . "enabled")) (not (isset . "enabled")) -}}
    {{- $svc = . -}}
  {{- end -}}
{{- end -}}
{{- if $svc -}}
<script type="application/ld+json">
{{- $sobj := dict "@context" "https://schema.org" "@type" "Service" "@id" (printf "%s#%s-service" .Permalink (.File.BaseFileName)) "url" .Permalink -}}
{{- with (index $svc "serviceType") -}}{{- $sobj = merge $sobj (dict "serviceType" .) -}}{{- end -}}
{{- with (index $svc "description") -}}{{- $sobj = merge $sobj (dict "description" .) -}}{{- else -}}{{- $sobj = merge $sobj (dict "description" (.Summary | default .Description)) -}}{{- end -}}
{{- with (index $svc "areaServed") -}}{{- $sobj = merge $sobj (dict "areaServed" .) -}}{{- end -}}
{{- with (index $svc "provider") -}}{{- $sobj = merge $sobj (dict "provider" (dict "@id" (index $svc "provider"))) -}}{{- else -}}
  {{- if $org -}}{{- $sobj = merge $sobj (dict "provider" (dict "@id" (printf "%s#organization" site.BaseURL))) -}}{{- end -}}
{{- end -}}
{{- with (index $svc "offers") -}}{{- $sobj = merge $sobj (dict "offers" .) -}}{{- end -}}
{{ $sobj | jsonify | safeJS }}
</script>
{{- end -}}

{{/* --------------- Product schema (per-page opt-in) ---------------- */}}
{{- $product := false -}}
{{- with .Params.schema.product -}}
  {{- if or (and (isset . "enabled") (index . "enabled")) (not (isset . "enabled")) -}}
    {{- $product = . -}}
  {{- end -}}
{{- end -}}
{{- if $product -}}
<script type="application/ld+json">
{{- $p := dict "@context" "https://schema.org" "@type" "Product" "@id" (printf "%s#product" .Permalink) "url" .Permalink -}}

{{- $pName := "" -}}
{{- with (index $product "name") -}}
  {{- $pName = . -}}
{{- end -}}
{{- if not $pName -}}
  {{- $pName = .Title -}}
{{- end -}}
{{- $p = merge $p (dict "name" $pName) -}}

{{- $pDesc := "" -}}
{{- with (index $product "description") -}}
  {{- $pDesc = . -}}
{{- else -}}
  {{- with .Params.description -}}
    {{- $pDesc = . -}}
  {{- else -}}
    {{- $pDesc = (.Summary | default .Description | plainify) -}}
  {{- end -}}
{{- end -}}
{{- if $pDesc -}}
  {{- $p = merge $p (dict "description" $pDesc) -}}
{{- end -}}

{{- /* images: support image/images (string or array), or fall back to page image or first content img */ -}}
{{- $imgs := slice -}}
{{- $imgSrc := "" -}}
{{- with (index $product "image") -}}
  {{- $imgSrc = . -}}
{{- else -}}
  {{- with (index $product "images") -}}
    {{- $imgSrc = . -}}
  {{- end -}}
{{- end -}}
{{- if $imgSrc -}}
  {{- if eq (printf "%T" $imgSrc) "string" -}}
    {{- $img := $imgSrc -}}
    {{- if not (findRE "^https?://" $img) -}}
      {{- $img = $img | absURL -}}
    {{- end -}}
    {{- $imgs = $imgs | append $img -}}
  {{- else -}}
    {{- range $imgSrc -}}
      {{- $img := . -}}
      {{- if and (eq (printf "%T" $img) "string") (not (findRE "^https?://" $img)) -}}
        {{- $img = $img | absURL -}}
      {{- end -}}
      {{- $imgs = $imgs | append $img -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- if and (eq (len $imgs) 0) .Params.image -}}
  {{- $imgs = $imgs | append (.Params.image | absURL) -}}
{{- end -}}
{{- if and (eq (len $imgs) 0) $firstImg -}}
  {{- $img := $firstImg -}}
  {{- if not (findRE "^https?://" $img) -}}
    {{- $img = $img | absURL -}}
  {{- end -}}
  {{- $imgs = $imgs | append $img -}}
{{- end -}}
{{- if gt (len $imgs) 0 -}}
  {{- $p = merge $p (dict "image" $imgs) -}}
{{- end -}}

{{- with (index $product "sku") -}}
  {{- $p = merge $p (dict "sku" .) -}}
{{- end -}}

{{- /* brand: allow string or pass-through object */ -}}
{{- with (index $product "brand") -}}
  {{- if eq (printf "%T" .) "string" -}}
    {{- $p = merge $p (dict "brand" (dict "@type" "Brand" "name" .)) -}}
  {{- else -}}
    {{- $p = merge $p (dict "brand" .) -}}
  {{- end -}}
{{- end -}}

{{- /* offers: include only if configured */ -}}
{{- with (index $product "offers") -}}
  {{- $o := . -}}
  {{- if $o -}}
    {{- $offer := dict "@type" "Offer" -}}
    {{- with (index $o "url") -}}
      {{- $url := . -}}
      {{- if and (eq (printf "%T" $url) "string") (not (findRE "^https?://" $url)) -}}
        {{- $url = $url | absURL -}}
      {{- end -}}
      {{- $offer = merge $offer (dict "url" $url) -}}
    {{- else -}}
      {{- $offer = merge $offer (dict "url" $.Permalink) -}}
    {{- end -}}
    {{- with (index $o "price") -}}{{- $offer = merge $offer (dict "price" .) -}}{{- end -}}
    {{- with (index $o "priceCurrency") -}}{{- $offer = merge $offer (dict "priceCurrency" .) -}}{{- end -}}
    {{- with (index $o "availability") -}}{{- $offer = merge $offer (dict "availability" .) -}}{{- end -}}
    {{- with (index $o "itemCondition") -}}{{- $offer = merge $offer (dict "itemCondition" .) -}}{{- end -}}
    {{- with (index $o "priceValidUntil") -}}{{- $offer = merge $offer (dict "priceValidUntil" .) -}}{{- end -}}

    {{- /* shippingDetails / merchantReturnPolicy: optional pass-through objects */ -}}
    {{- with (index $o "shippingDetails") -}}
      {{- $offer = merge $offer (dict "shippingDetails" .) -}}
    {{- end -}}
    {{- with (index $o "hasMerchantReturnPolicy") -}}
      {{- $mrp := . -}}
      {{- $mrpOut := dict -}}

      {{- with (or (index $mrp "@type") (index $mrp "@Type")) -}}
        {{- $mrpOut = merge $mrpOut (dict "@type" .) -}}
      {{- end -}}

      {{- with (or (index $mrp "applicableCountry") (index $mrp "applicablecountry")) -}}
        {{- $mrpOut = merge $mrpOut (dict "applicableCountry" .) -}}
      {{- end -}}
      {{- with (or (index $mrp "returnPolicyCategory") (index $mrp "returnpolicycategory")) -}}
        {{- $mrpOut = merge $mrpOut (dict "returnPolicyCategory" .) -}}
      {{- end -}}
      {{- with (or (index $mrp "merchantReturnDays") (index $mrp "merchantreturndays")) -}}
        {{- $mrpOut = merge $mrpOut (dict "merchantReturnDays" .) -}}
      {{- end -}}
      {{- with (or (index $mrp "returnMethod") (index $mrp "returnmethod")) -}}
        {{- $mrpOut = merge $mrpOut (dict "returnMethod" .) -}}
      {{- end -}}
      {{- with (or (index $mrp "returnFees") (index $mrp "returnfees")) -}}
        {{- $mrpOut = merge $mrpOut (dict "returnFees" .) -}}
      {{- end -}}

      {{- if gt (len $mrpOut) 0 -}}
        {{- $offer = merge $offer (dict "hasMerchantReturnPolicy" $mrpOut) -}}
      {{- end -}}
    {{- end -}}

    {{- /* seller: allow override; otherwise link to the site Organization when available */ -}}
    {{- with (index $o "seller") -}}
      {{- $offer = merge $offer (dict "seller" .) -}}
    {{- else -}}
      {{- if $org -}}
        {{- $offer = merge $offer (dict "seller" (dict "@id" (printf "%s#organization" site.BaseURL))) -}}
      {{- end -}}
    {{- end -}}

    {{- $p = merge $p (dict "offers" $offer) -}}
  {{- end -}}
{{- end -}}

{{ $p | jsonify | safeJS }}
</script>
{{- end -}}

{{/* --------------- FAQPage schema (pricing or other pages) ---------------- */}}
{{- $faq := false -}}
{{- with .Params.schema.faq -}}
  {{- if or (and (isset . "enabled") (index . "enabled")) (not (isset . "enabled")) -}}
    {{- $faq = . -}}
  {{- end -}}
{{- end -}}
{{- if $faq -}}
<script type="application/ld+json">
{{- $faqItems := slice -}}
{{- range (index $faq "items") -}}
  {{- $faqItems = $faqItems | append (dict "@type" "Question" "name" (index . "question") "acceptedAnswer" (dict "@type" "Answer" "text" (index . "answer"))) -}}
{{- end -}}
{{- $fobj := dict "@context" "https://schema.org" "@type" "FAQPage" "mainEntity" $faqItems -}}
{{ $fobj | jsonify | safeJS }}
</script>
{{- end -}}

{{/* --------------- WebSite schema with optional SearchAction ---------------- */}}
{{- if site.Params.enableSearch -}}
<script type="application/ld+json">
{{- $w := dict "@context" "https://schema.org" "@type" "WebSite" "url" site.BaseURL "name" site.Title -}}
{{- $searchURL := printf "%ssearch/?q={search_term_string}" site.BaseURL -}}
{{- $w = merge $w (dict "potentialAction" (dict "@type" "SearchAction" "target" $searchURL "query-input" "required name=search_term_string")) -}}
{{ $w | jsonify | safeJS }}
</script>
{{- end -}}
