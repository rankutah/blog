{{- /* Alias partial for sites that shadow footer.html at project level. */ -}}
{{- if not (.Param "hideFooter") }}
<footer class="footer border-t border-[#d5d5d5] dark:border-white/10">
  {{- $footerPage := or (site.GetPage "page" "footer") (site.GetPage "/footer") (site.GetPage "footer") -}}
  {{- if and $footerPage (gt (len (trim $footerPage.Content " \n\r\t")) 0) -}}
    {{- $footerWide := or (.Param "footerWide") (.Site.Params.footerWide) -}}
    <div class="prose prose-sm dark:prose-invert{{ if $footerWide }} max-w-none{{ end }}">
      {{- /* Ensure Clear Presence attribution links in footers are nofollow (even when written as Markdown) */ -}}
      {{- $footerHTML := $footerPage.Content -}}
      {{- /* RE2 (Hugo) doesn't support lookaheads; do this in two passes:
        1) remove any existing rel="..." from Clear Presence links
        2) add rel="nofollow noopener" */ -}}
      {{- $footerHTML = replaceRE `(<a[^>]*href="https?://(www\.)?clearpresence\.io[^"]*"[^>]*?)\srel="[^"]*"` `$1` $footerHTML -}}
      {{- $footerHTML = replaceRE `(<a[^>]*href="https?://(www\.)?clearpresence\.io[^"]*"[^>]*?)>` `$1 rel="nofollow noopener">` $footerHTML -}}
      {{ $footerHTML | safeHTML }}
    </div>
  {{- else -}}
    <span>
      © {{ now.Year }}
      <a href="{{ .Site.Params.clientURL }}" rel="noopener" target="_blank"> {{ .Site.Params.clientName }}</a>
      •
    </span>
    <span>
      <a href="https://clearpresence.io" rel="nofollow noopener" target="_blank">Clear Presence</a>
    </span>
  {{- end }}
</footer>
{{- end }}

{{- if (not site.Params.disableScrollToTop) }}
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
    <path d="M12 6H0l6-6z" />
  </svg>
</a>
{{- end }}

{{- partial "extend_footer.html" . }}
{{- partial "turnstile-loader.html" . }}

{{- $clickTracker := resources.Get "js/click-tracker.js" | minify | fingerprint -}}
{{- $linkifyPhones := resources.Get "js/linkify-phones.js" | minify | fingerprint -}}
<script>
  (function(){
    var DELAY_MS = 4000;

    function injectScript(src, id){
      try {
        if (id && document.getElementById(id)) return;
        var s = document.createElement('script');
        if (id) s.id = id;
        s.src = src;
        s.async = true;
        document.head.appendChild(s);
      } catch(e) {}
    }

    function injectAll(){
      injectScript({{ $clickTracker.RelPermalink | jsonify | safeJS }}, 'cp-click-tracker');
      injectScript({{ $linkifyPhones.RelPermalink | jsonify | safeJS }}, 'cp-linkify-phones');
    }

    function schedule(){
      try {
        if ('requestIdleCallback' in window) requestIdleCallback(injectAll, { timeout: 2000 });
        else setTimeout(injectAll, 1);
      } catch(e) { setTimeout(injectAll, 1); }
    }

    try { setTimeout(schedule, DELAY_MS); } catch(e) { schedule(); }
  })();
</script>
{{- if (not site.Params.disableScrollToTop) }}
<script>
  var mybutton = document.getElementById("top-link");
  window.onscroll = function () {
    if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
      mybutton.style.visibility = "visible";
      mybutton.style.opacity = "1";
    } else {
      mybutton.style.visibility = "hidden";
      mybutton.style.opacity = "0";
    }
  };
</script>
{{- end }}
