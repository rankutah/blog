{{/*
  Flowbite navbar (hover underline + site primary on hover)
  Colors come from shared palette (theme/palette.html):
   - palette keys expected: navBg, navText (solid classes, not rgba)
   - params.header.theme: "blend" (default), "invert", "glass"
*/}}

{{ $stickyMobile  := default true  .Site.Params.header.stickyMobile }}
{{ $stickyDesktop := default true  .Site.Params.header.stickyDesktop }}

{{ $showCTAOnMobile  := default false .Site.Params.header.showCTAOnMobile }}
{{ $showCTAOnDesktop := default true  .Site.Params.header.showCTAOnDesktop }}
{{ $CTAText          := default "Get started" .Site.Params.header.CTAText }}
{{ $CTAURL           := default "/"          .Site.Params.header.CTAURL }}

{{- /* CTA href: allow tel:/sms:/mailto: without relURL mangling */ -}}
{{- $ctaRaw := trim (printf "%v" $CTAURL) " \n\r\t" -}}
{{- $ctaLower := lower $ctaRaw -}}
{{- $ctaIsSpecial := or (strings.HasPrefix $ctaLower "tel:") (strings.HasPrefix $ctaLower "sms:") (strings.HasPrefix $ctaLower "mailto:") -}}
{{- $ctaIsAbs := or (strings.HasPrefix $ctaLower "http://") (strings.HasPrefix $ctaLower "https://") -}}
{{- $ctaHref := cond (or $ctaIsSpecial $ctaIsAbs) ($ctaRaw | safeURL) ($ctaRaw | relURL) -}}

{{ $showPhoneOnMobile := default true  .Site.Params.header.showPhoneOnMobile }}
{{ $phoneNumber       := default "800-123-4567" .Site.Params.header.phoneNumber }}

{{ $showBrandTitle := default true .Site.Params.header.showBrandTitle }}

{{ $logoFile        := .Site.Params.logo }}
{{ $logoHeightClass := default "h-14"      .Site.Params.header.logoHeight }}
{{/* Optional explicit dimensions for the logo (PSI: set width/height to avoid CLS) */}}
{{ $logoW := .Site.Params.header.logoWidth | default 0 }}
{{ $logoH := .Site.Params.header.logoHeightPx | default 0 }}
{{/* If logoHeightPx is set, also enforce rendered size via inline style (CSS beats attributes/classes). */}}
{{ $logoStyle := "" }}
{{ if gt (int $logoH) 0 }}
  {{ $logoStyle = printf "height:%dpx;width:auto;" (int $logoH) }}
{{ end }}

{{/* Shared palette for backgrounds/text (must provide navBg, navText) */}}
{{ $pal := partial "theme/palette.html" . }}
{{ $navBg   := index $pal "navBg"   | default "bg-white dark:bg-neutral-900" }}
{{ $navText := index $pal "navText" | default "text-gray-900 dark:text-white" }}

{{/* Header theme: "blend" (default), "invert", "glass" */}}
{{ $headerTheme := lower (or .Site.Params.header.theme "blend") }}
{{ $centerNav := default false .Site.Params.header.centerNav }}
{{ $rightMenu := default false .Site.Params.header.rightMenu }}

{{/* Sticky layer backgrounds
     - BLEND uses your palette (solid bg so it really looks sticky)
     - INVERT / GLASS keep the special looks you had
*/}}
{{ $navBlend  := printf "%s %s border-b border-gray-200/70 dark:border-white/10 md:border-b-0" $navBg $navText }}
{{ $navInvert := "bg-white/95 dark:bg-gray-900/90 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 md:border-b-0" }}
{{ $navGlass  := "bg-white/60 dark:bg-gray-900/40 backdrop-blur supports-[backdrop-filter]:bg-white/40 supports-[backdrop-filter]:dark:bg-gray-900/30 border-b border-black/10 dark:border-white/10 text-gray-900 dark:text-gray-100 md:border-b-0" }}

{{ $navClasses := cond (eq $headerTheme "invert") $navInvert (cond (eq $headerTheme "glass") $navGlass $navBlend) }}

{{/* Site primary color for hover text & CTA color map */}}
{{ $siteColor := lower (or .Site.Params.primaryColor "blue") }}

{{ $solid := dict
  "red" "text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 dark:bg-red-600 dark:hover:bg-red-700 focus:outline-none dark:focus:ring-red-800"
  "orange" "text-white bg-orange-700 hover:bg-orange-800 focus:ring-4 focus:ring-orange-300 dark:bg-orange-600 dark:hover:bg-orange-700 focus:outline-none dark:focus:ring-orange-800"
  "amber" "text-white bg-amber-700 hover:bg-amber-800 focus:ring-4 focus:ring-amber-300 dark:bg-amber-600 dark:hover:bg-amber-700 focus:outline-none dark:focus:ring-amber-800"
  "yellow" "text-white bg-yellow-700 hover:bg-yellow-800 focus:ring-4 focus:ring-yellow-300 dark:bg-yellow-600 dark:hover:bg-yellow-700 focus:outline-none dark:focus:ring-yellow-800"
  "lime" "text-white bg-lime-700 hover:bg-lime-800 focus:ring-4 focus:ring-lime-300 dark:bg-lime-600 dark:hover:bg-lime-700 focus:outline-none dark:focus:ring-lime-800"
  "green" "text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 dark:bg-green-600 dark:hover:bg-green-700 focus:outline-none dark:focus:ring-green-800"
  "emerald" "text-white bg-emerald-700 hover:bg-emerald-800 focus:ring-4 focus:ring-emerald-300 dark:bg-emerald-600 dark:hover:bg-emerald-700 focus:outline-none dark:focus:ring-emerald-800"
  "teal" "text-white bg-teal-700 hover:bg-teal-800 focus:ring-4 focus:ring-teal-300 dark:bg-teal-600 dark:hover:bg-teal-700 focus:outline-none dark:focus:ring-teal-800"
  "cyan" "text-white bg-cyan-700 hover:bg-cyan-800 focus:ring-4 focus:ring-cyan-300 dark:bg-cyan-600 dark:hover:bg-cyan-700 focus:outline-none dark:focus:ring-cyan-800"
  "sky" "text-white bg-sky-700 hover:bg-sky-800 focus:ring-4 focus:ring-sky-300 dark:bg-sky-600 dark:hover:bg-sky-700 focus:outline-none dark:focus:ring-sky-800"
  "blue" "text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800"
  "indigo" "text-white bg-indigo-700 hover:bg-indigo-800 focus:ring-4 focus:ring-indigo-300 dark:bg-indigo-600 dark:hover:bg-indigo-700 focus:outline-none dark:focus:ring-indigo-800"
  "violet" "text-white bg-violet-700 hover:bg-violet-800 focus:ring-4 focus:ring-violet-300 dark:bg-violet-600 dark:hover:bg-violet-700 focus:outline-none dark:focus:ring-violet-800"
  "purple" "text-white bg-purple-700 hover:bg-purple-800 focus:ring-4 focus:ring-purple-300 dark:bg-purple-600 dark:hover:bg-purple-700 focus:outline-none dark:focus:ring-purple-800"
  "fuchsia" "text-white bg-fuchsia-700 hover:bg-fuchsia-800 focus:ring-4 focus:ring-fuchsia-300 dark:bg-fuchsia-600 dark:hover:bg-fuchsia-700 focus:outline-none dark:focus:ring-fuchsia-800"
  "pink" "text-white bg-pink-700 hover:bg-pink-800 focus:ring-4 focus:ring-pink-300 dark:bg-pink-600 dark:hover:bg-pink-700 focus:outline-none dark:focus:ring-pink-800"
  "rose" "text-white bg-rose-700 hover:bg-rose-800 focus:ring-4 focus:ring-rose-300 dark:bg-rose-600 dark:hover:bg-rose-700 focus:outline-none dark:focus:ring-rose-800"
  "slate" "text-white bg-slate-700 hover:bg-slate-800 focus:ring-4 focus:ring-slate-300 dark:bg-slate-600 dark:hover:bg-slate-700 focus:outline-none dark:focus:ring-slate-800"
  "gray" "text-white bg-gray-700 hover:bg-gray-800 focus:ring-4 focus:ring-gray-300 dark:bg-gray-600 dark:hover:bg-gray-700 focus:outline-none dark:focus:ring-gray-800"
  "zinc" "text-white bg-zinc-700 hover:bg-zinc-800 focus:ring-4 focus:ring-zinc-300 dark:bg-zinc-600 dark:hover:bg-zinc-700 focus:outline-none dark:focus:ring-zinc-800"
  "neutral" "text-white bg-neutral-700 hover:bg-neutral-800 focus:ring-4 focus:ring-neutral-300 dark:bg-neutral-600 dark:hover:bg-neutral-700 focus:outline-none dark:focus:ring-neutral-800"
  "stone" "text-white bg-stone-700 hover:bg-stone-800 focus:ring-4 focus:ring-stone-300 dark:bg-stone-600 dark:hover:bg-stone-700 focus:outline-none dark:focus:ring-stone-800"
}}
{{ $ctaDefault := index $solid $siteColor | default (index $solid "blue") }}
{{ $ctaClasses := default $ctaDefault .Site.Params.header.CTAClasses }}

{{ $navHover := dict
  "red" "hover:text-red-700 md:hover:text-red-700 dark:hover:text-red-500 md:dark:hover:text-red-500"
  "orange" "hover:text-orange-700 md:hover:text-orange-700 dark:hover:text-orange-500 md:dark:hover:text-orange-500"
  "amber" "hover:text-amber-700 md:hover:text-amber-700 dark:hover:text-amber-500 md:dark:hover:text-amber-500"
  "yellow" "hover:text-yellow-700 md:hover:text-yellow-700 dark:hover:text-yellow-500 md:dark:hover:text-yellow-500"
  "lime" "hover:text-lime-700 md:hover:text-lime-700 dark:hover:text-lime-500 md:dark:hover:text-lime-500"
  "green" "hover:text-green-700 md:hover:text-green-700 dark:hover:text-green-500 md:dark:hover:text-green-500"
  "emerald" "hover:text-emerald-700 md:hover:text-emerald-700 dark:hover:text-emerald-500 md:dark:hover:text-emerald-500"
  "teal" "hover:text-teal-700 md:hover:text-teal-700 dark:hover:text-teal-500 md:dark:hover:text-teal-500"
  "cyan" "hover:text-cyan-700 md:hover:text-cyan-700 dark:hover:text-cyan-500 md:dark:hover:text-cyan-500"
  "sky" "hover:text-sky-700 md:hover:text-sky-700 dark:hover:text-sky-500 md:dark:hover:text-sky-500"
  "blue" "hover:text-blue-700 md:hover:text-blue-700 dark:hover:text-blue-500 md:dark:hover:text-blue-500"
  "indigo" "hover:text-indigo-700 md:hover:text-indigo-700 dark:hover:text-indigo-500 md:dark:hover:text-indigo-500"
  "violet" "hover:text-violet-700 md:hover:text-violet-700 dark:hover:text-violet-500 md:dark:hover:text-violet-500"
  "purple" "hover:text-purple-700 md:hover:text-purple-700 dark:hover:text-purple-500 md:dark:hover:text-purple-500"
  "fuchsia" "hover:text-fuchsia-700 md:hover:text-fuchsia-700 dark:hover:text-fuchsia-500 md:dark:hover:text-fuchsia-500"
  "pink" "hover:text-pink-700 md:hover:text-pink-700 dark:hover:text-pink-500 md:dark:hover:text-pink-500"
  "rose" "hover:text-rose-700 md:hover:text-rose-700 dark:hover:text-rose-500 md:dark:hover:text-rose-500"
  "slate" "hover:text-slate-700 md:hover:text-slate-700 dark:hover:text-slate-500 md:dark:hover:text-slate-500"
  "gray" "hover:text-gray-700 md:hover:text-gray-700 dark:hover:text-gray-500 md:dark:hover:text-gray-500"
  "zinc" "hover:text-zinc-700 md:hover:text-zinc-700 dark:hover:text-zinc-500 md:dark:hover:text-zinc-500"
  "neutral" "hover:text-neutral-700 md:hover:text-neutral-700 dark:hover:text-neutral-500 md:dark:hover:text-neutral-500"
  "stone" "hover:text-stone-700 md:hover:text-stone-700 dark:hover:text-stone-500 md:dark:hover:text-stone-500"
}}
{{ $navHoverClasses := index $navHover $siteColor | default (index $navHover "blue") }}

{{/* Light-mode border color for search input: use palette card border (revert from primary-colored) */}}
{{ $cardBorderLightName := lower (or .Site.Params.cardBorderLight "gray-200") }}
{{ if strings.HasPrefix $cardBorderLightName "border-" }}{{ $cardBorderLightName = replace $cardBorderLightName "border-" "" }}{{ end }}
{{ $searchBorderLight := printf "border-%s" $cardBorderLightName }}

{{/* Dropdown background: use normalized card surface from palette */}}
{{ $dropBg := index $pal "cardBg" }}

{{/* Detect hero/landing/home to allow a seamless, flush hero */}}
{{ $isHeroPage := or .IsHome (or .Params.hero (eq .Params.layout "landing")) }}

<nav class="{{ $navClasses }} h-auto min-h-[5rem]
            {{ if $stickyMobile }}sticky top-0 z-50{{ end }}
            {{ if $stickyDesktop }} md:sticky md:top-0 md:z-50{{ end }}
            relative
            after:content-[''] after:absolute after:inset-x-0 after:bottom-0 after:h-px
            after:bg-black/15 dark:after:bg-white/15 after:pointer-events-none">
  <div class="w-full max-w-none flex flex-nowrap items-center justify-between mx-auto h-full py-4 px-2 sm:px-3 lg:px-4 {{ if and $centerNav (not $rightMenu) }}xl:grid xl:grid-cols-[1fr_auto_1fr] xl:gap-4{{ else if $rightMenu }}xl:grid xl:grid-cols-[auto_1fr_auto_auto] xl:gap-4{{ end }}">
    <!-- Logo / Site Title -->
    <a href="{{ "/" | relURL }}" class="flex items-center space-x-3 rtl:space-x-reverse no-underline {{ if and $centerNav (not $rightMenu) }}xl:col-start-1 xl:justify-self-start{{ else if $rightMenu }}xl:col-start-1 xl:justify-self-start{{ end }}">
      <span class="shrink-0">
        {{ with $logoFile }}
          {{ $raw := strings.TrimPrefix "/" $.Site.Params.logo }}
    {{ $base := path.Base $raw }}
    {{ $ext  := path.Ext $base }}
    {{ $name := replace $base $ext "" }}
          {{ $avifRes := resources.Get (printf "media/%s.avif" $name) }}
    {{ if $avifRes }}
            <picture>
              {{- with $avifRes -}}<source srcset="{{ .RelPermalink }}" type="image/avif" />{{- end -}}
              {{- /* No WebP source; only AVIF + fallback <img> */ -}}
              <img src="{{ . | relURL }}"
                   alt="{{ printf "%s logo" $.Site.Title }}"
                   class="{{ printf "%s w-auto max-w-none shrink-0" $logoHeightClass }}"
                   {{ if gt (int $logoW) 0 }}width="{{ int $logoW }}"{{ end }}
                   {{ with $logoH }}{{ if gt (int .) 0 }}height="{{ . }}"{{ end }}{{ end }}
                   {{ with $logoStyle }}style="{{ . | safeCSS }}"{{ end }}
                   loading="eager" fetchpriority="high" decoding="async" />
            </picture>
          {{ else }}
            {{ partial "optimized-logo.html" (dict
                "Site" $.Site
                "Logo" .
                "Class" (printf "%s w-auto max-w-none shrink-0" $logoHeightClass)
                "Alt" (printf "%s logo" $.Site.Title)
                "Width" $logoW
                "Height" $logoH
                "Style" $logoStyle
              ) }}
          {{ end }}
        {{ end }}
      </span>
      {{/* --- Title size map (literal classes; no dynamic strings) --- */}}
      {{- $sizeOpt  := lower (or .Site.Params.header.titleSize "auto") -}}
      {{- $sizeMap  := dict
        "auto" "text-[clamp(1.5rem,1.1rem+1.8vw,2.25rem)]"
        "sm"   "text-sm"
        "base" "text-base"
        "lg"   "text-lg"
        "xl"   "text-xl"
        "2xl"  "text-xl sm:text-2xl"
        "3xl"  "text-2xl sm:text-3xl"
        "4xl"  "text-3xl sm:text-4xl"
        -}}
      {{- $titleSizeClass := index $sizeMap $sizeOpt | default "text-2xl sm:text-3xl" -}}

      {{/* Manual line break support from earlier (use "|" or newline in config) */}}
      {{- $rawTitle := or .Site.Params.header.title .Site.Title -}}
      {{- $titleHTML := replace (replace $rawTitle "|" "<br/>") (printf "\n") "<br/>" | safeHTML -}}

      {{- if $showBrandTitle -}}
        <span class="self-center nav-site-title {{ $titleSizeClass }} font-semibold leading-tight whitespace-normal break-words">
          {{ $titleHTML }}
        </span>
      {{- end -}}
    </a>

    <!-- Actions -->
    <div class="flex md:order-2 items-center space-x-3 md:space-x-2 {{ if $rightMenu }}xl:space-x-2{{ end }} rtl:space-x-reverse {{ if and $centerNav (not $rightMenu) }}xl:col-start-3 xl:justify-self-end xl:order-none{{ else if $rightMenu }}xl:col-start-4 xl:justify-self-end xl:order-none xl:min-w-0 xl:flex-nowrap{{ end }}">
      {{ if $rightMenu }}
      <!-- Right-cluster desktop menu (before search/CTA) -->
      <div class="hidden xl:flex items-center whitespace-nowrap xl:mx-2">
        <ul class="flex flex-row font-medium space-x-3 xl:space-x-4 rtl:space-x-reverse whitespace-nowrap">
          {{ range .Site.Menus.main }}
            <li class="relative">
              {{ if .HasChildren }}
                <button id="menu-{{ .Identifier }}-r-button" type="button"
                        data-dropdown-toggle="menu-{{ .Identifier }}-r"
                        data-dropdown-placement="bottom-start"
                        aria-expanded="false"
                        class="no-underline hover:underline brand-link {{ $navHoverClasses }} flex items-center justify-between w-full py-2 px-3 md:border-0 md:p-0 md:w-auto">
                  {{ .Name }}
                  <svg data-chevron class="w-2.5 h-2.5 ms-2.5 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6" aria-hidden="true">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                  </svg>
                </button>
                 <div id="menu-{{ .Identifier }}-r"
                   class="z-50 hidden absolute left-0 top-full mt-2 min-w-[14rem] w-fit max-w-[28rem] rounded-lg shadow-sm {{ $dropBg }} backdrop-blur whitespace-normal break-words">
                  <ul class="py-2 text-sm">
                      {{ range .Children }}
                        {{ if .HasChildren }}
                          {{- $isNoNav := or (eq .URL "#") (eq .URL "/#") -}}
                          {{- $submenuId := printf "submenu-%s-r" (or .Identifier (urlize .Name)) -}}
                          <li class="relative group">
                            {{ if $isNoNav }}
                              <button type="button"
                                      class="no-underline hover:underline brand-link flex items-center justify-between w-full px-4 py-2 hover:bg-black/5 dark:hover:bg-white/10"
                                      data-submenu-toggle="{{ $submenuId }}"
                                      aria-controls="{{ $submenuId }}"
                                      aria-expanded="false">
                                <span>{{ .Name }}</span>
                                <svg data-chevron-flyout class="w-2.5 h-2.5 ms-2.5 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6" aria-hidden="true">
                                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                                </svg>
                              </button>
                            {{ else }}
                              <a href="{{ .URL | relURL }}" class="no-underline hover:underline brand-link flex items-center justify-between px-4 py-2 hover:bg-black/5 dark:hover:bg-white/10">
                                <span>{{ .Name }}</span>
                                <svg class="w-2.5 h-2.5 ms-2.5 -rotate-90" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                                </svg>
                              </a>
                            {{ end }}
                            {{ if $isNoNav }}
                              <div id="{{ $submenuId }}" data-submenu class="z-50 hidden absolute left-full top-0 ml-1">
                            {{ else }}
                              <div class="z-50 hidden group-hover:block group-focus-within:block absolute left-full top-0 ml-1">
                            {{ end }}
                              <div class="min-w-[14rem] w-fit max-w-[28rem] rounded-lg shadow-sm {{ $dropBg }} backdrop-blur whitespace-normal break-words">
                                <ul class="py-2 text-sm">
                                  {{ range .Children }}
                                    <li>
                                      <a href="{{ .URL | relURL }}" class="no-underline hover:underline brand-link block px-4 py-2 hover:bg-black/5 dark:hover:bg-white/10">
                                        {{ .Name }}
                                      </a>
                                    </li>
                                  {{ end }}
                                </ul>
                              </div>
                            </div>
                          </li>
                        {{ else }}
                          <li>
                            <a href="{{ .URL | relURL }}" class="no-underline hover:underline brand-link block px-4 py-2 hover:bg-black/5 dark:hover:bg-white/10">
                              {{ .Name }}
                            </a>
                          </li>
                        {{ end }}
                      {{ end }}
                  </ul>
                </div>
              {{ else }}
                <a href="{{ .URL | relURL }}"
                   class="no-underline hover:underline brand-link {{ $navHoverClasses }} block py-2 px-3 rounded-sm md:border-0 md:p-0"
                   {{ if eq .URL $.Permalink }}aria-current="page"{{ end }}>
                  {{ .Name }}
                </a>
              {{ end }}
            </li>
          {{ end }}
        </ul>
      </div>
      {{ end }}
      <!-- Search (tablet+): keep full input (links collapse so there's room) -->
      <form action="{{ "/search/" | relURL }}" method="get" role="search"
            class="hidden md:inline-flex items-center no-underline" aria-label="Site search">
        <label for="nav-search" class="sr-only">Search</label>
        <div class="relative">
          <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
            <svg class="h-4 w-4 {{ $navText }}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="11" cy="11" r="7"></circle>
              <path d="M20 20l-3.5-3.5"></path>
            </svg>
          </div>
             <input id="nav-search" name="q" type="search" placeholder="Searchâ€¦" autocomplete="off"
               class="block w-24 md:w-28 lg:w-36 rounded-lg {{ $pal.cardBorder }} {{ $pal.cardBg }} py-2 pl-8 pr-3 text-sm shadow-sm transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-black/10 dark:focus:ring-white/10 {{ $navText }} font-medium placeholder-gray-600 dark:placeholder-gray-400" />
        </div>
      </form>
      {{ if or $showCTAOnMobile $showCTAOnDesktop }}
      <a href="{{ $ctaHref }}"
        class="no-underline font-medium rounded-lg text-sm px-4 py-2 focus:ring-4 focus:outline-none ui-btn whitespace-nowrap flex-shrink-0
                {{ if $showCTAOnMobile }}inline-flex{{ else }}hidden{{ end }}
                {{ if $showCTAOnDesktop }} md:inline-flex{{ else }} md:hidden{{ end }}
                text-center {{ $ctaClasses }}">
        {{ $CTAText }}
      </a>
      {{ end }}

      {{ if and $showPhoneOnMobile (ne $phoneNumber "") }}
      {{/* Strip all non-digits from the configured phone number and prefix +1 */}}
      {{ $digits := replaceRE `[^0-9]` "" $phoneNumber }}
      <a href="{{ printf "tel:+1%s" $digits | safeURL }}"
         class="inline-flex md:hidden items-center justify-center p-2 text-lg
                focus:ring-2 focus:outline-none hover:bg-black/5 dark:hover:bg-white/10 no-underline"
        aria-label="{{ default "Call us" .Site.Params.ariaLabelCall }}">
        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.08 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
          <path d="M14.05 5a8 8 0 0 1 5.95 5.95"/>
          <path d="M14.05 1a12 12 0 0 1 9 9"/>
        </svg>
      </a>
      {{ end }}

            <button data-collapse-toggle="navbar-drawer" type="button"
              class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm rounded-lg xl:hidden hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-black/10 dark:focus:ring-white/10 no-underline"
              aria-controls="navbar-drawer" aria-expanded="false">
        <span class="sr-only">Open main menu</span>
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M1 1h15M1 7h15M1 13h15"/>
        </svg>
      </button>
    </div>

    <!-- Mobile drawer overlay -->
    <div id="nav-drawer-overlay" class="fixed inset-0 bg-black/40 opacity-0 pointer-events-none transition-opacity duration-200 xl:hidden z-40" aria-hidden="true"></div>

    <!-- Mobile off-canvas drawer -->
    <div id="navbar-drawer"
      class="fixed inset-y-0 right-0 z-50 w-72 max-w-[85vw] xl:hidden
               translate-x-full transition-transform duration-200 ease-out pointer-events-none
               {{ if eq $headerTheme "glass" }}bg-white/80 dark:bg-gray-900/80 backdrop-blur
               {{ else if eq $headerTheme "invert" }}bg-white/95 dark:bg-gray-900/90
               {{ else }}{{ $navBg }}
               {{ end }} shadow-lg border-l border-black/10 dark:border-white/10"
        data-drawer="right" aria-hidden="true" role="dialog" aria-label="Main menu">

      <!-- Drawer header (mobile only) -->
      <div class="flex items-center justify-between p-4 border-b border-black/10 dark:border-white/10">
        <span class="font-semibold">Menu</span>
        <button type="button" class="p-2 rounded hover:bg-black/5 dark:hover:bg-white/10" data-drawer-close aria-label="Close menu">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <ul class="flex flex-col p-4 mt-2 font-medium rounded-lg space-y-1">
        {{ range .Site.Menus.main }}
          <li class="relative">
            {{ if .HasChildren }}
        <button id="menu-{{ .Identifier }}-m-button" type="button"
                      data-dropdown-toggle="menu-{{ .Identifier }}-m"
                      data-dropdown-placement="bottom-start"
                      aria-expanded="false"
          class="no-underline hover:underline brand-link {{ $navHoverClasses }} flex items-center justify-between w-full py-2 px-3 md:border-0 md:p-0 md:w-auto">
                {{ .Name }}
                <svg data-chevron class="w-2.5 h-2.5 ms-2.5 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6" aria-hidden="true">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                </svg>
              </button>

                  <div id="menu-{{ .Identifier }}-m"
                    class="z-50 hidden md:absolute md:left-0 md:top-full md:mt-2 w-44 rounded-lg shadow-sm {{ $dropBg }} backdrop-blur">
                <ul class="py-2 text-sm">
                  {{ range .Children }}
                    {{ if .HasChildren }}
                      {{- $isNoNav := or (eq .URL "#") (eq .URL "/#") -}}
                      {{- $submenuId := printf "submenu-%s-m" (or .Identifier (urlize .Name)) -}}
                      <li>
                        {{ if $isNoNav }}
                          <button type="button"
                                  class="no-underline hover:underline brand-link flex items-center justify-between w-full px-4 py-2 hover:bg-black/5 dark:hover:bg-white/10"
                                  data-submenu-toggle="{{ $submenuId }}"
                                  aria-controls="{{ $submenuId }}"
                                  aria-expanded="false">
                            <span>{{ .Name }}</span>
                            <svg data-chevron class="w-2.5 h-2.5 ms-2.5 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6" aria-hidden="true">
                              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                            </svg>
                          </button>
                        {{ else }}
                          <a href="{{ .URL | relURL }}" class="no-underline hover:underline brand-link flex items-center justify-between px-4 py-2 hover:bg-black/5 dark:hover:bg-white/10">
                            <span>{{ .Name }}</span>
                            <svg class="w-2.5 h-2.5 ms-2.5 -rotate-90" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6" aria-hidden="true">
                              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                            </svg>
                          </a>
                        {{ end }}
                        <ul id="{{ $submenuId }}" data-submenu class="mt-1 ml-4 border-l border-black/10 dark:border-white/10 hidden">
                          {{ range .Children }}
                            <li>
                              <a href="{{ .URL | relURL }}" class="no-underline hover:underline brand-link block px-4 py-2 pl-5 hover:bg-black/5 dark:hover:bg-white/10">
                                {{ .Name }}
                              </a>
                            </li>
                          {{ end }}
                        </ul>
                      </li>
                    {{ else }}
                      <li>
                        <a href="{{ .URL | relURL }}" class="no-underline hover:underline brand-link block px-4 py-2 hover:bg-black/5 dark:hover:bg-white/10">
                          {{ .Name }}
                        </a>
                      </li>
                    {{ end }}
                  {{ end }}
                </ul>
              </div>
            {{ else }}
          <a href="{{ .URL | relURL }}"
            class="no-underline hover:underline brand-link {{ $navHoverClasses }} block py-2 px-3 rounded-sm md:border-0 md:p-0"
                 {{ if eq .URL $.Permalink }}aria-current="page"{{ end }}>
                {{ .Name }}
              </a>
            {{ end }}
          </li>
        {{ end }}
        <!-- Mobile: search link at bottom of menu -->
        <li class="pt-2 mt-2 border-t border-black/10 dark:border-white/10">
          <a href="/search/" class="no-underline hover:underline brand-link block px-4 py-2">
            <span class="inline-flex items-center gap-2">
              <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="11" cy="11" r="7"/>
                <path d="M20 20l-3.5-3.5"/>
              </svg>
              Search
            </span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Desktop inline menu (unchanged from original) -->
    <div id="navbar-sticky"
      class="items-center justify-between hidden w-full {{ if $rightMenu }}xl:hidden{{ else }}xl:flex{{ end }} xl:w-auto xl:order-1 xl:mx-2 {{ if and $centerNav (not $rightMenu) }}xl:col-start-2 xl:justify-self-center xl:order-none{{ else if $rightMenu }}xl:col-start-3 xl:justify-self-end xl:order-none xl:mr-2{{ end }}
                {{ if eq $headerTheme "glass" }}bg-white/80 dark:bg-gray-900/80 backdrop-blur
                {{ else if eq $headerTheme "invert" }}bg-white/95 dark:bg-gray-900/90
                {{ else }}{{ $navBg }}
                {{ end }}
          border-t border-black/10 dark:border-white/10 lg:border-0
          xl:border-0
          xl:bg-transparent xl:dark:bg-transparent">

      <ul class="flex flex-col p-4 md:p-0 mt-4 font-medium rounded-lg md:space-x-6 rtl:space-x-reverse xl:flex-row md:mt-0 whitespace-nowrap">
        {{ range .Site.Menus.main }}
          <li class="relative">
            {{ if .HasChildren }}
        <button id="menu-{{ .Identifier }}-d-button" type="button"
                      data-dropdown-toggle="menu-{{ .Identifier }}-d"
                      data-dropdown-placement="bottom-start"
                      aria-expanded="false"
          class="no-underline hover:underline brand-link {{ $navHoverClasses }} flex items-center justify-between w-full py-2 px-3 md:border-0 md:p-0 md:w-auto">
                {{ .Name }}
                <svg data-chevron class="w-2.5 h-2.5 ms-2.5 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6" aria-hidden="true">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                </svg>
              </button>

                  <div id="menu-{{ .Identifier }}-d"
                    class="z-50 hidden md:absolute md:left-0 md:top-full md:mt-2 min-w-[14rem] w-fit max-w-[28rem] rounded-lg shadow-sm {{ $dropBg }} backdrop-blur whitespace-normal break-words">
                <ul class="py-2 text-sm">
                  {{ range .Children }}
                    {{ if .HasChildren }}
                      {{- $isNoNav := or (eq .URL "#") (eq .URL "/#") -}}
                      {{- $submenuId := printf "submenu-%s-d" (or .Identifier (urlize .Name)) -}}
                      <li class="relative group">
                        {{ if $isNoNav }}
                          <button type="button"
                                  class="no-underline hover:underline brand-link flex items-center justify-between w-full px-4 py-2 hover:bg-black/5 dark:hover:bg-white/10"
                                  data-submenu-toggle="{{ $submenuId }}"
                                  aria-controls="{{ $submenuId }}"
                                  aria-expanded="false">
                            <span>{{ .Name }}</span>
                            <svg data-chevron-flyout class="w-2.5 h-2.5 ms-2.5 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6" aria-hidden="true">
                              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                            </svg>
                          </button>
                        {{ else }}
                          <a href="{{ .URL | relURL }}" class="no-underline hover:underline brand-link flex items-center justify-between px-4 py-2 hover:bg-black/5 dark:hover:bg-white/10">
                            <span>{{ .Name }}</span>
                            <svg class="w-2.5 h-2.5 ms-2.5 -rotate-90" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                            </svg>
                          </a>
                        {{ end }}
                        {{ if $isNoNav }}
                          <div id="{{ $submenuId }}" data-submenu class="z-50 hidden absolute left-full top-0 ml-1">
                        {{ else }}
                          <div class="z-50 hidden group-hover:block group-focus-within:block absolute left-full top-0 ml-1">
                        {{ end }}
                          <div class="min-w-[14rem] w-fit max-w-[28rem] rounded-lg shadow-sm {{ $dropBg }} backdrop-blur whitespace-normal break-words">
                            <ul class="py-2 text-sm">
                              {{ range .Children }}
                                <li>
                                  <a href="{{ .URL | relURL }}" class="no-underline hover:underline brand-link block px-4 py-2 hover:bg-black/5 dark:hover:bg-white/10">
                                    {{ .Name }}
                                  </a>
                                </li>
                              {{ end }}
                            </ul>
                          </div>
                        </div>
                      </li>
                    {{ else }}
                      <li>
                        <a href="{{ .URL | relURL }}" class="no-underline hover:underline brand-link block px-4 py-2 hover:bg-black/5 dark:hover:bg-white/10">
                          {{ .Name }}
                        </a>
                      </li>
                    {{ end }}
                  {{ end }}
                </ul>
              </div>
            {{ else }}
          <a href="{{ .URL | relURL }}"
            class="no-underline hover:underline brand-link {{ $navHoverClasses }} block py-2 px-3 rounded-sm md:border-0 md:p-0"
                 {{ if eq .URL $.Permalink }}aria-current="page"{{ end }}>
                {{ .Name }}
              </a>
            {{ end }}
          </li>
        {{ end }}
      </ul>
    </div>
  </div>
</nav>

<script>
  // Dynamically measure the sticky header height and expose it as a CSS var
  (function(){
    function setHeaderVar(){
      var nav = document.querySelector('nav');
      if (!nav) return;
      var h = Math.ceil(nav.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--site-header-h', h + 'px');
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setHeaderVar, { once:true });
    } else {
      setHeaderVar();
    }
    window.addEventListener('resize', setHeaderVar);
  })();
  </script>

<style>
  /* Chevron best-practice behavior:
     - down chevron for menus that open downward
     - rotate when expanded (aria-expanded="true")
  */
  button[aria-expanded="true"] svg[data-chevron] { transform: rotate(180deg); }

  /* Flyout chevrons (2nd-level desktop click-toggles):
     - default points right
      - expanded points left
  */
  button svg[data-chevron-flyout] { transform: rotate(-90deg); }
    button[aria-expanded="true"] svg[data-chevron-flyout] { transform: rotate(90deg); }
</style>

<script>
  // Nested submenu toggles (2nd-level only)
  (function(){
    function toggleSubmenu(btn){
      try {
        var id = btn && btn.getAttribute('data-submenu-toggle');
        if (!id) return;
        var menu = document.getElementById(id);
        if (!menu) return;
        var isHidden = menu.classList.contains('hidden');
        if (isHidden) menu.classList.remove('hidden');
        else menu.classList.add('hidden');
        btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
      } catch(_e) {}
    }

    function closeSubmenu(btn){
      try {
        var id = btn && btn.getAttribute('data-submenu-toggle');
        if (!id) return;
        var menu = document.getElementById(id);
        if (menu && !menu.classList.contains('hidden')) menu.classList.add('hidden');
        if (btn) btn.setAttribute('aria-expanded', 'false');
      } catch(_e) {}
    }

    function closeAllSubmenus(){
      try {
        var buttons = document.querySelectorAll('[data-submenu-toggle][aria-expanded="true"]');
        for (var i = 0; i < buttons.length; i++) closeSubmenu(buttons[i]);
      } catch(_e) {}
    }

    function init(){
      document.addEventListener('click', function(ev){
        var t = ev && ev.target;
        if (!t) return;

        var btn = t.closest ? t.closest('[data-submenu-toggle]') : null;
        if (btn) {
          ev.preventDefault();
          ev.stopPropagation();
          var id = btn.getAttribute('data-submenu-toggle');
          var menu = id ? document.getElementById(id) : null;
          var isOpen = (btn.getAttribute('aria-expanded') === 'true') && menu && !menu.classList.contains('hidden');

          if (isOpen) {
            closeSubmenu(btn);
          } else {
            closeAllSubmenus();
            toggleSubmenu(btn);
          }
          return;
        }

        // Click outside any open submenu closes it.
        if (t.closest && (t.closest('[data-submenu]') || t.closest('[data-submenu-toggle]'))) return;
        closeAllSubmenus();
      });

      document.addEventListener('keydown', function(ev){
        if (!ev) return;
        var key = ev.key || ev.code;
        if (key === 'Escape' || key === 'Esc') closeAllSubmenus();
      });
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init, { once:true });
    else init();
  })();
</script>

