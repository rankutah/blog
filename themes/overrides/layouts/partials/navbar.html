{{/*
  Flowbite navbar (hover underline + site primary on hover)
  Colors come from shared palette (theme/palette.html):
   - palette keys expected: navBg, navText (solid classes, not rgba)
   - params.header.theme: "blend" (default), "invert", "glass"
*/}}

{{ $stickyMobile  := default true  .Site.Params.header.stickyMobile }}
{{ $stickyDesktop := default true  .Site.Params.header.stickyDesktop }}

{{ $showCTAOnMobile  := default true  .Site.Params.header.showCTAOnMobile }}
{{ $showCTAOnDesktop := default true  .Site.Params.header.showCTAOnDesktop }}
{{ $CTAText          := default "Get started" .Site.Params.header.CTAText }}
{{ $CTAURL           := default "/"          .Site.Params.header.CTAURL }}

{{ $showPhoneOnMobile := default true  .Site.Params.header.showPhoneOnMobile }}
{{ $phoneNumber       := default "800-123-4567" .Site.Params.header.phoneNumber }}

{{ $logoFile        := .Site.Params.logo }}
{{ $logoHeightClass := default "h-8"      .Site.Params.header.logoHeight }}
{{/* Optional explicit dimensions for the logo (PSI: set width/height to avoid CLS) */}}
{{ $logoW := .Site.Params.header.logoWidth | default 0 }}
{{ $logoH := .Site.Params.header.logoHeightPx | default 0 }}

{{/* Shared palette for backgrounds/text (must provide navBg, navText) */}}
{{ $pal := partial "theme/palette.html" . }}
{{ $navBg   := index $pal "navBg"   | default "bg-white dark:bg-neutral-900" }}
{{ $navText := index $pal "navText" | default "text-gray-900 dark:text-white" }}

{{/* Header theme: "blend" (default), "invert", "glass" */}}
{{ $headerTheme := lower (or .Site.Params.header.theme "blend") }}

{{/* Sticky layer backgrounds
     - BLEND uses your palette (solid bg so it really looks sticky)
     - INVERT / GLASS keep the special looks you had
*/}}
{{ $navBlend  := printf "%s %s border-b border-gray-200/70 dark:border-white/10 md:border-b-0" $navBg $navText }}
{{ $navInvert := "bg-white/95 dark:bg-gray-900/90 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 md:border-b-0" }}
{{ $navGlass  := "bg-white/60 dark:bg-gray-900/40 backdrop-blur supports-[backdrop-filter]:bg-white/40 supports-[backdrop-filter]:dark:bg-gray-900/30 border-b border-black/10 dark:border-white/10 text-gray-900 dark:text-gray-100 md:border-b-0" }}

{{ $navClasses := cond (eq $headerTheme "invert") $navInvert (cond (eq $headerTheme "glass") $navGlass $navBlend) }}

{{/* Site primary color for hover text & CTA color map */}}
{{ $siteColor := lower (or .Site.Params.primaryColor "blue") }}

{{ $solid := dict
  "red" "text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 dark:bg-red-600 dark:hover:bg-red-700 focus:outline-none dark:focus:ring-red-800"
  "orange" "text-white bg-orange-700 hover:bg-orange-800 focus:ring-4 focus:ring-orange-300 dark:bg-orange-600 dark:hover:bg-orange-700 focus:outline-none dark:focus:ring-orange-800"
  "amber" "text-white bg-amber-700 hover:bg-amber-800 focus:ring-4 focus:ring-amber-300 dark:bg-amber-600 dark:hover:bg-amber-700 focus:outline-none dark:focus:ring-amber-800"
  "yellow" "text-white bg-yellow-700 hover:bg-yellow-800 focus:ring-4 focus:ring-yellow-300 dark:bg-yellow-600 dark:hover:bg-yellow-700 focus:outline-none dark:focus:ring-yellow-800"
  "lime" "text-white bg-lime-700 hover:bg-lime-800 focus:ring-4 focus:ring-lime-300 dark:bg-lime-600 dark:hover:bg-lime-700 focus:outline-none dark:focus:ring-lime-800"
  "green" "text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 dark:bg-green-600 dark:hover:bg-green-700 focus:outline-none dark:focus:ring-green-800"
  "emerald" "text-white bg-emerald-700 hover:bg-emerald-800 focus:ring-4 focus:ring-emerald-300 dark:bg-emerald-600 dark:hover:bg-emerald-700 focus:outline-none dark:focus:ring-emerald-800"
  "teal" "text-white bg-teal-700 hover:bg-teal-800 focus:ring-4 focus:ring-teal-300 dark:bg-teal-600 dark:hover:bg-teal-700 focus:outline-none dark:focus:ring-teal-800"
  "cyan" "text-white bg-cyan-700 hover:bg-cyan-800 focus:ring-4 focus:ring-cyan-300 dark:bg-cyan-600 dark:hover:bg-cyan-700 focus:outline-none dark:focus:ring-cyan-800"
  "sky" "text-white bg-sky-700 hover:bg-sky-800 focus:ring-4 focus:ring-sky-300 dark:bg-sky-600 dark:hover:bg-sky-700 focus:outline-none dark:focus:ring-sky-800"
  "blue" "text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800"
  "indigo" "text-white bg-indigo-700 hover:bg-indigo-800 focus:ring-4 focus:ring-indigo-300 dark:bg-indigo-600 dark:hover:bg-indigo-700 focus:outline-none dark:focus:ring-indigo-800"
  "violet" "text-white bg-violet-700 hover:bg-violet-800 focus:ring-4 focus:ring-violet-300 dark:bg-violet-600 dark:hover:bg-violet-700 focus:outline-none dark:focus:ring-violet-800"
  "purple" "text-white bg-purple-700 hover:bg-purple-800 focus:ring-4 focus:ring-purple-300 dark:bg-purple-600 dark:hover:bg-purple-700 focus:outline-none dark:focus:ring-purple-800"
  "fuchsia" "text-white bg-fuchsia-700 hover:bg-fuchsia-800 focus:ring-4 focus:ring-fuchsia-300 dark:bg-fuchsia-600 dark:hover:bg-fuchsia-700 focus:outline-none dark:focus:ring-fuchsia-800"
  "pink" "text-white bg-pink-700 hover:bg-pink-800 focus:ring-4 focus:ring-pink-300 dark:bg-pink-600 dark:hover:bg-pink-700 focus:outline-none dark:focus:ring-pink-800"
  "rose" "text-white bg-rose-700 hover:bg-rose-800 focus:ring-4 focus:ring-rose-300 dark:bg-rose-600 dark:hover:bg-rose-700 focus:outline-none dark:focus:ring-rose-800"
  "slate" "text-white bg-slate-700 hover:bg-slate-800 focus:ring-4 focus:ring-slate-300 dark:bg-slate-600 dark:hover:bg-slate-700 focus:outline-none dark:focus:ring-slate-800"
  "gray" "text-white bg-gray-700 hover:bg-gray-800 focus:ring-4 focus:ring-gray-300 dark:bg-gray-600 dark:hover:bg-gray-700 focus:outline-none dark:focus:ring-gray-800"
  "zinc" "text-white bg-zinc-700 hover:bg-zinc-800 focus:ring-4 focus:ring-zinc-300 dark:bg-zinc-600 dark:hover:bg-zinc-700 focus:outline-none dark:focus:ring-zinc-800"
  "neutral" "text-white bg-neutral-700 hover:bg-neutral-800 focus:ring-4 focus:ring-neutral-300 dark:bg-neutral-600 dark:hover:bg-neutral-700 focus:outline-none dark:focus:ring-neutral-800"
  "stone" "text-white bg-stone-700 hover:bg-stone-800 focus:ring-4 focus:ring-stone-300 dark:bg-stone-600 dark:hover:bg-stone-700 focus:outline-none dark:focus:ring-stone-800"
}}
{{ $ctaDefault := index $solid $siteColor | default (index $solid "blue") }}
{{ $ctaClasses := default $ctaDefault .Site.Params.header.CTAClasses }}

{{ $navHover := dict
  "red" "hover:text-red-700 md:hover:text-red-700 dark:hover:text-red-500 md:dark:hover:text-red-500"
  "orange" "hover:text-orange-700 md:hover:text-orange-700 dark:hover:text-orange-500 md:dark:hover:text-orange-500"
  "amber" "hover:text-amber-700 md:hover:text-amber-700 dark:hover:text-amber-500 md:dark:hover:text-amber-500"
  "yellow" "hover:text-yellow-700 md:hover:text-yellow-700 dark:hover:text-yellow-500 md:dark:hover:text-yellow-500"
  "lime" "hover:text-lime-700 md:hover:text-lime-700 dark:hover:text-lime-500 md:dark:hover:text-lime-500"
  "green" "hover:text-green-700 md:hover:text-green-700 dark:hover:text-green-500 md:dark:hover:text-green-500"
  "emerald" "hover:text-emerald-700 md:hover:text-emerald-700 dark:hover:text-emerald-500 md:dark:hover:text-emerald-500"
  "teal" "hover:text-teal-700 md:hover:text-teal-700 dark:hover:text-teal-500 md:dark:hover:text-teal-500"
  "cyan" "hover:text-cyan-700 md:hover:text-cyan-700 dark:hover:text-cyan-500 md:dark:hover:text-cyan-500"
  "sky" "hover:text-sky-700 md:hover:text-sky-700 dark:hover:text-sky-500 md:dark:hover:text-sky-500"
  "blue" "hover:text-blue-700 md:hover:text-blue-700 dark:hover:text-blue-500 md:dark:hover:text-blue-500"
  "indigo" "hover:text-indigo-700 md:hover:text-indigo-700 dark:hover:text-indigo-500 md:dark:hover:text-indigo-500"
  "violet" "hover:text-violet-700 md:hover:text-violet-700 dark:hover:text-violet-500 md:dark:hover:text-violet-500"
  "purple" "hover:text-purple-700 md:hover:text-purple-700 dark:hover:text-purple-500 md:dark:hover:text-purple-500"
  "fuchsia" "hover:text-fuchsia-700 md:hover:text-fuchsia-700 dark:hover:text-fuchsia-500 md:dark:hover:text-fuchsia-500"
  "pink" "hover:text-pink-700 md:hover:text-pink-700 dark:hover:text-pink-500 md:dark:hover:text-pink-500"
  "rose" "hover:text-rose-700 md:hover:text-rose-700 dark:hover:text-rose-500 md:dark:hover:text-rose-500"
  "slate" "hover:text-slate-700 md:hover:text-slate-700 dark:hover:text-slate-500 md:dark:hover:text-slate-500"
  "gray" "hover:text-gray-700 md:hover:text-gray-700 dark:hover:text-gray-500 md:dark:hover:text-gray-500"
  "zinc" "hover:text-zinc-700 md:hover:text-zinc-700 dark:hover:text-zinc-500 md:dark:hover:text-zinc-500"
  "neutral" "hover:text-neutral-700 md:hover:text-neutral-700 dark:hover:text-neutral-500 md:dark:hover:text-neutral-500"
  "stone" "hover:text-stone-700 md:hover:text-stone-700 dark:hover:text-stone-500 md:dark:hover:text-stone-500"
}}
{{ $navHoverClasses := index $navHover $siteColor | default (index $navHover "blue") }}

{{/* Detect hero/landing/home to allow a seamless, flush hero */}}
{{ $isHeroPage := or .IsHome (or .Params.hero (eq .Params.layout "landing")) }}

<nav class="{{ $navClasses }} h-auto min-h-[4rem]
            {{ if $stickyMobile }}sticky top-0 z-50{{ end }}
            {{ if $stickyDesktop }} md:sticky md:top-0 md:z-50{{ end }}
            relative
            md:after:content-[''] md:after:absolute md:after:inset-x-0 md:after:bottom-0 md:after:h-px
            md:after:bg-black/15 md:dark:after:bg-white/15 md:after:pointer-events-none">
  <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto h-full p-4">
    <!-- Logo / Site Title -->
    <a href="{{ "/" | relURL }}" class="flex items-center space-x-3 rtl:space-x-reverse no-underline">
      {{ with $logoFile }}
        {{ $raw := strings.TrimPrefix "/" $.Site.Params.logo }}
  {{ $base := path.Base $raw }}
  {{ $ext  := path.Ext $base }}
  {{ $name := replace $base $ext "" }}
        {{ $avifRes := resources.Get (printf "media/%s.avif" $name) }}
        {{ $webpRes := resources.Get (printf "media/%s.webp" $name) }}
        {{ if or $avifRes $webpRes }}
          {{ $widthAttr := 0 }}
          {{ if gt (int $logoW) 0 }}
            {{ $widthAttr = int $logoW }}
          {{ else if gt (int $logoH) 0 }}
            {{ $widthAttr = int $logoH }}
          {{ end }}
          <picture>
            {{- with $avifRes -}}<source srcset="{{ .RelPermalink }}" type="image/avif" />{{- end -}}
            {{- with $webpRes -}}<source srcset="{{ .RelPermalink }}" type="image/webp" />{{- end -}}
            <img src="{{ . | relURL }}"
                 alt="{{ printf "%s logo" $.Site.Title }}"
                 class="{{ printf "%s w-auto flex-shrink-0" $logoHeightClass }}"
                 {{ if gt $widthAttr 0 }}width="{{ $widthAttr }}"{{ end }}
                 {{ with $logoH }}{{ if gt (int .) 0 }}height="{{ . }}"{{ end }}{{ end }}
                 loading="eager" fetchpriority="high" decoding="async" />
          </picture>
        {{ else }}
          {{ partial "optimized-logo.html" (dict
              "Site" $.Site
              "Logo" .
              "Class" (printf "%s w-auto flex-shrink-0" $logoHeightClass)
              "Alt" (printf "%s logo" $.Site.Title)
              "Width" $logoW
              "Height" $logoH
            ) }}
        {{ end }}
      {{ end }}
      {{/* --- Title size map (literal classes; no dynamic strings) --- */}}
      {{- $sizeOpt  := lower (or .Site.Params.header.titleSize "2xl") -}}
      {{- $sizeMap  := dict
            "sm"   "text-sm"
            "base" "text-base"
            "lg"   "text-lg"
            "xl"   "text-xl"
            "2xl"  "text-2xl"
            "3xl"  "text-3xl"
            "4xl"  "text-4xl"
        -}}
      {{- $titleSizeClass := index $sizeMap $sizeOpt | default "text-2xl" -}}

      {{/* Manual line break support from earlier (use "|" or newline in config) */}}
      {{- $rawTitle := or .Site.Params.header.title .Site.Title -}}
      {{- $titleHTML := replace (replace $rawTitle "|" "<br/>") (printf "\n") "<br/>" | safeHTML -}}

      <span class="self-center {{ $titleSizeClass }} font-semibold leading-tight whitespace-normal break-words">
        {{ $titleHTML }}
      </span>
    </a>

    <!-- Actions -->
    <div class="flex md:order-2 items-center space-x-3 md:space-x-0 rtl:space-x-reverse">
      {{ if or $showCTAOnMobile $showCTAOnDesktop }}
      <a href="{{ $CTAURL | relURL }}"
         class="no-underline font-medium rounded-lg text-sm px-4 py-2 focus:ring-4 focus:outline-none ui-btn
                {{ if $showCTAOnMobile }}inline-flex{{ else }}hidden{{ end }}
                {{ if $showCTAOnDesktop }} md:inline-flex{{ else }} md:hidden{{ end }}
                text-center {{ $ctaClasses }}">
        {{ $CTAText }}
      </a>
      {{ end }}

      {{ if and $showPhoneOnMobile (ne $phoneNumber "") }}
      <a href="tel:+1{{ replace $phoneNumber "-" "" }}"
         class="inline-flex md:hidden items-center justify-center p-2 text-lg
                focus:ring-2 focus:outline-none hover:bg-black/5 dark:hover:bg-white/10 no-underline"
         aria-label="Call us">
        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M18.427 14.768L17.2 13.542a1.733 1.733 0 0 0-2.45 0l-.613.613a1.732 1.732 0 0 1-2.45 0l-1.838-1.84a1.735 1.735 0 0 1 0-2.452l.612-.613a1.735 1.735 0 0 0 0-2.452L9.237 5.572a1.6 1.6 0 0 0-2.45 0c-3.223 3.2-1.702 6.896 1.519 10.117 3.22 3.221 6.914 4.745 10.12 1.535a1.601 1.601 0 0 0 0-2.456Z"/>
        </svg>
      </a>
      {{ end }}

      <button data-collapse-toggle="navbar-sticky" type="button"
              class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm rounded-lg md:hidden hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-black/10 dark:focus:ring-white/10 no-underline"
              aria-controls="navbar-sticky" aria-expanded="false">
        <span class="sr-only">Open main menu</span>
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M1 1h15M1 7h15M1 13h15"/>
        </svg>
      </button>
    </div>

    <!-- Menu -->
    <div id="navbar-sticky"
        class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1
                {{ if eq $headerTheme "glass" }}bg-white/80 dark:bg-gray-900/80 backdrop-blur
                {{ else if eq $headerTheme "invert" }}bg-white/95 dark:bg-gray-900/90
                {{ else }}{{ $navBg }}
                {{ end }}
                border-t border-black/10 dark:border-white/10 md:border-0
                md:bg-transparent md:dark:bg-transparent">

      <ul class="flex flex-col p-4 md:p-0 mt-4 font-medium rounded-lg md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0">
        {{ range .Site.Menus.main }}
          <li class="relative">
            {{ if .HasChildren }}
        <button id="menu-{{ .Identifier }}-button" type="button"
                      data-dropdown-toggle="menu-{{ .Identifier }}"
                      data-dropdown-placement="bottom-start"
          class="no-underline hover:underline brand-link text-white {{ $navHoverClasses }} flex items-center justify-between w-full py-2 px-3 md:border-0 md:p-0 md:w-auto">
                {{ .Name }}
                <svg class="w-2.5 h-2.5 ms-2.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                </svg>
              </button>

              <div id="menu-{{ .Identifier }}"
                   class="z-50 hidden md:absolute md:left-0 md:top-full md:mt-2 w-44 rounded-lg shadow-sm bg-white dark:bg-gray-800 md:dark:bg-gray-800 backdrop-blur">
                <ul class="py-2 text-sm">
                  {{ range .Children }}
                    <li>
                      <a href="{{ .URL | relURL }}" class="no-underline hover:underline brand-link block px-4 py-2 hover:bg-black/5 dark:hover:bg-white/10">
                        {{ .Name }}
                      </a>
                    </li>
                  {{ end }}
                </ul>
              </div>
            {{ else }}
          <a href="{{ .URL | relURL }}"
            class="no-underline hover:underline brand-link text-white {{ $navHoverClasses }} block py-2 px-3 rounded-sm md:border-0 md:p-0"
                 {{ if eq .URL $.Permalink }}aria-current="page"{{ end }}>
                {{ .Name }}
              </a>
            {{ end }}
          </li>
        {{ end }}
      </ul>
    </div>
  </div>
</nav>

<script>
  // Dynamically measure the sticky header height and expose it as a CSS var
  (function(){
    function setHeaderVar(){
      var nav = document.querySelector('nav');
      if (!nav) return;
      var h = Math.ceil(nav.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--site-header-h', h + 'px');
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setHeaderVar, { once:true });
    } else {
      setHeaderVar();
    }
    window.addEventListener('resize', setHeaderVar);
  })();
  </script>

